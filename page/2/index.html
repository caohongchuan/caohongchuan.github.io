<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"caohongchuan.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":"auto","version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
<meta property="og:type" content="website">
<meta property="og:title" content="yingzheng">
<meta property="og:url" content="http://caohongchuan.github.io/page/2/index.html">
<meta property="og:site_name" content="yingzheng">
<meta property="og:description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="YingZheng">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://caohongchuan.github.io/page/2/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>yingzheng</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">yingzheng</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="YingZheng"
      src="/images/photo.png">
  <p class="site-author-name" itemprop="name">YingZheng</p>
  <div class="site-description" itemprop="description">Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">34</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/caohongchuan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;caohongchuan" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yingzhengttt@gmail.com" title="E-Mail → mailto:yingzhengttt@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/04/04/interview/Spring%E9%9D%A2%E5%90%91%E5%88%87%E9%9D%A2%E7%BC%96%E7%A8%8BAOP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/04/interview/Spring%E9%9D%A2%E5%90%91%E5%88%87%E9%9D%A2%E7%BC%96%E7%A8%8BAOP/" class="post-title-link" itemprop="url">Spring面向切面编程(AOP)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-04 08:20:21" itemprop="dateCreated datePublished" datetime="2025-04-04T08:20:21+08:00">2025-04-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-04-05 13:44:28" itemprop="dateModified" datetime="2025-04-05T13:44:28+08:00">2025-04-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/interview/" itemprop="url" rel="index"><span itemprop="name">interview</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="面向切面编程-AOP-VS-面向对象编程（OOP）"><a href="#面向切面编程-AOP-VS-面向对象编程（OOP）" class="headerlink" title="面向切面编程(AOP) VS 面向对象编程（OOP）"></a>面向切面编程(AOP) VS 面向对象编程（OOP）</h1><blockquote>
<p>OOP面向对象编程，针对业务处理过程的实体及其属性和行为进行抽象封装，以获得更加清晰高效的逻辑单元划分。而AOP则是针对业务处理过程中的切面进行提取，它所面对的是处理过程的某个步骤或阶段，以获得逻辑过程的中各部分之间低耦合的隔离效果。</p>
<ul>
<li>OOP：从纵向解决代码重复问题</li>
<li>AOP：从横向解决代码重复问题，取代了传统从纵向继承体系重复代码（性能监控、事务管理、缓存，日志等）将业务逻辑与系统处理代码进行解耦。</li>
</ul>
</blockquote>
<p><img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250404085620522.png" alt="image-20250404085620522"></p>
<p>图左结构为正常AOP架构，日志处理会被加入到每一个方法中。图右结构为AOP架构，日志处理会被抽离出来，方法中不需要处理日志，会被AOP以切面的形式添加到每个方法开始之前。</p>
<ul>
<li><p><strong>连接点（Jointpoint）</strong>：表示需要在程序中插入横切关注点的扩展点，<strong>连接点可能是类初始化、方法执行、方法调用、字段调用或处理异常等等</strong>，<em>Spring只支持方法执行连接点</em>，在AOP中表示为<strong>在哪里干</strong>；</p>
</li>
<li><p><strong>切入点（Pointcut）</strong>： 选择一组相关连接点的模式，即可以认为连接点的集合，Spring支持perl5正则表达式和AspectJ切入点模式，Spring默认使用AspectJ语法，在AOP中表示为<strong>在哪里干的集合</strong>；</p>
</li>
<li><p><strong>通知（Advice）</strong>：在连接点上执行的行为，通知提供了在AOP中需要在切入点所选择的连接点处进行扩展现有行为的手段；包括前置通知（before advice）、后置通知(after advice)、环绕通知（around advice），在Spring中通过代理模式实现AOP，并通过拦截器模式以环绕连接点的拦截器链织入通知；在AOP中表示为<strong>干什么</strong>。</p>
</li>
<li><p><strong>切面（Aspect）</strong>：横切关注点的模块化，比如上边提到的日志组件。可以认为是通知和切入点的组合；在Spring中可以使用Schema和@AspectJ方式进行组织实现；在AOP中表示为<strong>在哪干和干什么集合</strong>。</p>
</li>
</ul>
<h1 id="Spring-AOP和AspectJ"><a href="#Spring-AOP和AspectJ" class="headerlink" title="Spring AOP和AspectJ"></a>Spring AOP和AspectJ</h1><blockquote>
<p>AspectJ是一个Java实现的AOP框架，它能够对Java代码进行AOP编译（一般在编译期进行），让Java代码具有AspectJ的AOP功能（需要特殊的编译器）</p>
</blockquote>
<blockquote>
<p>Spring 框架通过定义切面, 通过拦截切点实现了不同业务模块的解耦，这个就叫**面向切面编程 - Aspect Oriented Programming (AOP)**。</p>
<p>AOP的本质也是为了解耦，通过<strong>预编译方式</strong>和<strong>运行期间动态代理</strong>实现程序的统一维护的一种技术。</p>
</blockquote>
<p>区别：</p>
<ul>
<li><p>AspectJ是更强的AOP框架，是实际意义的<strong>AOP标准</strong>；</p>
</li>
<li><p>Spring AOP使用纯Java实现, 它不需要专门的编译过程, 它一个<strong>重要的原则就是无侵入性（non-invasiveness）</strong>。</p>
</li>
<li><p>Spring小组喜欢@AspectJ注解风格更胜于Spring XML配置，在Spring 2.0使用了和AspectJ 5一样的注解，并使用AspectJ来做切入点解析和匹配。<strong>但是，AOP在运行时仍旧是纯的Spring AOP，并不依赖于AspectJ的编译器或者织入器（weaver）</strong>。</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>Spring AOP</th>
<th>AspectJ</th>
</tr>
</thead>
<tbody><tr>
<td>在纯 Java 中实现</td>
<td>使用 Java 编程语言的扩展实现</td>
</tr>
<tr>
<td>不需要单独的编译过程</td>
<td>除非设置 LTW，否则需要 AspectJ 编译器 (ajc)</td>
</tr>
<tr>
<td>只能使用运行时织入</td>
<td>运行时织入不可用。支持编译时、编译后和加载时织入</td>
</tr>
<tr>
<td>功能不强-仅支持方法级编织</td>
<td>更强大 - 可以编织字段、方法、构造函数、静态初始值设定项、最终类&#x2F;方法等</td>
</tr>
<tr>
<td>只能在由 Spring 容器管理的 bean 上实现</td>
<td>可以在所有域对象上实现</td>
</tr>
<tr>
<td>仅支持方法执行切入点</td>
<td>支持所有切入点</td>
</tr>
<tr>
<td>代理是由目标对象创建的, 并且切面应用在这些代理上</td>
<td>在执行应用程序之前 (在运行时) 前, 各方面直接在代码中进行织入</td>
</tr>
<tr>
<td>比 AspectJ 慢多了</td>
<td>更好的性能</td>
</tr>
<tr>
<td>易于学习和应用</td>
<td>相对于 Spring AOP 来说更复杂</td>
</tr>
</tbody></table>
<p>织入器（weaver）：织入分为动态织入和静态织入，织入可以理解为将切面应用到目标函数中，即定义切面后，需要将切面织入到目标代码内。</p>
<ul>
<li><p><strong>动态织入</strong>的方式是在运行时动态将要增强的代码织入到目标类中，这样往往是通过动态代理技术完成的，如Java JDK的动态代理(Proxy，底层通过反射实现)或者CGLIB的动态代理(底层通过继承实现)，Spring AOP采用的就是基于运行时增强的代理技术</p>
</li>
<li><p>ApectJ采用的就是<strong>静态织入</strong>的方式。ApectJ主要采用的是编译期织入，在这个期间使用AspectJ的acj编译器(类似javac)把aspect类编译成class字节码后，在java目标类编译时织入，即先编译aspect类再编译目标类。</p>
</li>
</ul>
<h1 id="Spring-AOP"><a href="#Spring-AOP" class="headerlink" title="Spring AOP"></a>Spring AOP</h1><blockquote>
<p>Spring AOP 支持对XML模式和基于@AspectJ注解的两种配置方式。</p>
</blockquote>
<h2 id="XML模式"><a href="#XML模式" class="headerlink" title="XML模式"></a>XML模式</h2><p>定义业务实现类<code>xxxServiceImpl.java</code>，定义切面类<code>xxxAspect.java</code>，编写XML配置文件<code>xxx.xml</code>。将业务实现类和切面类注册为bean，然后配置切面（切面中包含切入点和通知类型）。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;tech.pdai.springframework&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 目标类 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- configure properties of bean here as normal --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 切面 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- configure properties of aspect here as normal --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置切面 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 配置切入点 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;pointCutMethod&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* xxx.service.*.*(..))&quot;</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 环绕通知 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:around</span> <span class="attr">method</span>=<span class="string">&quot;doAround&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointCutMethod&quot;</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 前置通知 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">&quot;doBefore&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointCutMethod&quot;</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 后置通知；returning属性：用于设置后置通知的第二个参数的名称，类型是Object --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:after-returning</span> <span class="attr">method</span>=<span class="string">&quot;doAfterReturning&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointCutMethod&quot;</span> <span class="attr">returning</span>=<span class="string">&quot;result&quot;</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 异常通知：如果没有异常，将不会执行增强；throwing属性：用于设置通知第二个参数的的名称、类型--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:after-throwing</span> <span class="attr">method</span>=<span class="string">&quot;doAfterThrowing&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointCutMethod&quot;</span> <span class="attr">throwing</span>=<span class="string">&quot;e&quot;</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 最终通知 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">&quot;doAfter&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointCutMethod&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Spring-AOP注解"><a href="#Spring-AOP注解" class="headerlink" title="Spring AOP注解"></a>Spring AOP注解</h2><table>
<thead>
<tr>
<th>注解名称</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>@Aspect</td>
<td>用来定义一个切面。</td>
</tr>
<tr>
<td>@pointcut</td>
<td>用于定义切入点表达式。在使用时还需要定义一个包含名字和任意参数的方法签名来表示切入点名称，这个方法签名就是一个返回值为void，且方法体为空的普通方法。</td>
</tr>
<tr>
<td>@Before</td>
<td>用于定义前置通知，相当于BeforeAdvice。在使用时，通常需要指定一个value属性值，该属性值用于指定一个切入点表达式(可以是已有的切入点，也可以直接定义切入点表达式)。</td>
</tr>
<tr>
<td>@AfterReturning</td>
<td>用于定义后置通知，相当于AfterReturningAdvice。在使用时可以指定pointcut &#x2F; value和returning属性，其中pointcut &#x2F; value这两个属性的作用一样，都用于指定切入点表达式。</td>
</tr>
<tr>
<td>@Around</td>
<td>用于定义环绕通知，相当于MethodInterceptor。在使用时需要指定一个value属性，该属性用于指定该通知被植入的切入点。</td>
</tr>
<tr>
<td>@After-Throwing</td>
<td>用于定义异常通知来处理程序中未处理的异常，相当于ThrowAdvice。在使用时可指定pointcut &#x2F; value和throwing属性。其中pointcut&#x2F;value用于指定切入点表达式，而throwing属性值用于指定-一个形参名来表示Advice方法中可定义与此同名的形参，该形参可用于访问目标方法抛出的异常。</td>
</tr>
<tr>
<td>@After</td>
<td>用于定义最终final 通知，不管是否异常，该通知都会执行。使用时需要指定一个value属性，该属性用于指定该通知被植入的切入点。</td>
</tr>
<tr>
<td>@DeclareParents</td>
<td>用于定义引介通知，相当于IntroductionInterceptor。</td>
</tr>
</tbody></table>
<h2 id="定义日志注解"><a href="#定义日志注解" class="headerlink" title="定义日志注解"></a>定义日志注解</h2><p>首先定义一个日志注解，该注解用来标记需要被切面处理的方法上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Loggable &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="定义切面"><a href="#定义切面" class="headerlink" title="定义切面"></a>定义切面</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoggingAspect</span> &#123;</span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(top.chc.aspectdemo.aspect.Loggable)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loggable</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;loggable()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeAdvice</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Before the method is called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<strong>切入点</strong>是注解<code>Loggable</code>，然后通过<code>@Before @After</code>等注解定义<strong>通知</strong>。</p>
<h2 id="放置注解"><a href="#放置注解" class="headerlink" title="放置注解"></a>放置注解</h2><p>将注解放置到业务代码中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> &#123;</span><br><span class="line">    <span class="meta">@Loggable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getUser</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;User name: %s\n&quot;</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方式是侵入式的，会在业务代码中添加了<code>@Loggable</code>注解。</p>
<p>可以在定义切面的时候，直接将切入点定义到具体的业务类方法上，而不是注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogAspect</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(LogAspect.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义切点（这里以controller包下的所有方法为例）</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.example.controller..*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logPointcut</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 前置通知：在方法执行前记录日志</span></span><br><span class="line">    <span class="meta">@Before(&quot;logPointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logBefore</span><span class="params">(JoinPoint joinPoint)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> joinPoint.getSignature().getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> joinPoint.getTarget().getClass().getSimpleName();</span><br><span class="line">        Object[] args = joinPoint.getArgs();</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;方法开始执行: &#123;&#125;.&#123;&#125;&quot;</span>, className, methodName);</span><br><span class="line">        logger.info(<span class="string">&quot;入参: &#123;&#125;&quot;</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 后置通知：在方法执行后记录日志</span></span><br><span class="line">    <span class="meta">@AfterReturning(pointcut = &quot;logPointcut()&quot;, returning = &quot;result&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logAfterReturning</span><span class="params">(JoinPoint joinPoint, Object result)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> joinPoint.getSignature().getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> joinPoint.getTarget().getClass().getSimpleName();</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;方法执行结束: &#123;&#125;.&#123;&#125;&quot;</span>, className, methodName);</span><br><span class="line">        logger.info(<span class="string">&quot;返回结果: &#123;&#125;&quot;</span>, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异常通知：在方法抛出异常时记录日志</span></span><br><span class="line">    <span class="meta">@AfterThrowing(pointcut = &quot;logPointcut()&quot;, throwing = &quot;exception&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logAfterThrowing</span><span class="params">(JoinPoint joinPoint, Throwable exception)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> joinPoint.getSignature().getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> joinPoint.getTarget().getClass().getSimpleName();</span><br><span class="line">        </span><br><span class="line">        logger.error(<span class="string">&quot;方法执行异常: &#123;&#125;.&#123;&#125;&quot;</span>, className, methodName);</span><br><span class="line">        logger.error(<span class="string">&quot;异常信息: &quot;</span>, exception);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 环绕通知：可以控制方法执行的整个过程</span></span><br><span class="line">    <span class="meta">@Around(&quot;logPointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">logAround</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行目标方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> joinPoint.proceed();</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">timeCost</span> <span class="operator">=</span> System.currentTimeMillis() - startTime;</span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> joinPoint.getSignature().getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> joinPoint.getTarget().getClass().getSimpleName();</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;方法: &#123;&#125;.&#123;&#125; 执行耗时: &#123;&#125;ms&quot;</span>, className, methodName, timeCost);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Pointcut</code>：定义切入点，可以使用不同的表达式</p>
<ul>
<li><code>execution(* com.example..*.*(..))</code>：匹配指定包下的所有方法</li>
<li><code>within(com.example.controller.*)</code>：匹配指定包下的所有类</li>
<li><code>@annotation(com.example.annotation.Log)</code>：匹配带有特定注解的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 任意公共方法的执行：</span></span><br><span class="line">execution（<span class="keyword">public</span> * *（..））</span><br><span class="line"></span><br><span class="line"><span class="comment">// 任何一个名字以“set”开始的方法的执行：</span></span><br><span class="line">execution（* set*（..））</span><br><span class="line"></span><br><span class="line"><span class="comment">// AccountService接口定义的任意方法的执行：</span></span><br><span class="line">execution（* com.xyz.service.AccountService.*（..））</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在service包中定义的任意方法的执行：</span></span><br><span class="line">execution（* com.xyz.service.*.*（..））</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在service包或其子包中定义的任意方法的执行：</span></span><br><span class="line">execution（* com.xyz.service..*.*（..））</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在service包中的任意连接点（在Spring AOP中只是方法执行）：</span></span><br><span class="line">within（com.xyz.service.*）</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在service包或其子包中的任意连接点（在Spring AOP中只是方法执行）：</span></span><br><span class="line">within（com.xyz.service..*）</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现了AccountService接口的代理对象的任意连接点 （在Spring AOP中只是方法执行）：</span></span><br><span class="line"><span class="built_in">this</span>（com.xyz.service.AccountService）<span class="comment">// &#x27;this&#x27;在绑定表单中更加常用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现AccountService接口的目标对象的任意连接点 （在Spring AOP中只是方法执行）：</span></span><br><span class="line">target（com.xyz.service.AccountService） <span class="comment">// &#x27;target&#x27;在绑定表单中更加常用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 任何一个只接受一个参数，并且运行时所传入的参数是Serializable 接口的连接点（在Spring AOP中只是方法执行）</span></span><br><span class="line">args（java.io.Serializable） <span class="comment">// &#x27;args&#x27;在绑定表单中更加常用; 请注意在例子中给出的切入点不同于 execution(* *(java.io.Serializable))： args版本只有在动态运行时候传入参数是Serializable时才匹配，而execution版本在方法签名中声明只有一个 Serializable类型的参数时候匹配。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 目标对象中有一个 @Transactional 注解的任意连接点 （在Spring AOP中只是方法执行）</span></span><br><span class="line"><span class="meta">@target</span>（org.springframework.transaction.annotation.Transactional）<span class="comment">// &#x27;@target&#x27;在绑定表单中更加常用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 任何一个目标对象声明的类型有一个 @Transactional 注解的连接点 （在Spring AOP中只是方法执行）：</span></span><br><span class="line"><span class="meta">@within</span>（org.springframework.transaction.annotation.Transactional） <span class="comment">// &#x27;@within&#x27;在绑定表单中更加常用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 任何一个执行的方法有一个 @Transactional 注解的连接点 （在Spring AOP中只是方法执行）</span></span><br><span class="line"><span class="meta">@annotation</span>（org.springframework.transaction.annotation.Transactional） <span class="comment">// &#x27;@annotation&#x27;在绑定表单中更加常用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 任何一个只接受一个参数，并且运行时所传入的参数类型具有@Classified 注解的连接点（在Spring AOP中只是方法执行）</span></span><br><span class="line"><span class="meta">@args</span>（com.xyz.security.Classified） <span class="comment">// &#x27;@args&#x27;在绑定表单中更加常用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 任何一个在名为&#x27;tradeService&#x27;的Spring bean之上的连接点 （在Spring AOP中只是方法执行）</span></span><br><span class="line">bean（tradeService）</span><br><span class="line"></span><br><span class="line"><span class="comment">// 任何一个在名字匹配通配符表达式&#x27;*Service&#x27;的Spring bean之上的连接点 （在Spring AOP中只是方法执行）</span></span><br><span class="line">bean（*Service）</span><br><span class="line">    </span><br><span class="line"><span class="comment">// &amp;&amp;：要求连接点同时匹配两个切入点表达式</span></span><br><span class="line"><span class="comment">// ||：要求连接点匹配任意个切入点表达式</span></span><br><span class="line"><span class="comment">// !:：要求连接点不匹配指定的切入点表达式</span></span><br></pre></td></tr></table></figure>

<p>总结：</p>
<ul>
<li>Spring AOP比完全使用AspectJ更加简单， 因为它不需要引入AspectJ的编译器&#x2F;织入器到你开发和构建过程中。 如果你<strong>仅仅需要在Spring bean上通知执行操作，那么Spring AOP是合适的选择</strong>。</li>
<li>如果你需要通知domain对象或其它没有在Spring容器中管理的任意对象，那么你需要使用AspectJ。</li>
<li>如果你想通知除了简单的方法执行之外的连接点（调用连接点、字段get或set的连接点等等）， 也需要使用AspectJ。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/04/02/cf/%E6%A0%91%E7%BB%93%E6%9E%84/%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/02/cf/%E6%A0%91%E7%BB%93%E6%9E%84/%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91/" class="post-title-link" itemprop="url">二叉搜索树</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-02 16:35:56" itemprop="dateCreated datePublished" datetime="2025-04-02T16:35:56+08:00">2025-04-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-05-12 18:44:31" itemprop="dateModified" datetime="2025-05-12T18:44:31+08:00">2025-05-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/data-structure/" itemprop="url" rel="index"><span itemprop="name">data_structure</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>[TOC]</p>
<h1 id="红黑树"><a href="#红黑树" class="headerlink" title="红黑树"></a>红黑树</h1><blockquote>
<p>红黑树的定义：</p>
<ul>
<li>每个节点为红色或黑色。</li>
<li>根节点始终为黑色。</li>
<li>红色节点的子节点必须为黑色（无连续红色节点）。</li>
<li>从根到每个叶节点（NIL节点）的黑色节点数量（黑色高度）相等。</li>
<li>所有叶节点（NIL节点）为黑色。</li>
</ul>
</blockquote>
<p>通过红黑树的定义，可确保<strong>其没有一条路径长度能够超出其他路径的2倍</strong>。 通过下图可知，因为需要保证<strong>从根到每个叶节点的黑色节点数量（黑色高度）相等，</strong>所以左侧为<code>black -&gt; red -&gt; black -&gt; red -&gt; black -&gt; null</code> 右侧为<code>black -&gt; black -&gt; black -&gt; null</code>从根节点到NIL节点（图中标为NULL）都只有三个，两者高度相差相差是小于2倍的。</p>
<p><img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250508203425141.png" alt="image-20250508203425141"></p>
<p>红黑树控制了最长路径和最短路径之比，间接地使红黑树达到了“近似平衡”，增删查改地时间消耗不会过大，并且相比AVL树，旋转调整次数会更少。</p>
<h2 id="红黑树节点的数据结构"><a href="#红黑树节点的数据结构" class="headerlink" title="红黑树节点的数据结构"></a>红黑树节点的数据结构</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RBNode</span>&lt;K <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;K&gt;, V&gt; &#123;</span><br><span class="line">    K key;</span><br><span class="line">    V value;</span><br><span class="line">    RBNode&lt;K, V&gt; parent, leftChild, rightChild;</span><br><span class="line">    <span class="type">boolean</span> isRed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RBNode</span><span class="params">(K key, V value, RBNode&lt;K, V&gt; leftChild, RBNode&lt;K, V&gt; rightChild, RBNode&lt;K, V&gt; parent, <span class="type">boolean</span> isRed)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">        <span class="built_in">this</span>.leftChild = leftChild;</span><br><span class="line">        <span class="built_in">this</span>.rightChild = rightChild;</span><br><span class="line">        <span class="built_in">this</span>.parent = parent;</span><br><span class="line">        <span class="built_in">this</span>.isRed = isRed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="红黑树的插入"><a href="#红黑树的插入" class="headerlink" title="红黑树的插入"></a>红黑树的插入</h2><p>为了不影响红黑树中黑色数量的平衡，<strong>将插入的节点默认设置为红色</strong>，但插入红色后会出现<strong>双红</strong>的情况，需进行调整。</p>
<h3 id="情况1：root是空"><a href="#情况1：root是空" class="headerlink" title="情况1：root是空"></a><strong>情况1：root是空</strong></h3><p>直接插入到root并设置为黑色</p>
<h3 id="情况2：root不为空"><a href="#情况2：root不为空" class="headerlink" title="情况2：root不为空"></a><strong>情况2：root不为空</strong></h3><p>根据二叉树找到需要插入的位置，即某个叶子节点(NIL)并记录它的父节点(p)</p>
<h4 id="情况2-1：父节点-p-为黑色"><a href="#情况2-1：父节点-p-为黑色" class="headerlink" title="情况2.1：父节点(p)为黑色"></a><strong>情况2.1：父节点(p)为黑色</strong></h4><p>直接在该叶子节点(NIL)插入并设置为红色</p>
<h4 id="情况2-1：父节点-p-为红色"><a href="#情况2-1：父节点-p-为红色" class="headerlink" title="情况2.1：父节点(p)为红色"></a><strong>情况2.1：父节点(p)为红色</strong></h4><p>若加入红色的插入节点，会出现双红的情况。</p>
<h5 id="情况2-1-1：父节点-p-的兄弟节点-u-为黑色或-NIL"><a href="#情况2-1-1：父节点-p-的兄弟节点-u-为黑色或-NIL" class="headerlink" title="情况2.1.1：父节点(p)的兄弟节点(u)为黑色或(NIL)"></a><strong>情况2.1.1：父节点(p)的兄弟节点(u)为黑色或(NIL)</strong></h5><p>父节点(p)的兄弟节点(u)也就是插入节点(cur)的叔叔节点。该情况共有四种情况：</p>
<ul>
<li>(p)是(g)的左儿子，(cur)是(p)的左儿子，执行LL情况</li>
<li>(p)是(g)的左儿子，(cur)是(p)的右儿子，执行LR情况</li>
<li>(p)是(g)的右儿子，(cur)是(p)的左儿子，执行RL情况</li>
<li>(p)是(g)的右儿子，(cur)是(p)的右儿子，执行RR情况</li>
</ul>
<p><strong>LL情况：</strong></p>
<p>算法：</p>
<ol>
<li>对(p)节点右旋</li>
<li>重新着色： (p)设置为黑色，(g)设置为红色</li>
<li>结束</li>
</ol>
<p><em>分析（其他情况类推）：</em></p>
<p>若下图是红黑树的最底层叶子节点，则(curl) &#x3D; NIL, (curr) &#x3D; NIL, (pr) &#x3D; NIL, (u) &#x3D; NIL。所以旋转结束后，以(p)为根节点的子树黑色平衡且高度为一 没有发生变化。</p>
<p>若下图是递归迭代过程中，并假设(u)存在，如果不存在就变为上面红黑树的最底层的情况一致了。那么(g)的右子树黑色高度为 [1 + (u)子树黑色高度] 为保持平衡，(pr)中黑色节点的高度为 [1 + (u)子树黑色高度]也就是至少有一个黑色节点，(curl)与(curr)跟(pr)是一样的。在旋转后，(curl)(curr)(pr)的黑色高度都为 [1 + (u)子树黑色高度]，(g)的右子树黑色高度也是 [1 + (u)子树黑色高度] 所以旋转后黑色仍然平衡且没有发生变化。</p>
<p>无论是红黑树的最底层叶子节点还是递归迭代过程中，旋转变色之后黑色都是平衡且高度不变的，并且子树的根节点为黑色不变。故不需要向上调整。</p>
<p><strong>LR情况：</strong></p>
<p>算法：</p>
<ol>
<li>对(cur)节点左旋</li>
<li>变为<strong>LL情况</strong>，按照LL情况执行后续操作</li>
</ol>
<p><strong>RR情况：</strong></p>
<p>算法：</p>
<ol>
<li>对(p)节点左旋</li>
<li>重新着色： (p)设置为黑色，(g)设置为红色</li>
<li>结束</li>
</ol>
<p><strong>RL情况：</strong></p>
<p>算法：</p>
<ol>
<li>对(cur)节点右旋</li>
<li>变为<strong>RR情况</strong>，按照RR情况执行后续操作</li>
</ol>
<p><img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250512173800440.png" alt="image-20250512173800440"></p>
<h5 id="情况2-1-2：父节点-p-的兄弟节点-u-为红色"><a href="#情况2-1-2：父节点-p-的兄弟节点-u-为红色" class="headerlink" title="情况2.1.2：父节点(p)的兄弟节点(u)为红色"></a><strong>情况2.1.2：父节点(p)的兄弟节点(u)为红色</strong></h5><p>算法：</p>
<ol>
<li>重新着色：(p)设置为黑色，(u)设置为黑色，(g)设置为红色</li>
<li>将(g)看作新插入的红色节点，向上递归迭代。一直迭代到根节点即(g)为root，将(g)改为黑色，直接结束。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250512183009307.png" alt="image-20250512183009307"></p>
<h2 id="红黑树的删除"><a href="#红黑树的删除" class="headerlink" title="红黑树的删除"></a>红黑树的删除</h2><p>首先要明确几个概念：</p>
<p>1.<strong>约定(NIL)是黑色，也可以作为实际节点的儿子。</strong></p>
<p>旋转操作 包括<strong>左旋</strong>和<strong>右旋</strong></p>
<p>2.<strong>左旋</strong>：</p>
<p>本文以(cur)为基点进行旋转（有些文章是以(p)为基点）</p>
<p>算法：</p>
<ol>
<li>记录节点(p)的父节点(g)（如果有），图中并为标出</li>
<li>将节点(curl)移至节点(p)的右儿子</li>
<li>将节点(p)移至节点(cur)的左儿子</li>
<li>将节点(cur)移至节点(g)的儿子指向，（如果节点(p)有父节点(g)）</li>
</ol>
<p><img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250511120425567.png" alt="image-20250511120425567"></p>
<p>3.<strong>右旋：</strong></p>
<p>本文以(cur)为基点进行旋转（有些文章是以(p)为基点）</p>
<p>算法：</p>
<ol>
<li>记录节点(p)的父节点(g)（如果有），图中并为标出</li>
<li>将节点(curr)移至节点(p)的左儿子</li>
<li>将节点(p)移至节点(cur)的右儿子</li>
<li>将节点(cur)移至节点(g)的儿子指向，（如果节点(p)有父节点(g)）</li>
</ol>
<p><img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250511120419480.png" alt="image-20250511120419480"></p>
<p>4.<strong>删除节点</strong></p>
<p>针对删除操作，不同的文章有不同的标准，有<strong>直接删除节点</strong>的，有定义<strong>双黑节点</strong>的。本文会结合两者。</p>
<p>为了更直观的观察节点的删除情况，本文以直接删除节点的情况来绘图，但删除过程中有一种情况需要递归向上的平衡子树，所以在递归的情况下，使用双黑节点。无论使用直接删除节点还是双黑节点，两者的原理是相同的。</p>
<p><em>代码实现中：在寻找到删除节点后（该节点是经过移动后最终的删除节点没有儿子的情况）便立刻用(NIL)替代删除节点，后续判断过程中无论是最底层节点的直接删除，还是递归向上平衡子树都不需要再次删除了，即相当于使用的是双黑节点的思路，即双黑节点的内容是删除后的最后结果，不需要再操作了，只需要平衡该节点即可。</em></p>
<p>下图中要删除的节点是(cur)：</p>
<ul>
<li>若(cur)没有子节点则它的两个儿子都是NIL节点，删除后需要用(NIL)替代。右上子树是其双黑节点的表示形式</li>
<li>若(cur)有子节点，这种情况只出现在<strong>递归向上平衡子树</strong>的情况中，该情况在图中用<strong>双黑节点</strong>表示，但是旋转变色过程与<strong>直接删除节点</strong>的情况是一样的。右下子树是其双黑节点的表现形式。</li>
</ul>
<p>这三种表现形式都是一样的，都是以(cur)节点为根的子树内部的不同表现形式，并不会影响到(p)以及上面的节点。</p>
<p><img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250511141844943.png" alt="image-20250511141844943"></p>
<p><strong>5.图标</strong></p>
<p>黑圆代表黑色节点，红圆代表红色节点，虚线圆代表红或者黑节点。</p>
<p>双圆代表双黑节点</p>
<p>黑方形代表根是黑色的子树，红方形代表根是红色的子树，虚线方形代表根是黑色或者红色的子树。其中子树可能是(NIL)，可能只有一个节点，也可能有多层。</p>
<p><strong>删除原理：</strong> 首先通过二叉树搜索找到需要删除的节点(cur)，若节点为红色用其某个儿子节点替代即可。若节点为黑色，删除该节点会导致黑色节点数量减一，导致黑色节点数量不再平衡，为了保证删除后仍然黑色平衡，需要借用一个红色节点转移到该子树上变为黑色，这样该子树的黑色节点数量和删除之前是一样的，根据不同的情况，该红色节点可以从<strong>删除节点(cur)的孩子</strong>上，<strong>兄弟节点(b)的子树</strong>上、<strong>父节点(p)以其上面祖辈</strong>这三个地方借用红色。</p>
<p><em>注：其中双黑节点就是删除原节点后黑色高度减一的子树的根，等借一个红节点变为黑色后黑色高度平衡，即可将该双黑节点改为单黑节点（即正常黑色节点）</em></p>
<p>首先通过二叉树搜索找到需要删除的节点(cur)，根据(cur)的孩子节点情况分类：</p>
<ul>
<li>(cur)有两个儿子节点</li>
<li>(cur)有一个儿子节点</li>
<li>(cur)没有儿子节点</li>
</ul>
<h3 id="情况1：-cur-有两个儿子节点"><a href="#情况1：-cur-有两个儿子节点" class="headerlink" title="情况1：(cur)有两个儿子节点"></a><strong>情况1：(cur)有两个儿子节点</strong></h3><p>找到(cur)节点的<strong>前驱节点</strong>或<strong>后继节点</strong>来替代(cur)节点，替代后颜色设置为(cur)节点的颜色，然后继续删除该<strong>前驱节点</strong>或<strong>后继节点</strong>。本文采用后继节点来替代删除节点(cur)</p>
<h3 id="情况2：-cur-有一个儿子节点"><a href="#情况2：-cur-有一个儿子节点" class="headerlink" title="情况2：(cur)有一个儿子节点"></a><strong>情况2：(cur)有一个儿子节点</strong></h3><p>(cur)有一个儿子节点有两种可能：</p>
<h4 id="情况2-1：-cur-是红色-（不存在）"><a href="#情况2-1：-cur-是红色-（不存在）" class="headerlink" title="情况2.1：(cur)是红色 （不存在）"></a><strong>情况2.1：(cur)是红色 （不存在）</strong></h4><p>当(cur)是红色且它有一个儿子节点。若儿子节点是黑色，则黑色数量不平衡；若儿子节点是红色，则两个红色不能为父子。所以该情况不存在。</p>
<h4 id="情况2-2：-cur-是黑色"><a href="#情况2-2：-cur-是黑色" class="headerlink" title="情况2.2：(cur)是黑色"></a><strong>情况2.2：(cur)是黑色</strong></h4><p>当(cur)是黑色且它有一个儿子节点。若儿子节点是黑色，则黑色数量不平衡；若儿子节点是红色，成立。</p>
<p>该情况只有(cur)是黑色，(cur)的一个儿子是红色。因为自己的儿子就是红色，可以像自己的儿子借红色节点。</p>
<p>算法：</p>
<ol>
<li>将(cur)节点的<strong>红色儿子</strong>替代(cur)节点。即(p)节点的儿子换为(cur)节点的<strong>红色儿子</strong>（如果(p)存在）</li>
<li>将(cur)节点红色儿子的颜色改为(cur)的颜色，即黑色</li>
</ol>
<p><img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250511164052174.png" alt="image-20250511164052174"></p>
<h3 id="情况3：-cur-没有儿子节点"><a href="#情况3：-cur-没有儿子节点" class="headerlink" title="情况3：(cur)没有儿子节点"></a><strong>情况3：(cur)没有儿子节点</strong></h3><p>(cur)没有儿子节点分为两种情况：</p>
<h4 id="情况3-1：-cur-是红色"><a href="#情况3-1：-cur-是红色" class="headerlink" title="情况3.1：(cur)是红色"></a><strong>情况3.1：(cur)是红色</strong></h4><p>(cur)是红色且没有儿子节点，直接删除该节点用(NIL)替代即可。因为删除红色节点并不会影响黑色平衡。</p>
<p>算法：</p>
<ol>
<li>用(NIL)节点替代(cur)节点，即(p)节点的儿子换为(cur)节点的(NIL)节点（如果(p)存在）</li>
</ol>
<img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250511170746244.png" alt="image-20250511170746244" style="zoom:80%;" />

<h4 id="情况3-2：-cur-是黑色"><a href="#情况3-2：-cur-是黑色" class="headerlink" title="情况3.2：(cur)是黑色"></a><strong>情况3.2：(cur)是黑色</strong></h4><p>(cur)是黑色，删除后会导致(cur)锁在的原子树黑色高度减一，所以需要借红色节点变为黑色来补齐黑色高度，而(cur)没有孩子节点，此时需要向兄弟节点或者父亲节点来借。</p>
<h5 id="情况3-2-1：-cur-的兄弟节点-b-是黑色，且-b-的外节点儿子是红色"><a href="#情况3-2-1：-cur-的兄弟节点-b-是黑色，且-b-的外节点儿子是红色" class="headerlink" title="情况3.2.1：(cur)的兄弟节点(b)是黑色，且(b)的外节点儿子是红色"></a><strong>情况3.2.1：(cur)的兄弟节点(b)是黑色，且(b)的外节点儿子是红色</strong></h5><p><strong>当(cur)是(p)的左儿子，(b)为(p)的右儿子</strong></p>
<p>算法：</p>
<ol>
<li>对兄弟节点(b)左旋</li>
<li>重新着色：(br)设置为黑色，(b)设置为(p)的颜色，(p)设置为黑色</li>
<li>删除(cur)节点，用(NIL)替代；若是递归过程中，(cur)节点已经替代过了，不需要操作，以双黑的话术是一开始即用 <strong>(NIL)</strong> 或 <strong>(cur)自身</strong> 替代(cur)形成双黑节点，此时将双黑节点变为单黑（即正常的黑色节点）</li>
</ol>
<p>完成操作后，以(b)为根节点的子树黑色平衡且高度与原来一致，结束平衡过程。</p>
<p><img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250511184757521.png" alt="image-20250511184757521"></p>
<p><strong>当(cur)是(p)的右儿子，(b)为(p)的左儿子</strong></p>
<p>算法：</p>
<ol>
<li>对兄弟节点(b)右旋转</li>
<li>重新着色：(bl)设置为黑色，(b)设置为(p)的颜色，(p)设置为黑色</li>
<li>删除(cur)节点，用(NIL)替代；若是递归过程中，(cur)节点已经替代过了，不需要操作，以双黑的话术是一开始即用**(NIL)<strong>或</strong>(cur)自身**替代(cur)形成双黑节点，此时将双黑节点变为单黑（即正常的黑色节点）</li>
</ol>
<p>完成操作后，以(b)为根节点的子树<strong>黑色平衡</strong>且<strong>黑色高度与原来一致</strong>且**(b)的颜色与原来根节点(p)颜色相同**，结束平衡过程。</p>
<p><img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250511184808148.png" alt="image-20250511184808148"></p>
<h5 id="情况3-2-2：-cur-的兄弟节点-b-是黑色，且-b-的内节点儿子是红色（其外节点儿子是黑色）"><a href="#情况3-2-2：-cur-的兄弟节点-b-是黑色，且-b-的内节点儿子是红色（其外节点儿子是黑色）" class="headerlink" title="情况3.2.2：(cur)的兄弟节点(b)是黑色，且(b)的内节点儿子是红色（其外节点儿子是黑色）"></a><strong>情况3.2.2：(cur)的兄弟节点(b)是黑色，且(b)的内节点儿子是红色（其外节点儿子是黑色）</strong></h5><p><strong>当(cur)是(p)的左儿子，(b)为(p)的右儿子</strong></p>
<p>算法：</p>
<ol>
<li>对(bl)节点进行右旋</li>
<li>再对(bl)节点进行左旋</li>
<li>重新着色：(bl)设置为(p)的颜色，(p)设置为黑色</li>
<li>删除(cur)节点，用(NIL)替代；若是递归过程中，(cur)节点已经替代过了，不需要操作，以双黑的话术是一开始即用**(NIL)<strong>或</strong>(cur)自身**替代(cur)形成双黑节点，此时将双黑节点变为单黑（即正常的黑色节点）</li>
</ol>
<p>完成操作后，以(bl)为根节点的子树<strong>黑色平衡</strong>且<strong>黑色高度与原来一致</strong>且**(bl)的颜色与原来根节点(p)颜色相同**，结束平衡过程。</p>
<p><img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250511202439661.png" alt="image-20250511202439661"></p>
<p><strong>当(cur)是(p)的右儿子，(b)为(p)的左儿子</strong></p>
<p>算法：</p>
<ol>
<li>对(br)节点进行左旋</li>
<li>再对(br)节点进行右旋</li>
<li>重新着色：(br)设置为(p)的颜色，(p)设置为黑色</li>
<li>删除(cur)节点，用(NIL)替代；若是递归过程中，(cur)节点已经替代过了，不需要操作，以双黑的话术是一开始即用**(NIL)<strong>或</strong>(cur)自身**替代(cur)形成双黑节点，此时将双黑节点变为单黑（即正常的黑色节点）</li>
</ol>
<p>完成操作后，以(br)为根节点的子树<strong>黑色平衡</strong>且<strong>黑色高度与原来一致</strong>且**(br)的颜色与原来根节点(p)颜色相同**，结束平衡过程。</p>
<p><img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250511202455584.png" alt="image-20250511202455584"></p>
<h5 id="情况3-2-3：-cur-的兄弟节点-b-是黑色，且-b-的两个儿子都是黑色"><a href="#情况3-2-3：-cur-的兄弟节点-b-是黑色，且-b-的两个儿子都是黑色" class="headerlink" title="情况3.2.3：(cur)的兄弟节点(b)是黑色，且(b)的两个儿子都是黑色"></a><strong>情况3.2.3：(cur)的兄弟节点(b)是黑色，且(b)的两个儿子都是黑色</strong></h5><p>该情况下，(b) (bl) (br) (cur)均为黑色</p>
<h6 id="情况3-2-3-1-父节点-p-为红色"><a href="#情况3-2-3-1-父节点-p-为红色" class="headerlink" title="情况3.2.3.1: 父节点(p)为红色"></a><strong>情况3.2.3.1: 父节点(p)为红色</strong></h6><p>算法：</p>
<ol>
<li>重新着色：(p)设置为黑色，(b)设置为红色</li>
<li>删除(cur)节点，用(NIL)替代；若是递归过程中，(cur)节点已经替代过了，不需要操作，以双黑的话术是一开始即用**(NIL)<strong>或</strong>(cur)自身**替代(cur)形成双黑节点，此时将双黑节点变为单黑（即正常的黑色节点）</li>
</ol>
<p><img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250511205342926.png" alt="image-20250511205342926"></p>
<p>完成操作后，以(p)为根节点的子树<strong>黑色平衡</strong>且<strong>黑色高度与原来一致</strong>且(p)为黑色不会与其父节点冲突，结束平衡过程。</p>
<h6 id="情况3-2-3-2-父节点-p-为黑色"><a href="#情况3-2-3-2-父节点-p-为黑色" class="headerlink" title="情况3.2.3.2: 父节点(p)为黑色"></a><strong>情况3.2.3.2: 父节点(p)为黑色</strong></h6><p>算法：</p>
<ol>
<li>重新着色：(b)设置为红色</li>
<li>删除(cur)节点，用(NIL)替代；若是递归过程中，(cur)节点已经替代过了，不需要操作，以双黑的话术是一开始即用**(NIL)<strong>或</strong>(cur)自身**替代(cur)形成双黑节点，此时将双黑节点变为单黑（即正常的黑色节点）</li>
<li>将(p)设为双黑节点，递归向上继续平衡(p)，向上平衡过程中需要以下图规定的顺序进行判断，若都不满足需要将(p)的父节点设为双黑，继续向上平衡。若(b)为根节点，即(p)为NULL，终止递归。</li>
</ol>
<p>完成操作后，以(p)为根节点的子树<strong>黑色平衡</strong> 但 <strong>黑色高度减少了一</strong>，所以需要继续向上平衡(p)节点。此时可以将以(p)为根节点的子树看作一个整体，在以(pp)为根节点的子树中平衡，如果以(pp)为根节点的子树仍然不能平衡，就继续向上迭代，直至整棵树的根节点结束。</p>
<p><strong>递归判断顺序：</strong></p>
<ol>
<li>(bb)为黑色且(bbr)为红色</li>
<li>(bb)为黑色且(bbl)为红色</li>
<li>(bb)为红色</li>
<li>(bb)为黑色且(bbl)和(bbr)均为黑色且(pp)为红色</li>
</ol>
<p>若上述条件都不满足即出现了**(bb)为黑色且(bbl)和(bbr)均为黑色且(pp)为黑色**，这时需要继续平衡(pp)节点，即将(pp)设置为双黑节点，继续向上递归。一直递归到(pp)节点为NULL</p>
<p><img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250511211440827.png" alt="image-20250511211440827"></p>
<h5 id="情况3-2-4：-cur-的兄弟节点-b-是红色"><a href="#情况3-2-4：-cur-的兄弟节点-b-是红色" class="headerlink" title="情况3.2.4：(cur)的兄弟节点(b)是红色"></a><strong>情况3.2.4：(cur)的兄弟节点(b)是红色</strong></h5><p>该情况下(p)一定是黑色，(bl)和(br)一定是黑色</p>
<p><strong>当(cur)是(p)的左儿子，(b)为(p)的右儿子</strong></p>
<p>算法：</p>
<ol>
<li>对(b)进行左旋</li>
<li>重新着色：(b)设置为黑色，(p)设置为红色</li>
<li>平衡以(p)为根节点的子树，继续平衡(cur)，此时变为了兄弟节点是黑色的情况。平衡结束即全部结束</li>
</ol>
<p>在以(p)为根节点的子树中，可能出现三种情况：</p>
<ul>
<li>(blr)是红色，执行<strong>情况3.2.1：(cur)的兄弟节点(b)是黑色，且(b)的外节点儿子是红色</strong></li>
<li>(bll)是红色且(blr)是黑色，执行<strong>情况3.2.2：(cur)的兄弟节点(b)是黑色，且(b)的内节点儿子是红色（其外节点儿子是黑色）</strong></li>
<li>(bll)是黑色且(blr)是黑色，执行<strong>情况3.2.3：(cur)的兄弟节点(b)是黑色，且(b)的儿子都是黑色）</strong> 中 <strong>(p)为红色</strong> 的情况</li>
</ul>
<p>这三种情况都是可以完成平衡的，不需要递归。</p>
<p><img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250511231147168.png" alt="image-20250511231147168"></p>
<p><strong>当(cur)是(p)的右儿子，(b)为(p)的左儿子</strong></p>
<p>算法：</p>
<ol>
<li>对(b)进行右旋</li>
<li>重新着色：(b)设置为黑色，(p)设置为红色</li>
<li>平衡以(p)为根节点的子树，继续平衡(cur)，此时变为了兄弟节点是黑色的情况。平衡结束即全部结束</li>
</ol>
<p>在以(p)为根节点的子树中，可能出现三种情况：</p>
<ul>
<li>(brl)是红色，执行<strong>情况3.2.1：(cur)的兄弟节点(b)是黑色，且(b)的外节点儿子是红色</strong></li>
<li>(brr)是红色且(brl)是黑色，执行<strong>情况3.2.2：(cur)的兄弟节点(b)是黑色，且(b)的内节点儿子是红色（其外节点儿子是黑色）</strong></li>
<li>(brl)是黑色且(brr)是黑色，执行<strong>情况3.2.3：(cur)的兄弟节点(b)是黑色，且(b)的儿子都是黑色）</strong> 中 <strong>(p)为红色</strong> 的情况</li>
</ul>
<p>这三种情况都是可以完成平衡的，不需要递归。</p>
<p><img src="https://raw.githubusercontent.com/caohongchuan/blogimg/main/nextimg/image-20250511231157008.png" alt="image-20250511231157008"></p>
<h5 id="情况3-2-5：-cur-的兄弟节点-b-是-NIL-（不存在）"><a href="#情况3-2-5：-cur-的兄弟节点-b-是-NIL-（不存在）" class="headerlink" title="情况3.2.5：(cur)的兄弟节点(b)是(NIL) （不存在）"></a><strong>情况3.2.5：(cur)的兄弟节点(b)是(NIL) （不存在）</strong></h5><p>因为(cur)是黑色，若兄弟节点(b)是(NIL)，则黑色数量不平衡，不存在。</p>
<hr>
<h3 id="删除总结"><a href="#删除总结" class="headerlink" title="删除总结"></a>删除总结</h3><p>至此所有的删除情况都讨论完了。目前规定一下在代码中的<strong>情况3.2：(cur)没有子节点是黑色</strong>的判断顺序：</p>
<ol>
<li><strong>情况3.2.1：(cur)的兄弟节点(b)是黑色，且(b)的外节点儿子是红色</strong> [可完成平衡]</li>
<li><strong>情况3.2.2：(cur)的兄弟节点(b)是黑色，且(b)的内节点儿子是红色（其外节点儿子是黑色）</strong> [可完成平衡]</li>
<li><strong>情况3.2.4：(cur)的兄弟节点(b)是红色</strong> [可完成平衡]</li>
<li><strong>情况3.2.3：(cur)的兄弟节点(b)是黑色，且(b)的两个儿子都是黑色</strong> 中的 **情况3.2.3.1: 父节点(p)为红色 **[可完成平衡]</li>
<li><strong>情况3.2.3：(cur)的兄弟节点(b)是黑色，且(b)的两个儿子都是黑色</strong> 中的 <strong>情况3.2.3.2: 父节点(p)为黑色</strong> [需向上递归完成平衡]</li>
</ol>
<p>所有的情况中只有<strong>情况3.2.3：(cur)的兄弟节点(b)是黑色，且(b)的两个儿子都是黑色</strong> 中的 <strong>情况3.2.3.2: 父节点(p)为黑色</strong>是需要向上递归完成平衡的。<strong>情况3.2.4：(cur)的兄弟节点(b)是红色</strong> 只需要转化为 <strong>情况3.2：(cur)没有子节点是黑色</strong> 中的 <strong>情况3.2.1</strong> 或 <strong>情况3.2.2</strong> 或 <strong>情况3.2.3</strong>中的一种，都可直接完成平衡操作。</p>
<p><strong>情况3.2：(cur)没有子节点是黑色</strong>的总结：</p>
<ul>
<li><p><strong>兄弟节点为红色</strong>：通过旋转和颜色交换，转化为黑色兄弟节点的情况。</p>
</li>
<li><p><strong>兄弟节点为黑色</strong>：</p>
<ul>
<li><p>两个子节点均为黑色：将兄弟设为红色，传播双黑或利用红色父节点解决。</p>
</li>
<li><p>远子节点为红色：通过单次旋转和颜色调整消除双黑。</p>
</li>
<li><p>近子节点为红色：通过两次旋转和颜色调整消除双黑。</p>
</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/03/29/interview/Nginx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/29/interview/Nginx/" class="post-title-link" itemprop="url">Nginx 面试合集</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-29 17:33:08" itemprop="dateCreated datePublished" datetime="2025-03-29T17:33:08+08:00">2025-03-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-03-30 20:26:08" itemprop="dateModified" datetime="2025-03-30T20:26:08+08:00">2025-03-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/interview/" itemprop="url" rel="index"><span itemprop="name">interview</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install nginx</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> systemctl start nginx</span><br><span class="line"><span class="built_in">sudo</span> systemctl stop nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#平滑启动，不会中断</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl reload nginx</span><br><span class="line"><span class="comment">#完全重启，会中断</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl restart nginx</span><br><span class="line"><span class="comment"># 状态</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl status nginx</span><br><span class="line"><span class="comment"># 开机自启动</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> nginx</span><br><span class="line"><span class="comment"># 关闭开机启动</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">disable</span> nginx</span><br><span class="line"></span><br><span class="line">ps aux | grep nginx</span><br></pre></td></tr></table></figure>

<h1 id="1-什么是Nginx"><a href="#1-什么是Nginx" class="headerlink" title="1. 什么是Nginx"></a>1. 什么是Nginx</h1><p><a target="_blank" rel="noopener" href="https://nginx.org/">Nginx</a> 是一个高性能的<strong>HTTP服务器</strong>和<strong>反向代理服务器</strong>，它以<strong>轻量级</strong>和<strong>高并发</strong>处理能力而闻名。Nginx 的核心是基于<strong>事件驱动架构</strong>，这使得它在处理大量并发连接时表现出色。它的设计不像传统的服务器那样使用线程处理请求，而是一个更加高级的机制—事件驱动机制，是一种异步事件驱动结构。此外，Nginx 还提供了邮件代理、TCP&#x2F;UDP 代理服务器的功能，以及强大的<strong>负载均衡</strong>和<strong>缓存机制</strong>。它的模块化设计也使得它能够灵活地适应不同的应用场景。</p>
<p>Nginx 的<strong>反向代理</strong>功能允许它作为前端服务器，接收客户端的请求并将它们转发到后端服务器，同时，Nginx 也能够作为<strong>负载均衡</strong>器，将流量分配到多个后端服务器，这样可以提高网站的可用性和扩展性。Nginx 还支持<strong>静态文件服务</strong>，由于其高效的文件处理能力，它经常被用来作为静态资源的服务器。</p>
<h1 id="2-Nginx优点"><a href="#2-Nginx优点" class="headerlink" title="2.Nginx优点"></a>2.Nginx优点</h1><ul>
<li><strong>高性能和高并发</strong>：Nginx 能够处理大量的并发连接，而内存消耗相对较小。这使得它成为处理高流量网站的理想选择。</li>
<li><strong>高可靠性</strong>： Nginx有健康监听机制，当某服务器损坏后，可自动将请求转移到其他正常的服务器。</li>
<li><strong>内存消耗小</strong>：与其他服务器相比，Nginx 在开启多个进程时，内存消耗仍然很低，这对于资源有限的环境非常有用。</li>
<li>静态文件处理：Nginx 在处理静态文件方面非常高效，它能够快速地提供图片、CSS、JavaScript 等静态资源。</li>
<li><strong>反向代理 负载均衡</strong>：Nginx 可以作为负载均衡器，将流量分配到多个后端服务器，这样可以提高网站的可用性和扩展性。</li>
<li>模块化和灵活性：Nginx 的模块化设计使得它能够灵活地适应不同的应用场景，如作为邮件代理、通用 TCP&#x2F;UDP 代理服务器等。</li>
<li>安全性：Nginx 提供了多种安全特性，如防止 DDoS 攻击、限制请求频率等，这有助于提高网站的安全性。</li>
</ul>
<p>缺点：<strong>动态处理能力</strong>：Nginx 在处理动态内容方面相对较弱，它更适合作为静态资源的服务器和反向代理。对于需要复杂动态处理的应用，可能需要与其他应用服务器（如 PHP、Node.js）配合使用。</p>
<h1 id="3-Nginx性能高的原因"><a href="#3-Nginx性能高的原因" class="headerlink" title="3. Nginx性能高的原因"></a>3. Nginx性能高的原因</h1><ul>
<li>异步非阻塞事件处理机制：Nginx 使用了 <strong>epoll</strong>（在 Linux 上）模型，这是一种异步非阻塞的事件处理机制，它可以有效地处理大量的并发连接，而不会因为等待 I&#x2F;O 操作而阻塞。</li>
<li>轻量级进程&#x2F;线程模型：Nginx 使用了轻量级的进程&#x2F;线程模型，这使得它能够在有限的系统资源下处理大量的并发连接。</li>
<li>高效的内存管理：Nginx 在内存管理上非常高效，它使用了自己的内存分配器，这减少了内存碎片和内存泄露的风险。</li>
<li>模块化设计：Nginx 的模块化设计使得它能够灵活地添加或移除功能，这样可以确保只有需要的功能被加载，从而减少了资源的消耗。</li>
<li>静态文件处理优化：Nginx 对静态文件的处理进行了优化，它能够快速地提供静态资源，而不需要后端服务器的参与。</li>
</ul>
<h1 id="4-Nginx如何处理请求"><a href="#4-Nginx如何处理请求" class="headerlink" title="4. Nginx如何处理请求"></a>4. Nginx如何处理请求</h1><ol>
<li><p><strong>接收请求</strong>: 当客户端发起一个请求时，Nginx 的工作进程会监听网络端口，接收客户端的连接请求。</p>
</li>
<li><p><strong>建立连接</strong>: Nginx 接收到客户端的连接请求后，会为该连接分配一个连接对象（ngx_connection_t）。连接对象包含连接的状态信息、读写事件处理器等。</p>
</li>
<li><p><strong>读取请求头</strong>: Nginx 从客户端读取请求头信息。请求头包含 HTTP 方法（如 GET POST）、URL HTTP 版本以及各种请求头字段（如 Host User-Agent Content-Length 等）。</p>
</li>
<li><p><strong>解析请求头</strong>: Nginx 解析请求头信息，提取必要的参数，如请求方法、URI Host 等。解析后的请求头信息存储在 ngx_http_request_t 结构体中。</p>
</li>
<li><p><strong>查找匹配的 server 块</strong>: Nginx 根据请求头中的 Host 字段查找匹配的虚拟主机（server 块）。每个虚拟主机可以配置不同的域名和监听端口。</p>
</li>
<li><p><strong>查找匹配的 location 块</strong>: 在找到匹配的虚拟主机后，Nginx 继续查找与请求 URI 匹配的 location 块。location 块定义了如何处理特定路径的请求。</p>
</li>
<li><p><strong>执行处理阶段</strong>: Nginx 的请求处理分为多个阶段，每个阶段可以由多个模块处理。这些阶段包括但不限于：</p>
</li>
</ol>
<ul>
<li><p>rewrite phase：执行重写规则，如 URL 重写。</p>
</li>
<li><p>post rewrite phase：处理重写后的请求。</p>
</li>
<li><p>preaccess phase：执行访问控制，如 IP 地址过滤。</p>
</li>
<li><p>access phase：执行访问控制，如身份验证。</p>
</li>
<li><p>content phase：生成响应内容，如静态文件服务、反向代理、FastCGI 等。</p>
</li>
</ul>
<ol start="8">
<li><p><strong>生成响应</strong>: 在 content phase 阶段，Nginx 根据配置生成响应内容。这可能涉及读取静态文件、调用后端服务（如反向代理、FastCGI、uWSGI 等）、生成动态内容等。</p>
</li>
<li><p><strong>发送响应头</strong>: Nginx 将生成的响应头发送回客户端。响应头包含 HTTP 状态码、响应头字段（如 Content-Type、Content-Length 等）。</p>
</li>
<li><p><strong>发送响应体</strong>: Nginx 将生成的响应体发送回客户端。响应体可以是静态文件内容、后端服务返回的数据等。</p>
</li>
<li><p><strong>关闭连接</strong>: 一旦响应发送完毕，Nginx 会关闭连接。如果启用了 keep-alive 连接，则连接可以保持打开状态，用于后续请求。</p>
</li>
</ol>
<h1 id="5-正向代理和反向代理"><a href="#5-正向代理和反向代理" class="headerlink" title="5. 正向代理和反向代理"></a>5. 正向代理和反向代理</h1><p><img src="https://img2.baidu.com/it/u=874433948,3077840998&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=518"></p>
<p>都是网络代理服务器：</p>
<ul>
<li><p>正向代理：</p>
<ul>
<li>正向代理位于客户端和目标服务器之间。</li>
<li>客户端通过代理服务器向目标服务器发送请求。</li>
<li>目标服务器只能看到代理服务器的 IP 地址，而看不到客户端的真实 IP 地址。</li>
<li>正向代理通常用于客户端访问互联网时，通过代理服务器来访问外部资源，这可以提高安全性和隐私保护。</li>
</ul>
</li>
<li><p>反向代理：</p>
<ul>
<li><p>反向代理位于客户端和目标服务器之间，但与正向代理不同，客户端通常不知道反向代理的存在。</p>
</li>
<li><p>客户端向反向代理服务器发送请求，然后反向代理服务器将请求转发到一个或多个后端服务器。</p>
</li>
<li><p>后端服务器处理请求并将响应返回给反向代理服务器，反向代理服务器再将响应返回给客户端。</p>
</li>
<li><p>反向代理可以提高网站的可用性和扩展性，同时也可以提供缓存、负载均衡和 SSL 终端等功能。</p>
</li>
<li><p>隐藏服务器：反向代理服务器可以隐藏后端服务器的存在和特征，这有助于提高安全性，因为外部用户无法直接访问后端服务器。<br>负载均衡：反向代理可以作为负载均衡器，将流量分配到多个后端服务器，这样可以提高网站的可用性和扩展性。<br>缓存静态内容：反向代理服务器可以缓存静态内容，如图片、CSS 和 JavaScript 文件等，这样可以减少后端服务器的负载并提高响应速度。<br>SSL 终端：反向代理服务器可以处理 SSL&#x2F;TLS 加密，这样可以减轻后端服务器的加密负担。<br>压缩和优化：反向代理服务器可以在将内容发送到客户端之前对其进行压缩和优化，这样可以减少带宽消耗并提高响应速度。<br>提供额外的安全层：反向代理服务器可以提供额外的安全层，如防火墙、DDoS 防护等。</p>
<p>￼<br>                    版权声明：本文为博主原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接和本声明。</p>
</li>
</ul>
</li>
</ul>
<h1 id="6-使用“反向代理服务器”的优点"><a href="#6-使用“反向代理服务器”的优点" class="headerlink" title="6. 使用“反向代理服务器”的优点"></a>6. 使用“反向代理服务器”的优点</h1><ul>
<li><p>隐藏服务器：反向代理服务器可以隐藏后端服务器的存在和特征，这有助于提高安全性，因为外部用户无法直接访问后端服务器。</p>
</li>
<li><p>负载均衡：反向代理可以作为负载均衡器，将流量分配到多个后端服务器，这样可以提高网站的可用性和扩展性。</p>
</li>
<li><p>缓存静态内容：反向代理服务器可以缓存静态内容，如图片、CSS 和 JavaScript 文件等，这样可以减少后端服务器的负载并提高响应速度。</p>
</li>
<li><p>SSL 终端：反向代理服务器可以处理 SSL&#x2F;TLS 加密，这样可以减轻后端服务器的加密负担。<br>压缩和优化：反向代理服务器可以在将内容发送到客户端之前对其进行压缩和优化，这样可以</p>
<p>减少带宽消耗并提高响应速度。</p>
</li>
<li><p>提供额外的安全层：反向代理服务器可以提供额外的安全层，如防火墙、DDoS 防护等。</p>
</li>
</ul>
<h1 id="7-Nginx应用场景"><a href="#7-Nginx应用场景" class="headerlink" title="7. Nginx应用场景"></a>7. Nginx应用场景</h1><ul>
<li><p>HTTP 服务器：Nginx 可以作为 HTTP 服务器独立提供 HTTP 服务，适用于静态网站托管。</p>
</li>
<li><p>虚拟主机：Nginx 支持虚拟主机功能，可以在一台服务器上托管多个网站，这对于托管提供商来说非常有用。</p>
</li>
<li><p>反向代理和负载均衡：Nginx 可以作为反向代理服务器，将请求转发到后端服务器，并支持负载均衡，这对于高流量网站和应用来说非常重要。</p>
</li>
<li><p>API 网关：Nginx 可以配置为 API 网关，对每个接口服务进行拦截和路由，提供额外的安全层和流量控制。</p>
</li>
<li><p>媒体流服务：Nginx 支持媒体流服务，可以用于视频点播和直播服务。</p>
</li>
<li><p>邮件代理：Nginx 还可以作为邮件代理服务器，处理邮件传输。</p>
</li>
<li><p>缓存服务器：Nginx 可以设置为缓存服务器，缓存静态内容和动态内容，减少后端服务器的负载，提高响应速度。</p>
</li>
<li><p>SSL 终端：Nginx 可以处理 SSL&#x2F;TLS 加密，提供 HTTPS 服务，增强数据传输的安全性。</p>
</li>
</ul>
<h1 id="8-Nginx目录结构"><a href="#8-Nginx目录结构" class="headerlink" title="8. Nginx目录结构"></a>8. Nginx目录结构</h1><p>client_body_temp：用于存储客户端请求的临时文件。<br>conf：存放 Nginx 的配置文件，包括 nginx.conf 主配置文件和其他配置文件。<br>fastcgi_temp：用于存储 FastCGI 进程的临时文件。<br>html：默认的站点目录，通常用于存放静态文件，如 HTML、CSS、JavaScript 文件等。<br>logs：存放 Nginx 的日志文件，包括访问日志 access.log、错误日志 error.log 和进程 ID 文件 nginx.pid。<br>proxy_temp：用于存储代理服务器的临时文件。<br>sbin：存放 Nginx 的可执行文件，如 nginx 命令。<br>scgi_temp：用于存储 SCGI 进程的临时文件。<br>uwsgi_temp：用于存储 uWSGI 进程的临时文件。</p>
<h1 id="9-Nginx配置文件nginx-conf有哪些属性模块"><a href="#9-Nginx配置文件nginx-conf有哪些属性模块" class="headerlink" title="9. Nginx配置文件nginx.conf有哪些属性模块"></a>9. Nginx配置文件nginx.conf有哪些属性模块</h1><ul>
<li><p>http：定义了 HTTP 服务器的配置，包括文件类型、默认类型、连接超时等。</p>
</li>
<li><p>server：定义了虚拟主机的配置，可以包含多个 server 块，每个块定义了一个虚拟主机的设置。</p>
</li>
<li><p>location：定义了请求的匹配和处理规则，可以根据 URI、正则表达式等匹配请求，并指定处理方式。</p>
</li>
<li><p>upstream：定义了负载均衡的配置，可以指定多个后端服务器，并设置负载均衡策略。</p>
</li>
<li><p>events：定义了事件处理的配置，如工作连接数 worker_connections。</p>
</li>
<li><p>mail：如果 Nginx 用于邮件代理，这个模块用于配置邮件服务的相关参数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">全局模块</span><br><span class="line">event模块</span><br><span class="line">http模块</span><br><span class="line">    upstream模块</span><br><span class="line"></span><br><span class="line">    server模块</span><br><span class="line">        location块</span><br><span class="line">        location块</span><br><span class="line">        ....</span><br><span class="line">    server模块</span><br><span class="line">        location块</span><br><span class="line">        location块</span><br><span class="line">        ...</span><br><span class="line">    ....    </span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="10-静态文件服务"><a href="#10-静态文件服务" class="headerlink" title="10. 静态文件服务"></a>10. 静态文件服务</h1><p>Nginx 在处理静态文件（如 HTML、CSS、JavaScript 和图像文件）时非常高效。它可以直接从文件系统中读取静态文件并返回给客户端，而不需要经过复杂的处理流程。</p>
<ul>
<li>root 指令：指定文件系统上的根目录，用于查找静态资源。</li>
<li>alias 指令：为静态资源定义一个别名，方便管理和引用。</li>
<li>autoindex 指令：当请求的 URI 以斜杠 &#x2F; 结尾时，启用目录索引功能，列出目录下的所有文件。</li>
<li>sendfile 指令：开启高效传输模式，允许 Nginx 直接在内核空间将文件发送给客户端，提高文件传输效率。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">	server &#123;</span><br><span class="line">	    listen 8081;</span><br><span class="line">	    server_name localhost;</span><br><span class="line">	    root /home/amber/Downloads/photo;</span><br><span class="line">	    autoindex on; # 启用目录列表</span><br><span class="line">	    location / &#123;</span><br><span class="line">			try_files $uri $uri/ =404;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="11-如何用Nginx解决前端跨域问题"><a href="#11-如何用Nginx解决前端跨域问题" class="headerlink" title="11. 如何用Nginx解决前端跨域问题"></a>11. 如何用Nginx解决前端跨域问题</h1><p>Nginx 可以通过配置 CORS（跨源资源共享）头部来解决前端跨域问题。</p>
<p>在 server 或 location 块中，使用 add_header 指令添加 Access-Control-Allow-Origin 头部，指定允许访问的源。如果需要，还可以添加 Access-Control-Allow-Methods 头部，指定允许的 HTTP 方法。对于需要凭证的请求，可以添加 Access-Control-Allow-Credentials 头部。</p>
<blockquote>
<p>产生跨域问题的主要原因就在于<strong>同源策略</strong>，为了保证用户信息安全，防止恶意网站窃取数据，同源策略是必须的，否则<code>cookie</code>可以共享。由于<code>http</code>无状态协议通常会借助<code>cookie</code>来实现有状态的信息记录，例如用户的身份&#x2F;密码等，因此一旦<code>cookie</code>被共享，那么会导致用户的身份信息被盗取。<br>同源策略主要是指三点相同，<strong>协议+域名+端口</strong> 相同的两个请求，则可以被看做是同源的，但如果其中任意一点存在不同，则代表是两个不同源的请求，同源策略会限制了不同源之间的资源交互。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    # 允许跨域的请求，可以自定义变量$http_origin，*表示所有</span><br><span class="line">    add_header &#x27;Access-Control-Allow-Origin&#x27; *;</span><br><span class="line">    # 允许携带cookie请求</span><br><span class="line">    add_header &#x27;Access-Control-Allow-Credentials&#x27; &#x27;true&#x27;;</span><br><span class="line">    # 允许跨域请求的方法：GET,POST,OPTIONS,PUT</span><br><span class="line">    add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET,POST,OPTIONS,PUT&#x27;;</span><br><span class="line">    # 允许请求时携带的头部信息，*表示所有</span><br><span class="line">    add_header &#x27;Access-Control-Allow-Headers&#x27; *;</span><br><span class="line">    # 允许发送按段获取资源的请求</span><br><span class="line">    add_header &#x27;Access-Control-Expose-Headers&#x27; &#x27;Content-Length,Content-Range&#x27;;</span><br><span class="line">    # 一定要有！！！否则Post请求无法进行跨域！</span><br><span class="line">    # 在发送Post跨域请求前，会以Options方式发送预检请求，服务器接受时才会正式请求</span><br><span class="line">    if ($request_method = &#x27;OPTIONS&#x27;) &#123;</span><br><span class="line">        add_header &#x27;Access-Control-Max-Age&#x27; 1728000;</span><br><span class="line">        add_header &#x27;Content-Type&#x27; &#x27;text/plain; charset=utf-8&#x27;;</span><br><span class="line">        add_header &#x27;Content-Length&#x27; 0;</span><br><span class="line">        # 对于Options方式的请求返回204，表示接受跨域请求</span><br><span class="line">        return 204;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="12-Nginx虚拟主机怎么配置"><a href="#12-Nginx虚拟主机怎么配置" class="headerlink" title="12. Nginx虚拟主机怎么配置"></a>12. Nginx虚拟主机怎么配置</h1><p>在 Nginx 中配置虚拟主机主要涉及 <code>server</code> 块的设置。</p>
<ul>
<li>定义 server 块：每个 server 块定义了一个虚拟主机的配置。</li>
<li>设置监听端口：使用 listen 指令设置服务器监听的端口，通常是 80（HTTP）和 443（HTTPS）。</li>
<li>设置服务器名称：使用 server_name 指令设置虚拟主机的域名。</li>
<li>定义 location 块：在 server 块内部定义 location 块，设置请求的处理规则。</li>
<li>设置根目录：使用 root 指令设置网站内容的根目录。</li>
<li>设置默认首页：使用 index 指令设置默认首页文件。</li>
</ul>
<p><code>location</code> 指令在 Nginx 配置中扮演着核心角色，它定义了如何处理进入 Nginx 的 HTTP 请求。location 块可以匹配不同的 URI、正则表达式或指定的字符串，从而允许对特定的请求路径应用不同的处理规则。</p>
<ul>
<li>精确匹配：使用 &#x3D; 符号进行精确匹配，例如 location &#x3D; &#x2F; 匹配根路径。</li>
<li>字符串开头匹配：使用 ^~ 符号匹配以特定字符串开头的 URI。</li>
<li>正则表达式匹配：使用 ~ 或 ~* 符号进行正则表达式匹配，其中 ~ 是区分大小写的，而 ~* 是不区分大小写的。</li>
<li>通用匹配（前缀匹配）：使用 &#x2F; 符号进行通用匹配，作为最后的选择，如果其他匹配都未成功，请求将被这个 location 块处理。</li>
</ul>
<p>location 块可以包含多种指令，如 proxy_pass root try_files 等，用于定义请求的处理方式，例如代理到后端服务器、提供静态文件服务或重定向。</p>
<h1 id="13-Nginx配置SSL证书"><a href="#13-Nginx配置SSL证书" class="headerlink" title="13. Nginx配置SSL证书"></a>13. Nginx配置SSL证书</h1><p>为了缓解后端服务器的压力，加密解密一般都放置在Nginx反向代理中，而后端服务器处于局域网内，不需要加密传输。</p>
<ol>
<li><p>先去CA机构或从云控制台中申请对应的<code>SSL</code>证书，审核通过后下载<code>Nginx</code>版本的证书。</p>
</li>
<li><p>下载数字证书后，完整的文件总共有三个：<code>.crt .key .pem,</code></p>
<ul>
<li><code>.crt</code>：数字证书文件，<code>.crt</code>是<code>.pem</code>的拓展文件，因此有些人下载后可能没有。&#96;</li>
<li><code>.key</code>：服务器的私钥文件，及非对称加密的私钥，用于解密公钥传输的数据。</li>
<li><code>.pem</code>：<code>Base64-encoded</code>编码格式的源证书文本文件，可自行根需求修改拓展名。</li>
</ul>
</li>
<li><p>在<code>Nginx</code>目录下新建<code>certificate</code>目录，并将下载好的证书&#x2F;私钥等文件上传至该目录。</p>
</li>
<li><p>修改Nginx配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># ----------HTTPS配置-----------</span><br><span class="line">server &#123;</span><br><span class="line">    # 监听HTTPS默认的443端口</span><br><span class="line">    listen 443;</span><br><span class="line">    # 配置自己项目的域名</span><br><span class="line">    server_name www.xxx.com;</span><br><span class="line">    # 打开SSL加密传输</span><br><span class="line">    ssl on;</span><br><span class="line">    # 输入域名后，首页文件所在的目录</span><br><span class="line">    root html;</span><br><span class="line">    # 配置首页的文件名</span><br><span class="line">    index index.html index.htm index.jsp index.ftl;</span><br><span class="line">    # 配置自己下载的数字证书</span><br><span class="line">    ssl_certificate  certificate/xxx.pem;</span><br><span class="line">    # 配置自己下载的服务器私钥</span><br><span class="line">    ssl_certificate_key certificate/xxx.key;</span><br><span class="line">    # 停止通信时，加密会话的有效期，在该时间段内不需要重新交换密钥</span><br><span class="line">    ssl_session_timeout 5m;</span><br><span class="line">    # TLS握手时，服务器采用的密码套件</span><br><span class="line">    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class="line">    # 服务器支持的TLS版本</span><br><span class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">    # 开启由服务器决定采用的密码套件</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        ....</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># ---------HTTP请求转HTTPS-------------</span><br><span class="line">server &#123;</span><br><span class="line">    # 监听HTTP默认的80端口</span><br><span class="line">    listen 80;</span><br><span class="line">    # 如果80端口出现访问该域名的请求</span><br><span class="line">    server_name www.xxx.com;</span><br><span class="line">    # 将请求改写为HTTPS（这里写你配置了HTTPS的域名）</span><br><span class="line">    rewrite ^(.*)$ https://www.xxx.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="14-如何配置限流"><a href="#14-如何配置限流" class="headerlink" title="14. 如何配置限流"></a>14. 如何配置限流</h1><p>Nginx 的限流基于令牌桶算法，主要依赖以下指令：</p>
<ul>
<li><strong>limit_req_zone</strong>：定义限流的共享内存区域和限制规则。</li>
<li><strong>limit_req</strong>：在具体的 location 中应用限流规则。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 限制每个 IP 每秒 2 次请求</span><br><span class="line">http &#123;</span><br><span class="line">    limit_req_zone $binary_remote_addr zone=myzone:10m rate=2r/s;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        location / &#123;</span><br><span class="line">        	#允许额外 5 个突发请求，超限请求会被延迟处理</span><br><span class="line">            limit_req zone=myzone burst=5;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果客户端在 1 秒内发送 10 个请求：</p>
<ul>
<li>前 2 个请求立即处理（符合 rate）。</li>
<li>接下来的 5 个请求进入队列（burst 容量）。</li>
<li>剩余 3 个请求被拒绝（桶满）。</li>
<li>队列中的 5 个请求会以每秒 2 个的速率逐步处理。</li>
</ul>
<h1 id="15-漏桶流算法和令牌桶算法"><a href="#15-漏桶流算法和令牌桶算法" class="headerlink" title="15. 漏桶流算法和令牌桶算法"></a>15. 漏桶流算法和令牌桶算法</h1><p>漏桶算法和令牌桶算法是两种常用的流量整形和速率限制算法，它们在网络中用于控制数据的传输速率。</p>
<ul>
<li><p>漏桶算法：<br>漏桶算法通过一个固定容量的桶和漏水龙头来控制数据流。数据以任意速率进入桶中，然后以固定的速率从桶中流出。如果桶满了，额外的数据将被丢弃。这种机制可以平滑突发流量，确保数据以固定的速率被处理，防止网络拥塞。</p>
</li>
<li><p>令牌桶算法：<br>令牌桶算法使用一个令牌桶，桶中会以固定的速率生成令牌。每个数据包的发送需要消耗一个令牌。如果桶中没有令牌，数据包将被延迟发送，直到桶中有令牌可用。这种算法允许数据以峰值速率发送，直到令牌耗尽，然后数据发送速率将降至平均速率。</p>
</li>
</ul>
<p>令牌桶算法更适合需要突发传输的应用，因为它允许在令牌充足时快速发送数据。而漏桶算法则更适合于那些需要持续、均匀速率发送数据的应用。</p>
<h1 id="16-Nginx-动静分离"><a href="#16-Nginx-动静分离" class="headerlink" title="16. Nginx 动静分离"></a>16. Nginx 动静分离</h1><p>动静分离是指将动态内容和静态内容分开处理和存储。</p>
<ul>
<li>性能优化：静态资源如图片 CSS JavaScript 文件等不经常变化，可以由 Nginx 直接提供，这样可以减少后端应用服务器的负载，提高响应速度。</li>
<li>缓存策略：静态资源适合设置较长的缓存时间，而动态内容通常需要实时处理，动静分离后可以针对静态资源设置更有效的缓存策略。</li>
<li>扩展性：在高流量的情况下，可以通过增加静态资源服务器的数量来提高服务能力，而不用担心影响动态内容的处理。</li>
<li>安全性：静态资源通常不需要访问后端数据库或其他安全敏感的服务，将它们与动态内容分离可以减少安全风险。</li>
</ul>
<p>通过动静分离，可以提高网站的整体性能和可扩展性，同时降低运维成本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name example.com;</span><br><span class="line">    </span><br><span class="line">    # 静态资源配置</span><br><span class="line">    location ~ .*\.(html|htm|gif|jpg|jpeg|bmp|png|ico|txt|js|css)&#123;</span><br><span class="line">        root    /xxx/static_resources;</span><br><span class="line">        expires 7d;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    # 动态资源配置</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://backend;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="17-Nginx负载均衡的算法"><a href="#17-Nginx负载均衡的算法" class="headerlink" title="17. Nginx负载均衡的算法"></a>17. Nginx负载均衡的算法</h1><p>Nginx 实现负载均衡主要通过 upstream 模块，该模块允许定义一个后端服务器组，并根据特定的策略将请求分发到这些服务器。以下是 Nginx 支持的一些负载均衡策略：</p>
<ul>
<li><p>轮询（round-robin）：默认策略，将请求按顺序轮流分配给每个服务器。</p>
</li>
<li><p>权重（weight）：通过给每个服务器设置权重来控制流量分配的比例。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream app1 &#123;</span><br><span class="line">    server 10.10.10.1 weight=3;</span><br><span class="line">    server 10.10.10.2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>IP绑定（ip_hash）：通过请求来源的 IP 地址进行哈希，确保同一 IP 的请求总是被分配到同一个服务器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream app1 &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server 10.10.10.1;</span><br><span class="line">    server 10.10.10.2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>最少连接（least-connected）：每次都找连接数最少的服务器来转发请求。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream app1 &#123;</span><br><span class="line">    least_conn;</span><br><span class="line">    server 10.10.10.1;</span><br><span class="line">    server 10.10.10.2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">    upstream backend &#123;</span><br><span class="line">        server server1 weight=3;</span><br><span class="line">        server server2 weight=2;</span><br><span class="line">        server server3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name example.com;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://backend;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="18-Nginx配置高可用性"><a href="#18-Nginx配置高可用性" class="headerlink" title="18. Nginx配置高可用性"></a>18. Nginx配置高可用性</h1><p>配置 Nginx 以实现高可用性主要涉及确保 Nginx 能够处理后端服务器的故障，并在必要时将流量重定向到健康的服务器。</p>
<ul>
<li>定义多个后端服务器：在 upstream 块中定义多个服务器，以便在一个服务器失败时有备用服务器可用。</li>
<li>设置超时参数：配置 proxy_connect_timeout、proxy_send_timeout 和 proxy_read_timeout 指令，以便在后端服务器无响应时及时失败转移。</li>
<li>使用 max_fails 和 fail_timeout：配置 max_fails 指令来设置在多长时间内允许多少次失败，以及 fail_timeout 指令来设置服务器失败后应该被排除在外的时间。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    upstream backend &#123;</span><br><span class="line">        server server1;</span><br><span class="line">        server server2;</span><br><span class="line">        server server3;</span><br><span class="line"></span><br><span class="line">        max_fails=3;</span><br><span class="line">        fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name example.com;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://backend;</span><br><span class="line">            proxy_connect_timeout 1s;</span><br><span class="line">            proxy_send_timeout 1s;</span><br><span class="line">            proxy_read_timeout 1s;</span><br><span class="line">            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果后端服务器在 30 秒内失败超过 3 次，它将被认为不可用，并从轮询中排除 30 秒。同时，如果 Nginx 遇到超时或指定的 HTTP 状态码，它将尝试将请求代理到另一个健康的服务器</p>
<h1 id="19-限制IP或浏览器访问"><a href="#19-限制IP或浏览器访问" class="headerlink" title="19. 限制IP或浏览器访问"></a>19. 限制IP或浏览器访问</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># 只允许Chrome浏览器访问</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name example.com;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">        if ($http_user_agent ~ Chrome) &#123;</span><br><span class="line">            return 500;</span><br><span class="line">        &#125;</span><br><span class="line">        proxy_pass http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># ------------------------------------------------------</span><br><span class="line"># 只允许192.168.1.100和192.168.1.101访问</span><br><span class="line">geo $block_ip &#123;</span><br><span class="line">    default 0;</span><br><span class="line">    192.168.1.100 1;</span><br><span class="line">    192.168.1.101 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name example.com;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">        if ($block_ip) &#123;</span><br><span class="line">            return 403;</span><br><span class="line">        &#125;</span><br><span class="line">        proxy_pass http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="20-多进程模型-主进程-和-工作进程"><a href="#20-多进程模型-主进程-和-工作进程" class="headerlink" title="20. 多进程模型 主进程 和 工作进程"></a>20. 多进程模型 主进程 和 工作进程</h1><p>Nginx的多进程模型主要由一个主进程（master process）和多个工作进程（worker process）组成。主进程负责管理和监控工作进程，而工作进程负责处理实际的客户端请求。</p>
<p>每个工作进程都是单线程的，这意味着每个工作进程在同一时间只能处理一个客户端请求。这种设计选择主要基于以下原因：</p>
<ul>
<li>轻量级：单线程模型相对于多线程或多进程模型来说更加轻量级，减少了线程切换和进程间通信的开销。</li>
<li>可扩展性：通过创建多个工作进程，Nginx能够同时处理多个请求，实现高并发处理能力。每个工作进程之间相互独立，可以并行处理请求，提高系统的吞吐量。</li>
<li>高效的事件驱动模型：Nginx使用了高效的事件驱动模型（基于epoll kqueue等），通过异步非阻塞方式处理网络请求，从而避免了线程阻塞和资源浪费。</li>
</ul>
<p>需要注意的是，尽管每个工作进程是单线程的，但Nginx通过事件驱动和非阻塞I&#x2F;O的方式能够处理大量并发请求，实现高性能和高吞吐量。这种设计在处理静态内容和反向代理等场景下表现出色，但在涉及大量计算密集型任务的场景下可能会受到性能限制。在这种情况下，通常会将计算任务委托给后端应用服务器来处理。</p>
<p>当Nginx启动时，它会创建一个主进程（master process），主进程主要负责以下任务：</p>
<ul>
<li>读取并解析配置文件：主进程会读取Nginx的主配置文件（nginx.conf），包括全局配置和默认服务器配置。它还可以包含其他辅助配置文件（如conf.d目录下的文件）。</li>
<li>启动工作进程：主进程会根据配置文件中指定的工作进程数量，创建相应数量的工作进程。每个工作进程都是一个独立的进程，负责实际处理客户端请求。</li>
<li>监控工作进程：主进程会监控工作进程的运行状态，如果工作进程异常退出或终止，主进程会重新启动新的工作进程来替代。</li>
<li>处理信号：主进程可以接收系统信号（如重启、停止等），并根据信号进行相应的操作，例如重新加载配置文件或优雅地关闭工作进程。</li>
</ul>
<p>每个工作进程都是单线程的，每个工作进程通过异步非阻塞方式处理客户端请求。这种事件驱动的模型允许每个工作进程同时处理多个并发请求，而无需为每个请求创建一个新的线程。</p>
<p>工作进程的主要任务包括：</p>
<ul>
<li>接收和处理连接：工作进程通过监听套接字接收客户端的连接请求，并根据配置文件中的服务器块进行请求分发。它会接受请求、解析请求头和请求体，并执行相应的操作。</li>
<li>处理请求：工作进程通过事件驱动模型，使用非阻塞I&#x2F;O方式处理请求。它会执行请求所需的操作，如读取文件、向后端服务器发起代理请求等。</li>
<li>响应客户端：工作进程会生成响应数据，并将响应发送回客户端。它会设置响应头、发送响应体，并根据配置进行内容压缩、缓存等操作。</li>
<li>日志记录：工作进程会将访问日志和错误日志写入相应的日志文件，记录请求的详细信息和错误信息。</li>
</ul>
<p>Nginx的多进程单线程模型结合了事件驱动和非阻塞I&#x2F;O的优势，使得它在高并发场景下能够高效地处理大量的并发请求，同时保持较低的资源消耗。这使得Nginx成为一个流行的高性能Web服务器和反向代理服务器。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/03/17/springboot/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A1%86%E6%9E%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/17/springboot/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A1%86%E6%9E%B6/" class="post-title-link" itemprop="url">SpringBoot 数据库框架</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-17 20:06:24" itemprop="dateCreated datePublished" datetime="2025-03-17T20:06:24+08:00">2025-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-07-05 17:53:11" itemprop="dateModified" datetime="2025-07-05T17:53:11+08:00">2025-07-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/springboot/" itemprop="url" rel="index"><span itemprop="name">springboot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>SpringBoot连接数据库基本都通过数据库框架，主要框架分为纯底层框架，半ORM框架，ORM框架。</p>
<p>ORM框架：ORM（Object-Relational Mapping）框架是一种编程技术，用于在对象模型和关系数据库之间建立映射，从而实现数据的持久化存储和操作。具体来说，ORM框架将数据库中的表（table）映射为编程语言中的类（class），表中的记录（record）映射为类的实例（object），字段（field）映射为对象的属性（attribute）。</p>
</blockquote>
<h1 id="Java-数据库框架"><a href="#Java-数据库框架" class="headerlink" title="Java 数据库框架"></a>Java 数据库框架</h1><h2 id="JDBC（Java-Database-Connectivity）"><a href="#JDBC（Java-Database-Connectivity）" class="headerlink" title="JDBC（Java Database Connectivity）"></a>JDBC（Java Database Connectivity）</h2><blockquote>
<p>JDBC（Java Database Connectivity，Java 数据库连接）是 Java 官方设计的一套 <strong>关系型数据库访问标准 API</strong></p>
<p>设计目标：统一访问标准，屏蔽关系型数据库差异。</p>
<ul>
<li>关系型数据库：MySQL、PostgreSQL、Oracle、SQL Server、DB2、SQLite、MariaDB</li>
<li>嵌入式数据库：H2、HSQLDB、Derby</li>
<li>云数据库：Amazon RDS、Google Cloud SQL、Azure SQL Database</li>
</ul>
<p>注：部分非关系型数据库如MongoDB虽然侧面支持JDBC驱动但仍然推荐使用原生驱动，redis也需要使用原生驱动。</p>
</blockquote>
<ol>
<li><strong>加载驱动</strong>：通过Class.forName()或DriverManager注册数据库驱动，加载JDBC驱动类。</li>
<li><strong>建立连接</strong>：使用DriverManager.getConnection(url, user, password)创建与数据库的连接，生成Connection对象。</li>
<li><strong>创建语句</strong>：通过Connection创建Statement或PreparedStatement对象，用于执行SQL查询。</li>
<li><strong>执行SQL</strong>：调用executeQuery()（查询）或executeUpdate()（增删改）发送SQL语句到数据库，获取结果。</li>
<li><strong>处理结果</strong>：对于查询，处理ResultSet对象，提取数据；对于更新，返回受影响行数。</li>
<li><strong>释放资源</strong>：关闭ResultSet、Statement和Connection对象，释放数据库和JDBC资源。</li>
</ol>
<h2 id="ORM（Object-Relational-Mapping）"><a href="#ORM（Object-Relational-Mapping）" class="headerlink" title="ORM（Object Relational Mapping）"></a>ORM（Object Relational Mapping）</h2><blockquote>
<p>把 <strong>面向对象编程语言中的对象</strong> 映射为 <strong>关系型数据库中的数据表</strong> 的技术。</p>
<ul>
<li>将数据库表结构映射为 Java 对象</li>
<li>提供 CRUD（增删改查）接口，自动生成 SQL</li>
<li>提供查询语法（如 JPQL、HQL）</li>
<li>提供事务、缓存、懒加载等扩展功能</li>
</ul>
</blockquote>
<p>流程图：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Java 对象 → ORM 映射 → SQL 生成 → JDBC 执行 → 结果映射回 Java 对象</span><br></pre></td></tr></table></figure>

<p>详细流程：</p>
<ol>
<li>ORM 扫描实体类（@Entity）读取注解或 XML 映射信息。</li>
<li>ORM 根据对象操作（save、find、update、delete）动态生成 SQL。</li>
<li>ORM 调用 JDBC 执行 SQL。</li>
<li>ORM 将 ResultSet 转换为 Java 对象，自动封装数据。</li>
</ol>
<table>
<thead>
<tr>
<th>框架</th>
<th>特点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>Hibernate</td>
<td>功能最全，自动 SQL，支持缓存</td>
<td>复杂对象关系，高度自动化需求</td>
</tr>
<tr>
<td>JPA（规范）</td>
<td>标准接口（Hibernate 常用实现）</td>
<td>需要标准化 ORM 接口，Spring 官方推荐</td>
</tr>
<tr>
<td>MyBatis</td>
<td>半自动映射，手写 SQL</td>
<td>SQL 灵活控制，复杂查询</td>
</tr>
<tr>
<td>Spring Data JPA</td>
<td>基于 JPA，进一步封装</td>
<td>简单快速开发，配合 Spring Boot 最佳</td>
</tr>
</tbody></table>
<h1 id="SpringBoot数据库框架"><a href="#SpringBoot数据库框架" class="headerlink" title="SpringBoot数据库框架"></a>SpringBoot数据库框架</h1><p>在使用 Spring Boot 开发应用时，选择合适的数据库框架（主要是 ORM 框架）对项目的开发效率和性能至关重要。</p>
<h2 id="1-Spring-Data-JPA（ORM框架）"><a href="#1-Spring-Data-JPA（ORM框架）" class="headerlink" title="1.Spring Data JPA（ORM框架）"></a>1.Spring Data JPA（ORM框架）</h2><blockquote>
<p>Spring Data JPA 是 Spring Boot 的默认 ORM 框架，基于 <strong>Hibernate</strong> 实现。它提供了简单易用的接口和注解，可以极大减少样板代码。</p>
</blockquote>
<p>程序员不需要编写SQL语句，框架已经高度封装CRUD，调用对应的Java方法即可执行SQL语句。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-MyBatis（半ORM框架）"><a href="#2-MyBatis（半ORM框架）" class="headerlink" title="2. MyBatis（半ORM框架）"></a>2. MyBatis（半ORM框架）</h2><blockquote>
<p>MyBatis 是一个轻量级的持久层框架，提供 SQL 映射功能，开发者可以直接编写 SQL 语句。</p>
</blockquote>
<p>MyBatis允许程序员自行编写SQL语句，并通过<code>@Mapper</code>将编写的SQL封装到Java对象并注册为Spring的Bean中，程序员可以通过<code>@Autowired</code>获取Java对象并调用方法执行对应的SQL语句。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">&lt;/dependency</span><br></pre></td></tr></table></figure>

<h2 id="3-Spring-JDBC（纯底层框架）"><a href="#3-Spring-JDBC（纯底层框架）" class="headerlink" title="3.Spring JDBC（纯底层框架）"></a>3.Spring JDBC（纯底层框架）</h2><blockquote>
<p>Spring JDBC 是 Spring 提供的最底层的 JDBC 封装，适合直接操作数据库的场景。</p>
</blockquote>
<p>所有的SQL都需要程序员手动编写，不支持ORM的功能。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="4-Hibernate（ORM框架）"><a href="#4-Hibernate（ORM框架）" class="headerlink" title="4. Hibernate（ORM框架）"></a>4. Hibernate（ORM框架）</h2><blockquote>
<p>Hibernate 是一个功能强大的 ORM 框架，Spring Data JPA 底层就是基于 Hibernate 实现的。如果你需要直接使用 Hibernate，可以绕过 Spring Data JPA。这里就不做详细介绍了。</p>
</blockquote>
<table>
<thead>
<tr>
<th>框架</th>
<th>推荐场景</th>
<th>学习曲线</th>
<th>性能优化空间</th>
</tr>
</thead>
<tbody><tr>
<td>Spring Data JPA</td>
<td>中小型项目，快速开发</td>
<td>低</td>
<td>中等</td>
</tr>
<tr>
<td>MyBatis</td>
<td>性能敏感型项目，复杂查询</td>
<td>中等</td>
<td>高</td>
</tr>
<tr>
<td>Hibernate</td>
<td>需要高级 ORM 特性</td>
<td>高</td>
<td>中等</td>
</tr>
<tr>
<td>JOOQ</td>
<td>类型安全 SQL 查询，复杂数据库操作</td>
<td>中等</td>
<td>高</td>
</tr>
<tr>
<td>Spring JDBC</td>
<td>极致性能，轻量级应用</td>
<td>低</td>
<td>最高</td>
</tr>
</tbody></table>
<hr>
<p>对于有经验的程序员，Mybatis框架是一个很好的选择，程序员可以自定义SQL语句用于优化性能，又可以通过ORM框架将SQL语句封装到Java对象中。</p>
<p>如果对数据库不甚了解，可以选择Spring Data JPA通过Java对象直接执行SQL语句，不需要了解SQL语句。</p>
<h1 id="SpringBoot数据库连接原理"><a href="#SpringBoot数据库连接原理" class="headerlink" title="SpringBoot数据库连接原理"></a>SpringBoot数据库连接原理</h1><p>SpringBoot需要创建一个<code>DataSource</code>的bean类，用于告诉框架如何连接数据库，而且其中也可以包含连接池。</p>
<p><strong>DataSource 是一个数据库连接的统一管理接口，用于获取数据库连接。</strong></p>
<p>原理：</p>
<ul>
<li><code>DataSource</code> 是 <strong>数据库连接池的门面</strong>。</li>
<li>程序通过 <code>DataSource</code> 向数据库请求连接（Connection）。</li>
<li>连接池的管理细节（如 HikariCP、Druid、Tomcat Pool）都被 <code>DataSource</code> 封装起来，对上层透明。</li>
<li>数据库的驱动：<code>DataSource</code>通过<code>DriverManager</code>利用Java SPI机制（<code>ServiceLoader.load(Driver.class)</code>）加载类路径中的 JDBC 驱动（基于 <code>META-INF/services/java.sql.Driver</code> 配置）。</li>
</ul>
<h1 id="Mybatis数据库框架"><a href="#Mybatis数据库框架" class="headerlink" title="Mybatis数据库框架"></a>Mybatis数据库框架</h1><p>添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="加载DataSource"><a href="#加载DataSource" class="headerlink" title="加载DataSource"></a>加载DataSource</h2><p>当类路径中存在<code>javax.sql.DataSource</code>和嵌入式数据库相关的类，会激活自动配置类<code>DataSourceAutoConfiguration</code>用于配置<code>DataSource</code>的Bean。</p>
<p>其中<code>DataSourceAutoConfiguration</code>存在于<code>org.springframework.boot:spring-boot-autoconfigure</code>的<code>META-INF/spring/org.sringframework.boot.autoconfigure.AutoConfiguration.imports</code>。</p>
<blockquote>
<p>SpringBoot启动过程中，在处理注解<code>@EnableAutoConfiguration</code>时，会在<code>@Import(AutoConfigurationImportSelector.class)</code>导入<code>AutoConfigurationImportSelector</code>，该类会搜索classpath内的所有<code>/META-INF/spring/xxx.imports</code>内的自动配置类。</p>
<p>注解的处理逻辑存在于<code>AbstractApplicationContext.refresh.invokeBeanFactoryPostProcessors(beanFactory)</code>中。</p>
</blockquote>
<p><code>org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration(before = SqlInitializationAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; DataSource.class, EmbeddedDatabaseType.class &#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(type = &quot;io.r2dbc.spi.ConnectionFactory&quot;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(DataSourceProperties.class)</span></span><br><span class="line"><span class="meta">@Import(&#123; DataSourcePoolMetadataProvidersConfiguration.class, DataSourceCheckpointRestoreConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceAutoConfiguration</span> &#123;</span><br><span class="line"><span class="comment">//......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="触发条件"><a href="#触发条件" class="headerlink" title="触发条件"></a>触发条件</h3><p><code>@ConditionalOnClass(&#123; DataSource.class, EmbeddedDatabaseType.class &#125;)</code>只有Spring中同时具有<code>DataSource.class</code>和<code>EmbeddedDatabaseType.class</code>才会加载该配置类。其中<code>DataSource.class</code>是JDK标准库的一部分所以条件横为真。</p>
<ul>
<li><p>当引入<code>mysql-connector-j</code>会提供<code>com.mysql.cj.jdbc.MysqlDataSource</code>和数据库驱动。</p>
</li>
<li><p>当引入<code>mybatis-spring-boot-starter</code>，包含<code>spring-jdbc</code>依赖，其中包含了<code>/org/springframework/spring-jdbc/6.2.3/spring-jdbc-6.2.3.jar!/org/springframework/jdbc/datasource/embedded/EmbeddedDatabaseType.class</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mybatis-spring-boot-starter</span><br><span class="line">├── mybatis-spring-boot-autoconfigure</span><br><span class="line">├── mybatis</span><br><span class="line">├── mybatis-spring</span><br><span class="line">└── spring-boot-starter-jdbc</span><br><span class="line">    ├── spring-jdbc</span><br><span class="line">    └── HikariCP（默认连接池）</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>javax.sql.DataSource</strong>：由 JDK 提供，总是存在（Java 6 及以上版本）。</p>
<p><strong>EmbeddedDatabaseType</strong>：由 spring-jdbc 提供，通过 mybatis-spring-boot-starter 间接引入。</p>
<h3 id="读取数据库配置信息"><a href="#读取数据库配置信息" class="headerlink" title="读取数据库配置信息"></a>读取数据库配置信息</h3><p><code>@EnableConfigurationProperties(DataSourceProperties.class)</code>，该注解会将配置中的数据库信息封装到<code>DataSourceProperties.class</code>，并加载为Spring Bean。</p>
<h3 id="加载数据池"><a href="#加载数据池" class="headerlink" title="加载数据池"></a>加载数据池</h3><p><code>@Import(&#123; DataSourcePoolMetadataProvidersConfiguration.class, DataSourceCheckpointRestoreConfiguration.class &#125;)</code>通过<code>DataSourcePoolMetadataProvidersConfiguration.class</code>配置数据池。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourcePoolMetadataProvidersConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass(org.apache.tomcat.jdbc.pool.DataSource.class)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TomcatDataSourcePoolMetadataProviderConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		DataSourcePoolMetadataProvider <span class="title function_">tomcatPoolDataSourceMetadataProvider</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> (dataSource) -&gt; &#123;</span><br><span class="line">				org.apache.tomcat.jdbc.pool.<span class="type">DataSource</span> <span class="variable">tomcatDataSource</span> <span class="operator">=</span> DataSourceUnwrapper.unwrap(dataSource,</span><br><span class="line">						ConnectionPoolMBean.class, org.apache.tomcat.jdbc.pool.DataSource.class);</span><br><span class="line">				<span class="keyword">if</span> (tomcatDataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TomcatDataSourcePoolMetadata</span>(tomcatDataSource);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass(HikariDataSource.class)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">HikariPoolDataSourceMetadataProviderConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		DataSourcePoolMetadataProvider <span class="title function_">hikariPoolDataSourceMetadataProvider</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> (dataSource) -&gt; &#123;</span><br><span class="line">				<span class="type">HikariDataSource</span> <span class="variable">hikariDataSource</span> <span class="operator">=</span> DataSourceUnwrapper.unwrap(dataSource, HikariConfigMXBean.class,</span><br><span class="line">						HikariDataSource.class);</span><br><span class="line">				<span class="keyword">if</span> (hikariDataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSourcePoolMetadata</span>(hikariDataSource);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass(BasicDataSource.class)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CommonsDbcp2PoolDataSourceMetadataProviderConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		DataSourcePoolMetadataProvider <span class="title function_">commonsDbcp2PoolDataSourceMetadataProvider</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> (dataSource) -&gt; &#123;</span><br><span class="line">				<span class="type">BasicDataSource</span> <span class="variable">dbcpDataSource</span> <span class="operator">=</span> DataSourceUnwrapper.unwrap(dataSource, BasicDataSourceMXBean.class,</span><br><span class="line">						BasicDataSource.class);</span><br><span class="line">				<span class="keyword">if</span> (dbcpDataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonsDbcp2DataSourcePoolMetadata</span>(dbcpDataSource);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass(&#123; PoolDataSource.class, OracleConnection.class &#125;)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OracleUcpPoolDataSourceMetadataProviderConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		DataSourcePoolMetadataProvider <span class="title function_">oracleUcpPoolDataSourceMetadataProvider</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> (dataSource) -&gt; &#123;</span><br><span class="line">				<span class="type">PoolDataSource</span> <span class="variable">ucpDataSource</span> <span class="operator">=</span> DataSourceUnwrapper.unwrap(dataSource, PoolDataSource.class);</span><br><span class="line">				<span class="keyword">if</span> (ucpDataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OracleUcpDataSourcePoolMetadata</span>(ucpDataSource);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过源码可以得出，提供了4种数据库链接池：</p>
<p><strong>HikariCP</strong>（默认）：</p>
<ul>
<li>类：<code>com.zaxxer.hikari.HikariDataSource</code></li>
<li>依赖：<code>com.zaxxer:HikariCP</code></li>
<li>默认引入：通过 <code>spring-boot-starter-jdbc</code> 或 <code>spring-boot-starter-data-jpa</code>。</li>
</ul>
<p><strong>Tomcat JDBC</strong>：</p>
<ul>
<li>类：<code>org.apache.tomcat.jdbc.pool.DataSource</code></li>
<li>依赖：<code>org.apache.tomcat:tomcat-jdbc</code></li>
<li>使用条件：类路径中存在，且未引入 HikariCP。</li>
</ul>
<p><strong>Commons DBCP2</strong>：</p>
<ul>
<li>类：<code>org.apache.commons.dbcp2.BasicDataSource</code></li>
<li>依赖：<code>org.apache.commons:commons-dbcp2</code></li>
<li>使用条件：类路径中存在，且未引入 HikariCP 或 Tomcat JDBC。</li>
</ul>
<p><strong>OracleUcp：</strong></p>
<p>在<code>spring-boot-starter-jdbc</code>中引入了<code>HikariCP</code>，所以Mybatis会自动配置<code>HikariDataSourcePoolMetadata</code></p>
<p>可以通过配置文件指定数据池类型：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">org.apache.tomcat.jdbc.pool.DataSource</span></span><br></pre></td></tr></table></figure>

<p>并加入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zaxxer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>HikariCP<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/03/11/springboot/SpringBoot%20bean%E5%8A%A0%E8%BD%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/11/springboot/SpringBoot%20bean%E5%8A%A0%E8%BD%BD/" class="post-title-link" itemprop="url">SpringBoot Bean加载</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-11 16:29:32" itemprop="dateCreated datePublished" datetime="2025-03-11T16:29:32+08:00">2025-03-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-03-12 14:16:10" itemprop="dateModified" datetime="2025-03-12T14:16:10+08:00">2025-03-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/springboot/" itemprop="url" rel="index"><span itemprop="name">springboot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>了解Java注解原理后，可知除了内置注解(@Override等)，其他的通过元注解编写的注解需要自行编写注解处理器并让JVM加载这些处理器以用于解析注解。</p>
<p>目前为止，SpringBoot中使用了大量的注解来简化开发，如启动类的<code>@SpringBootApplication</code>，自定义bean的<code>@Configuration</code> <code>@bean</code>这些自定义注解都需要SpringBoot框架去解析。本文将通过SpringBoot加载Bean来讲解注解的处理。</p>
</blockquote>
<h1 id="SpringBoot启动时Bean的加载过程"><a href="#SpringBoot启动时Bean的加载过程" class="headerlink" title="SpringBoot启动时Bean的加载过程"></a>SpringBoot启动时Bean的加载过程</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">|--LearnApplication //启动类</span><br><span class="line">|----SpringApplication.run()</span><br><span class="line">|------refreshContext(context);</span><br><span class="line">|--------applicationContext.refresh(); //此处以ServletWebServerApplicationContext为例子</span><br><span class="line">|----------AbstractApplicationContext.refresh() //实际调用的是该抽象类的方法</span><br><span class="line">|------------invokeBeanFactoryPostProcessors(beanFactory); //本方法是扫描注解加载Bean的核心方法</span><br><span class="line">|--------------PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</span><br></pre></td></tr></table></figure>

<p>通过对SpringBoot启动流程的分析，扫描注解加载Bean类的核心方法是<code>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</code></p>
<h1 id="PostProcessorRegistrationDelegate-invokeBeanFactoryPostProcessors-详解"><a href="#PostProcessorRegistrationDelegate-invokeBeanFactoryPostProcessors-详解" class="headerlink" title="PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors()详解"></a><code>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors()</code>详解</h1><blockquote>
<p>这个方法写的是真垃圾，看它在注解中直接加入issue链接就知道它写的多乱了。</p>
</blockquote>
<p>该方法执行 <code>BeanFactoryPostProcessor</code> 及其子接口 <code>BeanDefinitionRegistryPostProcessor</code> 的关键方法。</p>
<ul>
<li><p><strong>执行 <code>BeanDefinitionRegistryPostProcessor</code></strong></p>
<ul>
<li>先执行 <code>PriorityOrdered</code> 的 <code>BeanDefinitionRegistryPostProcessor</code>（按优先级排序）</li>
<li>再执行 <code>Ordered</code> 的 <code>BeanDefinitionRegistryPostProcessor</code></li>
<li>最后执行普通的 <code>BeanDefinitionRegistryPostProcessor</code></li>
</ul>
</li>
<li><p><strong>执行 <code>BeanFactoryPostProcessor</code></strong></p>
<ul>
<li><p>先执行 <code>PriorityOrdered</code> 的 <code>BeanFactoryPostProcessor</code></p>
</li>
<li><p>再执行 <code>Ordered</code> 的 <code>BeanFactoryPostProcessor</code></p>
</li>
<li><p>最后执行普通的 <code>BeanFactoryPostProcessor</code></p>
</li>
</ul>
</li>
</ul>
<p>*注：在 Spring 中，<code>BeanFactoryPostProcessor</code> 用于 <strong>在 Bean 实例化之前</strong> 修改 <strong>BeanDefinition</strong>，而 <code>BeanDefinitionRegistryPostProcessor</code> 则 <strong>可以额外注册新的 BeanDefinition</strong>。*</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeBeanFactoryPostProcessors</span><span class="params">(</span></span><br><span class="line"><span class="params">        ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// WARNING: Although it may appear that the body of this method can be easily</span></span><br><span class="line">    <span class="comment">// refactored to avoid the use of multiple loops and multiple lists, the use</span></span><br><span class="line">    <span class="comment">// of multiple lists and multiple passes over the names of processors is</span></span><br><span class="line">    <span class="comment">// intentional. We must ensure that we honor the contracts for PriorityOrdered</span></span><br><span class="line">    <span class="comment">// and Ordered processors. Specifically, we must NOT cause processors to be</span></span><br><span class="line">    <span class="comment">// instantiated (via getBean() invocations) or registered in the ApplicationContext</span></span><br><span class="line">    <span class="comment">// in the wrong order.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Before submitting a pull request (PR) to change this method, please review the</span></span><br><span class="line">    <span class="comment">// list of all declined PRs involving changes to PostProcessorRegistrationDelegate</span></span><br><span class="line">    <span class="comment">// to ensure that your proposal does not result in a breaking change:</span></span><br><span class="line">    <span class="comment">// https://github.com/spring-projects/spring-framework/issues?q=PostProcessorRegistrationDelegate+is%3Aclosed+label%3A%22status%3A+declined%22</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span></span><br><span class="line">    Set&lt;String&gt; processedBeans = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 BeanFactory 是 BeanDefinitionRegistry，则执行 BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> BeanDefinitionRegistry registry) &#123;</span><br><span class="line">        List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		</span><br><span class="line">         <span class="comment">// 先处理方法参数传入的 BeanFactoryPostProcessors（非 Spring 扫描的）</span></span><br><span class="line">        <span class="keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;</span><br><span class="line">            <span class="keyword">if</span> (postProcessor <span class="keyword">instanceof</span> BeanDefinitionRegistryPostProcessor registryProcessor) &#123;</span><br><span class="line">                registryProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">                registryProcessors.add(registryProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                regularPostProcessors.add(postProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">        <span class="comment">// 这里会处理内置于SpringBoot的ConfigurationClassPostProcessor</span></span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 首先处理实现PriorityOrdered的BeanDefinitionRegistryPostProcessors</span></span><br><span class="line">        String[] postProcessorNames =</span><br><span class="line">                beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//排序</span></span><br><span class="line">        sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">        registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">        <span class="comment">//调用postProcessBeanDefinitionRegistry方法</span></span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">        currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 首先处理实现 Ordered 的BeanDefinitionRegistryPostProcessors</span></span><br><span class="line">        postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">        registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">        <span class="comment">//调用postProcessBeanDefinitionRegistry方法</span></span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">        currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最后 执行普通的 BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">reiterate</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (reiterate) &#123;</span><br><span class="line">            reiterate = <span class="literal">false</span>;</span><br><span class="line">            postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!processedBeans.contains(ppName)) &#123;</span><br><span class="line">                    currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                    processedBeans.add(ppName);</span><br><span class="line">                    reiterate = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">            registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">            invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">            currentRegistryProcessors.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span></span><br><span class="line">        <span class="comment">// 调用 BeanDefinitionRegistryPostProcessor 和 BeanFactoryPostProcessor 的postProcessBeanFactory()方法</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</span><br><span class="line">        invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果 BeanFactory 不是 BeanDefinitionRegistry，则直接执行普通的 BeanFactoryPostProcessor 的postProcessBeanFactory()方法</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理 Spring 容器注册的 BeanFactoryPostProcessor</span></span><br><span class="line">    String[] postProcessorNames =</span><br><span class="line">            beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span></span><br><span class="line">    <span class="comment">// Ordered, and the rest.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">        <span class="keyword">if</span> (processedBeans.contains(ppName)) &#123;</span><br><span class="line">            <span class="comment">// skip - already processed in first phase above</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">            priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            orderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">    sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;</span><br><span class="line">        orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Finally, invoke all other BeanFactoryPostProcessors.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">        nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clear cached merged bean definitions since the post-processors might have</span></span><br><span class="line">    <span class="comment">// modified the original metadata, for example, replacing placeholders in values...</span></span><br><span class="line">    beanFactory.clearMetadataCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ConfigurationClassPostProcessor"><a href="#ConfigurationClassPostProcessor" class="headerlink" title="ConfigurationClassPostProcessor"></a><code>ConfigurationClassPostProcessor</code></h1><blockquote>
<p><code>ConfigurationClassPostProcessor</code> 是 **Spring 内部关键的 <code>BeanFactoryPostProcessor</code>**，它的主要作用是 <strong>解析 <code>@Configuration</code>、<code>@ComponentScan</code>、<code>@Import</code>、<code>@Bean</code> 等注解</strong>，并将解析后的 <strong>BeanDefinition</strong> 注册到 <code>BeanFactory</code> 中。</p>
</blockquote>
<p>Spring 在 <code>invokeBeanFactoryPostProcessors()</code> 时执行所有 <code>BeanFactoryPostProcessor</code>，其中 <code>ConfigurationClassPostProcessor</code> 是 <strong>Spring 内置的 <code>BeanFactoryPostProcessor</code>，优先执行</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>通过<code>beanFactory.getBeanNamesForType()</code>来获取<code>BeanDefinitionRegistryPostProcessor.class</code>的后处理类。调试后会得到<code>postProcessorNames=org.springframework.context.annotation.internalConfigurationAnnotationProcessor</code>然后将这个名字传入<code>beanFactory.getBean()</code>并获取它的bean类型，得到的bean类就是<code>ConfigurationClassPostProcessor</code>。后续会调用该类的<code>postProcessBeanDefinitionRegistry()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">registryId</span> <span class="operator">=</span> System.identityHashCode(registry);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.registriesPostProcessed.contains(registryId)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                <span class="string">&quot;postProcessBeanDefinitionRegistry already called on this post-processor against &quot;</span> + registry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.factoriesPostProcessed.contains(registryId)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                <span class="string">&quot;postProcessBeanFactory already called on this post-processor against &quot;</span> + registry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.registriesPostProcessed.add(registryId);</span><br><span class="line"></span><br><span class="line">    processConfigBeanDefinitions(registry);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processConfigBeanDefinitions</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    List&lt;BeanDefinitionHolder&gt; configCandidates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 获取所有注册的bean类型</span></span><br><span class="line">    String[] candidateNames = registry.getBeanDefinitionNames();</span><br><span class="line">	<span class="comment">//遍历所有的bean类，寻找有@Configuration注解的类</span></span><br><span class="line">    <span class="keyword">for</span> (String beanName : candidateNames) &#123;</span><br><span class="line">        <span class="type">BeanDefinition</span> <span class="variable">beanDef</span> <span class="operator">=</span> registry.getBeanDefinition(beanName);</span><br><span class="line">        <span class="keyword">if</span> (beanDef.getAttribute(ConfigurationClassUtils.CONFIGURATION_CLASS_ATTRIBUTE) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;Bean definition has already been processed as a configuration class: &quot;</span> + beanDef);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果bean类中包含@Configuration注解则将该类加入到configCandidates List中</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, <span class="built_in">this</span>.metadataReaderFactory)) &#123;</span><br><span class="line">            configCandidates.add(<span class="keyword">new</span> <span class="title class_">BeanDefinitionHolder</span>(beanDef, beanName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return immediately if no @Configuration classes were found</span></span><br><span class="line">    <span class="keyword">if</span> (configCandidates.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据@Order排序</span></span><br><span class="line">    configCandidates.sort((bd1, bd2) -&gt; &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i1</span> <span class="operator">=</span> ConfigurationClassUtils.getOrder(bd1.getBeanDefinition());</span><br><span class="line">        <span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> ConfigurationClassUtils.getOrder(bd2.getBeanDefinition());</span><br><span class="line">        <span class="keyword">return</span> Integer.compare(i1, i2);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Detect any custom bean name generation strategy supplied through the enclosing application context</span></span><br><span class="line">    <span class="type">SingletonBeanRegistry</span> <span class="variable">singletonRegistry</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (registry <span class="keyword">instanceof</span> SingletonBeanRegistry sbr) &#123;</span><br><span class="line">        singletonRegistry = sbr;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.localBeanNameGeneratorSet) &#123;</span><br><span class="line">            <span class="type">BeanNameGenerator</span> <span class="variable">generator</span> <span class="operator">=</span> (BeanNameGenerator) singletonRegistry.getSingleton(</span><br><span class="line">                    AnnotationConfigUtils.CONFIGURATION_BEAN_NAME_GENERATOR);</span><br><span class="line">            <span class="keyword">if</span> (generator != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.componentScanBeanNameGenerator = generator;</span><br><span class="line">                <span class="built_in">this</span>.importBeanNameGenerator = generator;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.environment == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.environment = <span class="keyword">new</span> <span class="title class_">StandardEnvironment</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parse each @Configuration class</span></span><br><span class="line">    <span class="comment">// 通过ConfigurationClassParser解析@Configuration的类</span></span><br><span class="line">    <span class="type">ConfigurationClassParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigurationClassParser</span>(</span><br><span class="line">            <span class="built_in">this</span>.metadataReaderFactory, <span class="built_in">this</span>.problemReporter, <span class="built_in">this</span>.environment,</span><br><span class="line">            <span class="built_in">this</span>.resourceLoader, <span class="built_in">this</span>.componentScanBeanNameGenerator, registry);</span><br><span class="line"></span><br><span class="line">    Set&lt;BeanDefinitionHolder&gt; candidates = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(configCandidates);</span><br><span class="line">    Set&lt;ConfigurationClass&gt; alreadyParsed = CollectionUtils.newHashSet(configCandidates.size());</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="type">StartupStep</span> <span class="variable">processConfig</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.config-classes.parse&quot;</span>);</span><br><span class="line">        parser.parse(candidates);</span><br><span class="line">        parser.validate();</span><br><span class="line"></span><br><span class="line">        Set&lt;ConfigurationClass&gt; configClasses = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(parser.getConfigurationClasses());</span><br><span class="line">        configClasses.removeAll(alreadyParsed);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the model and create bean definitions based on its content</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.reader == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.reader = <span class="keyword">new</span> <span class="title class_">ConfigurationClassBeanDefinitionReader</span>(</span><br><span class="line">                    registry, <span class="built_in">this</span>.sourceExtractor, <span class="built_in">this</span>.resourceLoader, <span class="built_in">this</span>.environment,</span><br><span class="line">                    <span class="built_in">this</span>.importBeanNameGenerator, parser.getImportRegistry());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.reader.loadBeanDefinitions(configClasses);</span><br><span class="line">        alreadyParsed.addAll(configClasses);</span><br><span class="line">        processConfig.tag(<span class="string">&quot;classCount&quot;</span>, () -&gt; String.valueOf(configClasses.size())).end();</span><br><span class="line"></span><br><span class="line">        candidates.clear();</span><br><span class="line">        <span class="keyword">if</span> (registry.getBeanDefinitionCount() &gt; candidateNames.length) &#123;</span><br><span class="line">            String[] newCandidateNames = registry.getBeanDefinitionNames();</span><br><span class="line">            Set&lt;String&gt; oldCandidateNames = Set.of(candidateNames);</span><br><span class="line">            Set&lt;String&gt; alreadyParsedClasses = CollectionUtils.newHashSet(alreadyParsed.size());</span><br><span class="line">            <span class="keyword">for</span> (ConfigurationClass configurationClass : alreadyParsed) &#123;</span><br><span class="line">                alreadyParsedClasses.add(configurationClass.getMetadata().getClassName());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (String candidateName : newCandidateNames) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!oldCandidateNames.contains(candidateName)) &#123;</span><br><span class="line">                    <span class="type">BeanDefinition</span> <span class="variable">bd</span> <span class="operator">=</span> registry.getBeanDefinition(candidateName);</span><br><span class="line">                    <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, <span class="built_in">this</span>.metadataReaderFactory) &amp;&amp;</span><br><span class="line">                            !alreadyParsedClasses.contains(bd.getBeanClassName())) &#123;</span><br><span class="line">                        candidates.add(<span class="keyword">new</span> <span class="title class_">BeanDefinitionHolder</span>(bd, candidateName));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            candidateNames = newCandidateNames;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (!candidates.isEmpty());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span></span><br><span class="line">    <span class="keyword">if</span> (singletonRegistry != <span class="literal">null</span> &amp;&amp; !singletonRegistry.containsSingleton(IMPORT_REGISTRY_BEAN_NAME)) &#123;</span><br><span class="line">        singletonRegistry.registerSingleton(IMPORT_REGISTRY_BEAN_NAME, parser.getImportRegistry());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Store the PropertySourceDescriptors to contribute them Ahead-of-time if necessary</span></span><br><span class="line">    <span class="built_in">this</span>.propertySourceDescriptors = parser.getPropertySourceDescriptors();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.metadataReaderFactory <span class="keyword">instanceof</span> CachingMetadataReaderFactory cachingMetadataReaderFactory) &#123;</span><br><span class="line">        <span class="comment">// Clear cache in externally provided MetadataReaderFactory; this is a no-op</span></span><br><span class="line">        <span class="comment">// for a shared cache since it&#x27;ll be cleared by the ApplicationContext.</span></span><br><span class="line">        cachingMetadataReaderFactory.clearCache();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/03/04/springboot/SpringBoot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/04/springboot/SpringBoot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">SpringBoot启动流程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-04 00:00:38" itemprop="dateCreated datePublished" datetime="2025-03-04T00:00:38+08:00">2025-03-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-03-17 20:06:36" itemprop="dateModified" datetime="2025-03-17T20:06:36+08:00">2025-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/springboot/" itemprop="url" rel="index"><span itemprop="name">springboot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>Spring Boot 是一个开源的 Java 框架，用于简化 Spring 应用程序的开发。它是 Spring 生态系统的一部分，旨在帮助开发人员更快速和方便地创建独立、生产级的 Spring 应用。</p>
<ul>
<li><p>快速入门：Spring Boot 通过约定优于配置的原则，使开发者可以快速上手，无需繁琐的 XML 配置。</p>
</li>
<li><p>自带嵌入式服务器：Spring Boot 支持嵌入式服务器（如 Tomcat Jetty 和 Undertow），开发者无需单独部署应用服务器，可以直接运行 Java 应用。</p>
</li>
<li><p>自动配置：Spring Boot 提供了自动配置功能，根据项目的类路径和配置自动设置 Spring 应用的各种组件，减少了大量的配置工作。</p>
</li>
<li><p>生产级特性：Spring Boot 内置了许多生产环境所需的功能，如健康检查、指标监控、应用配置管理等。</p>
</li>
<li><p>开箱即用：Spring Boot 提供了一系列的 starter 依赖，简化了依赖管理。例如，spring-boot-starter-web 可以帮助快速构建基于 Spring MVC 的 web 应用。</p>
</li>
<li><p>支持微服务架构：Spring Boot 适合构建微服务应用，结合 Spring Cloud，能够实现分布式系统的开发。1.</p>
</li>
</ul>
</blockquote>
<h1 id="1-SpringBootApplication注解"><a href="#1-SpringBootApplication注解" class="headerlink" title="1.@SpringBootApplication注解"></a>1.<code>@SpringBootApplication</code>注解</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LearnApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(LearnApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpringBoot启动类中包含<code>@SpringBootApplication</code>注解和<code>SpringApplication.run(LearnApplication.class, args);</code>方法。SpringBoot的入口是main方法。本章节先讲解<code>@SpringBootApplication</code>注解。</p>
<blockquote>
<p>在 Java 中，<strong>注解（Annotation）</strong> 是一种元数据的形式，可以添加到代码中（例如类、方法、字段等），以提供额外的信息。注解本身并不直接影响代码的执行逻辑，但可以通过反射机制或编译时处理来实现特定的功能。</p>
<p>注解主要分为：</p>
<ul>
<li><p><strong>元注解</strong>：用于定义其他注解的行为  （<code>@Retention</code>,<code>@Target</code>,<code>@Documented</code>,<code>@Inherited</code>）</p>
</li>
<li><p><strong>内置注解</strong>：该类注解的执行器被内置到了Javac中，由Javac负责解析注解。（<code>@Override</code>,<code>@Deprecated</code>,<code>@SuppressWarnings</code>）</p>
</li>
<li><p><strong>自定义注解</strong>：使用元注解自定义注解，需要编写<em>注解处理器</em>来处理该类注解。自定义注解的处理取决于<code>@Retention</code>定义的阶段。</p>
<ul>
<li><p><code>RetentionPolicy.SOURCE</code>：注解仅保留在源代码中，编译后丢弃。该类注解由编译器或源码级工具在编译时处理。</p>
<p>注：内置注解也属于该类，但内置注解是嵌入到编译器中的语义分析和语法分析中，属于编译器的一部分。但该类的自定义注解的处理需要通过<strong>注解处理器（Annotation Processor）</strong>处理，在 javac 编译时，注解处理器会扫描源代码中的注解，并根据注解信息执行特定逻辑，例如生成新代码、验证规则或抛出错误，比较常用的就是Lombok的注解。</p>
</li>
<li><p><code>RetentionPolicy.CLASS</code>：注解保留在编译后的 .class 文件中，但运行时不可见。也是由<strong>注解处理器（Annotation Processor）</strong>处理。用于生成代码或验证，可用在构建工具中，一般不常用。</p>
</li>
<li><p><code>RetentionPolicy.RUNTIME</code>：注解保留到运行时，可通过反射访问。由程序在运行时通过反射动态读取和处理。比较常见的就是各种框架，如SpringBoot。</p>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>通过<code>@SpringBootApplication</code>注解的源码注释可以得出，其为一个组合注解，组合了<code>@SpringBootConfiguration</code>, <code>@EnableAutoConfiguration</code>, <code>@ComponentScan</code>。经过后面的源码分析，可以得出SpringBoot并不是直接处理<code>@SpringBootApplication</code>而是处理他的三个组合注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123; @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span></span><br><span class="line"><span class="meta">		@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@AliasFor(annotation = EnableAutoConfiguration.class)</span></span><br><span class="line">	Class&lt;?&gt;[] exclude() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@AliasFor(annotation = ComponentScan.class, attribute = &quot;basePackages&quot;)</span></span><br><span class="line">	String[] scanBasePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@AliasFor(annotation = ComponentScan.class, attribute = &quot;basePackageClasses&quot;)</span></span><br><span class="line">	Class&lt;?&gt;[] scanBasePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@AliasFor(annotation = ComponentScan.class, attribute = &quot;nameGenerator&quot;)</span></span><br><span class="line">	Class&lt;? <span class="keyword">extends</span> <span class="title class_">BeanNameGenerator</span>&gt; nameGenerator() <span class="keyword">default</span> BeanNameGenerator.class;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@AliasFor(annotation = Configuration.class)</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">proxyBeanMethods</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>@SpringBootConfiguration</code>组合了<code>@Configuration</code>，表明是一个Java配置类</li>
<li><code>@EnableAutoConfiguration</code> 组合了<code>@AutoConfigurationPackage</code>和<code>@Import(AutoConfigurationImportSelector.class)</code>用于将所有符合配置条件的 Bean 都加载到 IOC 容器中</li>
<li><code>@ComponentScan</code>指明了包搜索路径以及需要过滤的类</li>
</ul>
<h1 id="2-SpringApplication-run-LearnApplication-class-args"><a href="#2-SpringApplication-run-LearnApplication-class-args" class="headerlink" title="2.SpringApplication.run(LearnApplication.class, args);"></a>2.<code>SpringApplication.run(LearnApplication.class, args);</code></h1><p><code>SpringApplication.run(LearnApplication.class, args);</code>是整个SpringBoot的入口。查看源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(Class&lt;?&gt;[] primarySources, String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(primarySources).run(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建<code>ConfigurableApplicationContext</code>实例</li>
<li>运行该实例</li>
</ul>
<h2 id="SpringAplplication构造函数"><a href="#SpringAplplication构造函数" class="headerlink" title="SpringAplplication构造函数"></a>SpringAplplication构造函数</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">    Assert.notNull(primarySources, <span class="string">&quot;PrimarySources must not be null&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.primarySources = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(Arrays.asList(primarySources));</span><br><span class="line">    <span class="comment">//判断WEB应用的类型</span></span><br><span class="line">    <span class="built_in">this</span>.properties.setWebApplicationType(WebApplicationType.deduceFromClasspath());</span><br><span class="line">    <span class="comment">// 将类型为BootstrapRegistryInitializer的初始化类数组赋值给this.bootstrapRegistryInitializers</span></span><br><span class="line">    <span class="built_in">this</span>.bootstrapRegistryInitializers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">            getSpringFactoriesInstances(BootstrapRegistryInitializer.class));</span><br><span class="line">    <span class="comment">//将类型为ApplicationContextInitializer的初始化类数组赋值给this.initializers</span></span><br><span class="line">    setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));</span><br><span class="line">    <span class="comment">//将类型为ApplicationListener的监听类数组赋值给this.listeners</span></span><br><span class="line">    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));</span><br><span class="line">    <span class="comment">// 从调用栈中拿到main方法所在的类</span></span><br><span class="line">    <span class="built_in">this</span>.mainApplicationClass = deduceMainApplicationClass();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Class&lt;?&gt; deduceMainApplicationClass() &#123;</span><br><span class="line">    <span class="comment">//使用Java9引入的StackWalker遍历当前线程的调用栈</span></span><br><span class="line">    <span class="keyword">return</span> StackWalker.getInstance(StackWalker.Option.RETAIN_CLASS_REFERENCE)</span><br><span class="line">        <span class="comment">// 找到第一个包含main方法的类并返回它的Class&lt;?&gt;</span></span><br><span class="line">        .walk(<span class="built_in">this</span>::findMainClass)</span><br><span class="line">        <span class="comment">//找不到返回null</span></span><br><span class="line">        .orElse(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> Optional&lt;Class&lt;?&gt;&gt; findMainClass(Stream&lt;StackFrame&gt; stack) &#123;</span><br><span class="line">    <span class="keyword">return</span> stack.filter((frame) -&gt; Objects.equals(frame.getMethodName(), <span class="string">&quot;main&quot;</span>))</span><br><span class="line">        .findFirst()</span><br><span class="line">        .map(StackWalker.StackFrame::getDeclaringClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpringApplication 构造函数的参数是资源加载器和主程序源（SpringBoot启动类）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断WEB应用的类型</span></span><br><span class="line"><span class="built_in">this</span>.properties.setWebApplicationType(WebApplicationType.deduceFromClasspath());</span><br></pre></td></tr></table></figure>

<p><code>WebApplicationType</code>有三种类型：</p>
<ul>
<li><code>NONE</code>：程序不是WEB应用，不需要启动内置WEB服务器</li>
<li><code>SERVLET</code>： 程序是WEB应用，需要启动WEB服务器</li>
<li><code>REACTIVE</code>：程序是响应式WEB应用，启动REACTIVE WEB服务器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] SERVLET_INDICATOR_CLASSES = &#123; <span class="string">&quot;jakarta.servlet.Servlet&quot;</span>,</span><br><span class="line">        <span class="string">&quot;org.springframework.web.context.ConfigurableWebApplicationContext&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WEBMVC_INDICATOR_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.springframework.web.servlet.DispatcherServlet&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WEBFLUX_INDICATOR_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.springframework.web.reactive.DispatcherHandler&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JERSEY_INDICATOR_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.glassfish.jersey.servlet.ServletContainer&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> WebApplicationType <span class="title function_">deduceFromClasspath</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ClassUtils.isPresent(WEBFLUX_INDICATOR_CLASS, <span class="literal">null</span>) &amp;&amp; !ClassUtils.isPresent(WEBMVC_INDICATOR_CLASS, <span class="literal">null</span>)</span><br><span class="line">            &amp;&amp; !ClassUtils.isPresent(JERSEY_INDICATOR_CLASS, <span class="literal">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> WebApplicationType.REACTIVE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (String className : SERVLET_INDICATOR_CLASSES) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ClassUtils.isPresent(className, <span class="literal">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> WebApplicationType.NONE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> WebApplicationType.SERVLET;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>判断方法很简单，就是寻找在Classpath加载路径上有某些Class，比如有<code>DispatcherHandler</code>且没有<code>DispatcherServlet</code>和<code>ServletContainer</code>则是响应式WEB应用。如果包含<code>Servlet</code> <code>ConfigurableWebApplicationContext</code>则是Servlet WEB应用。否则就不是WEB应用。</p>
<p>下面三个赋值中都使用了<code>getSpringFactoriesInstances()</code>用于获取Spring工厂对象。即将对应的class文件加载到内存对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">getSpringFactoriesInstances</span><span class="params">(Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getSpringFactoriesInstances(type, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">getSpringFactoriesInstances</span><span class="params">(Class&lt;T&gt; type, ArgumentResolver argumentResolver)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> SpringFactoriesLoader.forDefaultResourceLocation(getClassLoader()).load(type, argumentResolver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getSpringFactoriesInstances"><a href="#getSpringFactoriesInstances" class="headerlink" title="getSpringFactoriesInstances()"></a><code>getSpringFactoriesInstances()</code></h3><blockquote>
<p>classpath 是Java的系统变量，Javac通过classpath寻找class文件或依赖包。classpath默认路径是当前目录下（<code>./</code>）以及<code>javac -cp xxx</code>指定的路径。</p>
<p>在SpringBoot中，对classpath进行了增强：</p>
<ul>
<li><p>开发模式：classpath 包含了<code>target/classes/</code>(编译前来自于<code>src/main/resources/</code>)和Maven从本地仓库中获取的依赖包（<code>~/.m2/repository/xxx.jar</code>)。此模式下Maven会解析pom.xml，并自动添加<code>~/.m2/repository/</code> 里的 JAR 到 classpath</p>
</li>
<li><p>Spring Boot Fat JAR 模式：此时SpringBoot不使用classpath，而是用 <code>LaunchedURLClassLoader</code> 来解析 <code>BOOT-INF/lib/</code> 里的 JAR。此模式下Maven会将依赖包从<code>~/.m2/repository/</code>中直接复制到<code>target/myapp-1.0.0.jar/BOOT-INF/lib/</code>中。</p>
</li>
</ul>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">target/myapp-1.0.0.jar</span><br><span class="line"> ├── BOOT-INF/classes/        <span class="comment"># 编译后的 .class 文件</span></span><br><span class="line"> ├── BOOT-INF/lib/            <span class="comment"># 所有依赖的 JAR</span></span><br><span class="line"> ├── META-INF/MANIFEST.MF     <span class="comment"># 启动信息</span></span><br><span class="line"> ├── org/springframework/...  <span class="comment"># Spring 相关类</span></span><br></pre></td></tr></table></figure>

<p>注：开发模式中，也可以不使用Maven的启动，直接使用Java命令。编译之后执行<code>java -cp target/classes:$(mvn dependency:build-classpath) com.example.MainApplication</code>，使用<code>-cp</code>参数将<code>target/classes</code>和<code>~/.m2/repository/</code>下的依赖包添加到classpath中，也可以正常启动项目。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//maven中查看依赖</span><br><span class="line">mvn dependency:tree</span><br><span class="line">//输出依赖的完整路径</span><br><span class="line">mvn dependency:build-classpath</span><br></pre></td></tr></table></figure>
</blockquote>
<p>了解了classpath工作原理，重点讲解<code>SpringFactoriesLoader.forDefaultResourceLocation(getClassLoader()).load(type, argumentResolver);</code>该类是利用<code>classloader</code>将classpath中的所有满足要求的类都加载进来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SpringFactoriesLoader <span class="title function_">forDefaultResourceLocation</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> forResourceLocation(FACTORIES_RESOURCE_LOCATION, classLoader);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SpringFactoriesLoader <span class="title function_">forResourceLocation</span><span class="params">(String resourceLocation, <span class="meta">@Nullable</span> ClassLoader classLoader)</span> &#123;</span><br><span class="line">    Assert.hasText(resourceLocation, <span class="string">&quot;&#x27;resourceLocation&#x27; must not be empty&quot;</span>);</span><br><span class="line">    <span class="comment">//获取classloader</span></span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">resourceClassLoader</span> <span class="operator">=</span> (classLoader != <span class="literal">null</span> ? classLoader :</span><br><span class="line">            SpringFactoriesLoader.class.getClassLoader());</span><br><span class="line">    <span class="comment">//从缓存中查看该classloader是否存在，如果没有创建一个cache[classloader]=hashmap&lt;string, SpringFactoriesLoader&gt; </span></span><br><span class="line">    <span class="comment">//并将该hashmap返回给loaders</span></span><br><span class="line">    Map&lt;String, SpringFactoriesLoader&gt; loaders = cache.computeIfAbsent(</span><br><span class="line">            resourceClassLoader, key -&gt; <span class="keyword">new</span> <span class="title class_">ConcurrentReferenceHashMap</span>&lt;&gt;());</span><br><span class="line">    <span class="comment">//获取loaders[&quot;META-INF/spring.factories&quot;]，如果不存在，创建一个新的SpringFactoriesLoader</span></span><br><span class="line">    <span class="comment">//参数1:classloader</span></span><br><span class="line">    <span class="comment">//参数2:factories : Map&lt;String, List&lt;String&gt;&gt;</span></span><br><span class="line">    <span class="keyword">return</span> loaders.computeIfAbsent(resourceLocation, key -&gt;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SpringFactoriesLoader</span>(classLoader, loadFactoriesResource(resourceClassLoader, resourceLocation)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>FACTORIES_RESOURCE_LOCATION = &quot;META-INF/spring.factories&quot;</code>，ClassLoader是默认的类加载器 <code>Thread.currentThread().getContextClassLoader();</code> 通过调试<code>classloader = ClassLoaders$AppClassLoader</code></p>
<p><code>loadFactoriesResource()</code>会将符合条件的类加载进来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//classloader = ClassLoaders$AppClassLoader</span></span><br><span class="line"><span class="comment">//resourceLocation = &quot;META-INF/spring.factories&quot;</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">loadFactoriesResource</span><span class="params">(ClassLoader classLoader, String resourceLocation)</span> &#123;</span><br><span class="line">    	<span class="comment">//result中包含[初始化类型，对应需要加载的所有初始化类]</span></span><br><span class="line">		Map&lt;String, List&lt;String&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//classLoader将classpath路径下的所有的resourceLocation文件都加载到urls中</span></span><br><span class="line">            <span class="comment">//urls中包含了所有META-INF/spring.factories的文件路径</span></span><br><span class="line">			Enumeration&lt;URL&gt; urls = classLoader.getResources(resourceLocation);</span><br><span class="line">			<span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">                <span class="comment">//根据urls中的文件路径加载到UrlResource中</span></span><br><span class="line">                <span class="comment">//举个例子 resource=jar:file:/home/amber/.m2/repository/org/springframework/boot/spring-boot/3.4.3/spring-boot-3.4.3.jar!/META-INF/spring.factories</span></span><br><span class="line">				<span class="type">UrlResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlResource</span>(urls.nextElement());</span><br><span class="line">                <span class="comment">//将文件中的所有属性加载到properties中</span></span><br><span class="line">                <span class="comment">//Properties 是一个 ConcurrentHashMap&lt;Object, Object&gt;</span></span><br><span class="line">				<span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">                <span class="comment">//遍历所有属性</span></span><br><span class="line">				properties.forEach((name, value) -&gt; &#123;</span><br><span class="line">                    <span class="comment">//以逗号分割，将value字符串分割为String[]数组</span></span><br><span class="line">					String[] factoryImplementationNames = StringUtils.commaDelimitedListToStringArray((String) value);</span><br><span class="line">                    <span class="comment">//将&#123;name: ArrayList&lt;String&gt;&#123;&#125;&#125;放入到result中,ArrayList的长度就是value数组的长度</span></span><br><span class="line">					List&lt;String&gt; implementations = result.computeIfAbsent(((String) name).trim(),</span><br><span class="line">							key -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(factoryImplementationNames.length));</span><br><span class="line">                    <span class="comment">//将factoryImplementationNames流化，将每一个元素都trim后再将每一个元素添加到implementations中</span></span><br><span class="line">					Arrays.stream(factoryImplementationNames).map(String::trim).forEach(implementations::add);</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">//对每一种初始化类型中的所有初始化类去重</span></span><br><span class="line">			result.replaceAll(SpringFactoriesLoader::toDistinctUnmodifiableList);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unable to load factories from location [&quot;</span> + resourceLocation + <span class="string">&quot;]&quot;</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">    	<span class="comment">//返回一个不可以修改的Map，最终赋值给了SpringFactoriesLoader.factories</span></span><br><span class="line">		<span class="keyword">return</span> Collections.unmodifiableMap(result);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file:/home/amber/.m2/repository/org/springframework/boot/spring-boot/3.4.3/spring-boot-3.4.3.jar!/META-INF/spring.factories</span></span><br><span class="line"><span class="comment"># Logging Systems</span></span><br><span class="line"><span class="attr">org.springframework.boot.logging.LoggingSystemFactory</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.boot.logging.logback.LogbackLoggingSystem.Factory,\</span></span><br><span class="line"><span class="string">org.springframework.boot.logging.log4j2.Log4J2LoggingSystem.Factory,\</span></span><br><span class="line"><span class="string">org.springframework.boot.logging.java.JavaLoggingSystem.Factory</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># PropertySource Loaders</span></span><br><span class="line"><span class="attr">org.springframework.boot.env.PropertySourceLoader</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.boot.env.PropertiesPropertySourceLoader,\</span></span><br><span class="line"><span class="string">org.springframework.boot.env.YamlPropertySourceLoader</span></span><br><span class="line"><span class="attr">.....</span></span><br></pre></td></tr></table></figure>

<p>到目前已经通过<code>SpringFactoriesLoader.forDefaultResourceLocation(getClassLoader())</code>得到了<code>SpringFactoriesLoader</code>对象，其中包含了<code>SpringFactoriesLoader.classLoader</code>,<code>SpringFactoriesLoader.factories</code>。后续调用了该对象的<code>load(type, argumentResolver)</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">load</span><span class="params">(Class&lt;T&gt; factoryType, <span class="meta">@Nullable</span> FailureHandler failureHandler)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> load(factoryType, <span class="literal">null</span>, failureHandler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">load</span><span class="params">(Class&lt;T&gt; factoryType, <span class="meta">@Nullable</span> ArgumentResolver argumentResolver,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> FailureHandler failureHandler)</span> &#123;</span><br><span class="line"></span><br><span class="line">    Assert.notNull(factoryType, <span class="string">&quot;&#x27;factoryType&#x27; must not be null&quot;</span>);</span><br><span class="line">    <span class="comment">//构造函数中已经把&#123;初始化类型：[对应类型的实现类数组]&#125;放入到factories中</span></span><br><span class="line">    <span class="comment">//取出初始化类型为factoryType的类数组</span></span><br><span class="line">    List&lt;String&gt; implementationNames = loadFactoryNames(factoryType);</span><br><span class="line">    logger.trace(LogMessage.format(<span class="string">&quot;Loaded [%s] names: %s&quot;</span>, factoryType.getName(), implementationNames));</span><br><span class="line">    <span class="comment">//结果是一个类型为T的列表</span></span><br><span class="line">    List&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(implementationNames.size());</span><br><span class="line">    <span class="type">FailureHandler</span> <span class="variable">failureHandlerToUse</span> <span class="operator">=</span> (failureHandler != <span class="literal">null</span>) ? failureHandler : THROWING_FAILURE_HANDLER;</span><br><span class="line">    <span class="comment">//遍历所有的实现类</span></span><br><span class="line">    <span class="keyword">for</span> (String implementationName : implementationNames) &#123;</span><br><span class="line">        <span class="comment">//将实现类实例化</span></span><br><span class="line">        <span class="type">T</span> <span class="variable">factory</span> <span class="operator">=</span> instantiateFactory(implementationName, factoryType, argumentResolver, failureHandlerToUse);</span><br><span class="line">        <span class="comment">//将实例化的实现类放入到result中</span></span><br><span class="line">        <span class="keyword">if</span> (factory != <span class="literal">null</span>) &#123;</span><br><span class="line">            result.add(factory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据@Order @Priority对实现类进行排序</span></span><br><span class="line">    AnnotationAwareOrderComparator.sort(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;String&gt; <span class="title function_">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryType)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.factories.getOrDefault(factoryType.getName(), Collections.emptyList());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">instantiateFactory</span><span class="params">(String implementationName, Class&lt;T&gt; type,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> ArgumentResolver argumentResolver, FailureHandler failureHandler)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//使用class.forName(xxx, false, zzz)将xxx类加载到元数据区，只类加载不执行类初始化</span></span><br><span class="line">        Class&lt;?&gt; factoryImplementationClass = ClassUtils.forName(implementationName, <span class="built_in">this</span>.classLoader);</span><br><span class="line">        Assert.isTrue(type.isAssignableFrom(factoryImplementationClass), () -&gt;</span><br><span class="line">                <span class="string">&quot;Class [%s] is not assignable to factory type [%s]&quot;</span>.formatted(implementationName, type.getName()));</span><br><span class="line">        <span class="comment">//创建一个用于初始化factoryImplementationClass类的内部创建类（该类包含了factoryImplementationClass的构造方法）</span></span><br><span class="line">        FactoryInstantiator&lt;T&gt; factoryInstantiator = FactoryInstantiator.forClass(factoryImplementationClass);</span><br><span class="line">        <span class="comment">// 处理构造函数所需的参数，使用this.constructor.newInstance(args)创建factoryImplementationClass类</span></span><br><span class="line">        <span class="keyword">return</span> factoryInstantiator.instantiate(argumentResolver);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        failureHandler.handleFailure(type, implementationName, ex);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到目前为止，得出了<code>getSpringFactoriesInstances(xxx.class)</code>方法是将初始化类型为xxx.class的类从<code>META-INF/spring.factories</code>中提取出来，并返回该类型的所有的实现类，返回的是一个xxx.class类型的数组。</p>
<p><code>ConfigurableApplicationContext</code>后续的三个赋值都是利用<code>getSpringFactoriesInstances(xxx.class)</code>将初始化类数组赋值给类成员，最后一步是从调用栈中获取main方法所在的类。</p>
<h1 id="2-执行SpringApplication的run方法"><a href="#2-执行SpringApplication的run方法" class="headerlink" title="2. 执行SpringApplication的run方法"></a>2. 执行<code>SpringApplication</code>的run方法</h1><p><code>SpringApplication</code>构造函数中都是一些赋值操作，run方法才是真正启动SpringBoot项目。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(String... args)</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化启动时钟</span></span><br><span class="line">    <span class="type">Startup</span> <span class="variable">startup</span> <span class="operator">=</span> Startup.create();</span><br><span class="line">    <span class="comment">// 检查properties中是否注册关闭钩子</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isRegisterShutdownHook()) &#123;</span><br><span class="line">        <span class="comment">//启 Shutdown Hook注册机制，保证Spring Boot应用在JVM关闭时能够正确释放资源（如数据库连接池、线程池等）。</span></span><br><span class="line">        SpringApplication.shutdownHook.enableShutdownHookAddition();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建引导上下文</span></span><br><span class="line">    <span class="type">DefaultBootstrapContext</span> <span class="variable">bootstrapContext</span> <span class="operator">=</span> createBootstrapContext();</span><br><span class="line">    <span class="comment">// 创建应用上下文</span></span><br><span class="line">    <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 将环境变量中java.awt.headless设置为原值或者默认true</span></span><br><span class="line">    configureHeadlessProperty();</span><br><span class="line">    <span class="comment">// 用getSpringFactoriesInstances()方法获取了所有类型为</span></span><br><span class="line">    <span class="comment">// SpringApplicationRunListener.class的启动监听类，</span></span><br><span class="line">    <span class="comment">// 将其封装在SpringApplicationRunListeners类中</span></span><br><span class="line">    <span class="type">SpringApplicationRunListeners</span> <span class="variable">listeners</span> <span class="operator">=</span> getRunListeners(args);</span><br><span class="line">    <span class="comment">// 将bootstrapContext传递给所有的启动监听类</span></span><br><span class="line">    listeners.starting(bootstrapContext, <span class="built_in">this</span>.mainApplicationClass);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 解析命令行传入的参数，并封装到ApplicationArguments</span></span><br><span class="line">        <span class="type">ApplicationArguments</span> <span class="variable">applicationArguments</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultApplicationArguments</span>(args);</span><br><span class="line">        <span class="comment">// 准备环境</span></span><br><span class="line">        <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> prepareEnvironment(listeners, bootstrapContext, applicationArguments);</span><br><span class="line">        <span class="comment">// 打印Banner 根据条件 判断打印到log还是console，是使用默认值还是指定banner</span></span><br><span class="line">        <span class="type">Banner</span> <span class="variable">printedBanner</span> <span class="operator">=</span> printBanner(environment);</span><br><span class="line">        <span class="comment">// 根据WebApplicationType创建 应用程序上下文</span></span><br><span class="line">        <span class="comment">// 获取META-INF/spring.factories中的ApplicationContextFactory接口实现类</span></span><br><span class="line">        <span class="comment">// ReactiveWebServerApplicationContextFactory 创建了 ReactiveWebServerApplicationContext</span></span><br><span class="line">        <span class="comment">// ServletWebServerApplicationContextFactory 创建了 ServletWebServerApplicationContext</span></span><br><span class="line">        context = createApplicationContext();</span><br><span class="line">        <span class="comment">// 将applicationStartup赋值给context</span></span><br><span class="line">        <span class="comment">// applicationStartup 用于收集和分析应用的启动性能数据，帮助开发者优化 Spring Boot 启动过程</span></span><br><span class="line">        context.setApplicationStartup(<span class="built_in">this</span>.applicationStartup);</span><br><span class="line">        <span class="comment">// 准备 应用程序上下文</span></span><br><span class="line">        <span class="comment">// 将参数绑定到应用程序上下文（ApplicationContext）为应用程序启动运行做好准备</span></span><br><span class="line">        prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">        <span class="comment">// 启动 应用上下文 （SpringBoot核心启动方法）</span></span><br><span class="line">        refreshContext(context);</span><br><span class="line">        <span class="comment">// 刷新之后需要的处理，默认是空</span></span><br><span class="line">        afterRefresh(context, applicationArguments);</span><br><span class="line">        <span class="comment">//SpringBoot启动</span></span><br><span class="line">        startup.started();</span><br><span class="line">        <span class="comment">//日志	</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isLogStartupInfo()) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">StartupInfoLogger</span>(<span class="built_in">this</span>.mainApplicationClass, environment).logStarted(getApplicationLog(), startup);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将ConfigurableApplicationContext传递给所有的启动监听类，表明started</span></span><br><span class="line">        listeners.started(context, startup.timeTakenToStarted());</span><br><span class="line">        callRunners(context, applicationArguments);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> handleRunFailure(context, ex, listeners);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (context.isRunning()) &#123;</span><br><span class="line">            listeners.ready(context, startup.ready());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> handleRunFailure(context, ex, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建引导程序上下文createBootstrapContext"><a href="#创建引导程序上下文createBootstrapContext" class="headerlink" title="创建引导程序上下文createBootstrapContext()"></a>创建引导程序上下文<code>createBootstrapContext()</code></h2><p>引导程序上下文的作用：<strong>在 <code>SpringApplication</code> 启动过程中，提前注册某些组件，以便在应用上下文（<code>ApplicationContext</code>）正式创建时使用</strong>。</p>
<p><code>DefaultBootstrapContext</code> 存在的时间非常短，它只在 <code>SpringApplication.run()</code> 方法执行的早期阶段存在，等 <code>ApplicationContext</code> 初始化完成后，它就会被丢弃。</p>
<p>引导上下文主要用于支持 <strong>Spring Cloud</strong> 的配置加载机制（例如 Spring Cloud Config）。它并不是 Spring Boot 核心的一部分，而是 Spring Cloud 提供的高级功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DefaultBootstrapContext</span> <span class="variable">bootstrapContext</span> <span class="operator">=</span> createBootstrapContext();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> DefaultBootstrapContext <span class="title function_">createBootstrapContext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 创建引导上下文</span></span><br><span class="line">    <span class="type">DefaultBootstrapContext</span> <span class="variable">bootstrapContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultBootstrapContext</span>();</span><br><span class="line">    <span class="comment">// 构造函数中已经将BootstrapRegistryInitializer类型的初始化类型数组赋值给了this.bootstrapRegistryInitializers</span></span><br><span class="line">    <span class="comment">// 遍历初始化类型数组，并执行每一个初始化类型的initialize方法，将引导上下文DefaultBootstrapContext赋值给它</span></span><br><span class="line">    <span class="built_in">this</span>.bootstrapRegistryInitializers.forEach((initializer) -&gt; initializer.initialize(bootstrapContext));</span><br><span class="line">    <span class="keyword">return</span> bootstrapContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="监听类SpringApplicationRunListeners"><a href="#监听类SpringApplicationRunListeners" class="headerlink" title="监听类SpringApplicationRunListeners"></a>监听类<code>SpringApplicationRunListeners</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SpringApplicationRunListeners <span class="title function_">getRunListeners</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ArgumentResolver</span> <span class="variable">argumentResolver</span> <span class="operator">=</span> ArgumentResolver.of(SpringApplication.class, <span class="built_in">this</span>);</span><br><span class="line">    argumentResolver = argumentResolver.and(String[].class, args);</span><br><span class="line">    <span class="comment">// 通过getSpringFactoriesInstances()获取所有接口为SpringApplicationRunListener.class的实现类</span></span><br><span class="line">    List&lt;SpringApplicationRunListener&gt; listeners = getSpringFactoriesInstances(SpringApplicationRunListener.class,</span><br><span class="line">            argumentResolver);</span><br><span class="line">    <span class="type">SpringApplicationHook</span> <span class="variable">hook</span> <span class="operator">=</span> applicationHook.get();</span><br><span class="line">    <span class="type">SpringApplicationRunListener</span> <span class="variable">hookListener</span> <span class="operator">=</span> (hook != <span class="literal">null</span>) ? hook.getRunListener(<span class="built_in">this</span>) : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (hookListener != <span class="literal">null</span>) &#123;</span><br><span class="line">        listeners = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(listeners);</span><br><span class="line">        listeners.add(hookListener);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将监听类List和applicationStartup传递給SpringApplicationRunListeners</span></span><br><span class="line">    <span class="comment">// 其中this.applicationStartup是一个性能分析工具，默认状态下，它什么都没做，是一个空实现。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringApplicationRunListeners</span>(logger, listeners, <span class="built_in">this</span>.applicationStartup);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如<code>starting()</code>方法赋值监听名称为<code>&quot;spring.boot.application.starting&quot;</code>并将bootstrapContext通过<code>listener.starting()</code>赋值给每一个监听类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SpringApplicationRunListeners</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Log log;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;SpringApplicationRunListener&gt; listeners;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ApplicationStartup applicationStartup;</span><br><span class="line"></span><br><span class="line">	SpringApplicationRunListeners(Log log, List&lt;SpringApplicationRunListener&gt; listeners,</span><br><span class="line">			ApplicationStartup applicationStartup) &#123;</span><br><span class="line">		<span class="built_in">this</span>.log = log;</span><br><span class="line">		<span class="built_in">this</span>.listeners = List.copyOf(listeners);</span><br><span class="line">		<span class="built_in">this</span>.applicationStartup = applicationStartup;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">starting</span><span class="params">(ConfigurableBootstrapContext bootstrapContext, Class&lt;?&gt; mainApplicationClass)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.starting&quot;</span>, (listener) -&gt; listener.starting(bootstrapContext),</span><br><span class="line">				(step) -&gt; &#123;</span><br><span class="line">					<span class="keyword">if</span> (mainApplicationClass != <span class="literal">null</span>) &#123;</span><br><span class="line">						step.tag(<span class="string">&quot;mainApplicationClass&quot;</span>, mainApplicationClass.getName());</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">environmentPrepared</span><span class="params">(ConfigurableBootstrapContext bootstrapContext, ConfigurableEnvironment environment)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.environment-prepared&quot;</span>,</span><br><span class="line">				(listener) -&gt; listener.environmentPrepared(bootstrapContext, environment));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">contextPrepared</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.context-prepared&quot;</span>, (listener) -&gt; listener.contextPrepared(context));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">contextLoaded</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.context-loaded&quot;</span>, (listener) -&gt; listener.contextLoaded(context));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">started</span><span class="params">(ConfigurableApplicationContext context, Duration timeTaken)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.started&quot;</span>, (listener) -&gt; listener.started(context, timeTaken));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">ready</span><span class="params">(ConfigurableApplicationContext context, Duration timeTaken)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.ready&quot;</span>, (listener) -&gt; listener.ready(context, timeTaken));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(ConfigurableApplicationContext context, Throwable exception)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.failed&quot;</span>,</span><br><span class="line">				(listener) -&gt; callFailedListener(listener, context, exception), (step) -&gt; &#123;</span><br><span class="line">					step.tag(<span class="string">&quot;exception&quot;</span>, exception.getClass().toString());</span><br><span class="line">					step.tag(<span class="string">&quot;message&quot;</span>, exception.getMessage());</span><br><span class="line">				&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">callFailedListener</span><span class="params">(SpringApplicationRunListener listener, ConfigurableApplicationContext context,</span></span><br><span class="line"><span class="params">			Throwable exception)</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			listener.failed(context, exception);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">			<span class="keyword">if</span> (exception == <span class="literal">null</span>) &#123;</span><br><span class="line">				ReflectionUtils.rethrowRuntimeException(ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.log.isDebugEnabled()) &#123;</span><br><span class="line">				<span class="built_in">this</span>.log.error(<span class="string">&quot;Error handling failed&quot;</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> ex.getMessage();</span><br><span class="line">				message = (message != <span class="literal">null</span>) ? message : <span class="string">&quot;no error message&quot;</span>;</span><br><span class="line">				<span class="built_in">this</span>.log.warn(<span class="string">&quot;Error handling failed (&quot;</span> + message + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doWithListeners</span><span class="params">(String stepName, Consumer&lt;SpringApplicationRunListener&gt; listenerAction)</span> &#123;</span><br><span class="line">		doWithListeners(stepName, listenerAction, <span class="literal">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//每一个方法都调用了doWithListeners()</span></span><br><span class="line">    <span class="comment">//参数1：步骤名称</span></span><br><span class="line">    <span class="comment">//参数2：消费型函数式接口，它可以接收一个 SpringApplicationRunListener 对象，并对其执行某些操作。</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doWithListeners</span><span class="params">(String stepName, Consumer&lt;SpringApplicationRunListener&gt; listenerAction,</span></span><br><span class="line"><span class="params">			Consumer&lt;StartupStep&gt; stepAction)</span> &#123;</span><br><span class="line">        <span class="comment">// 性能监听，默认是空函数</span></span><br><span class="line">		<span class="type">StartupStep</span> <span class="variable">step</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(stepName);</span><br><span class="line">        <span class="comment">// listeners是SpringApplicationRunListener对象的List</span></span><br><span class="line">        <span class="comment">// 对listeners中的每一个SpringApplicationRunListener对象执行listenerAction方法。</span></span><br><span class="line">		<span class="built_in">this</span>.listeners.forEach(listenerAction);</span><br><span class="line">		<span class="keyword">if</span> (stepAction != <span class="literal">null</span>) &#123;</span><br><span class="line">			stepAction.accept(step);</span><br><span class="line">		&#125;</span><br><span class="line">		step.end();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="准备环境-prepareEnvironment"><a href="#准备环境-prepareEnvironment" class="headerlink" title="准备环境 prepareEnvironment()"></a>准备环境 <code>prepareEnvironment()</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ConfigurableEnvironment <span class="title function_">prepareEnvironment</span><span class="params">(SpringApplicationRunListeners listeners,</span></span><br><span class="line"><span class="params">        DefaultBootstrapContext bootstrapContext, ApplicationArguments applicationArguments)</span> &#123;</span><br><span class="line">    <span class="comment">// Create and configure the environment</span></span><br><span class="line">    <span class="comment">// 根据应用类型创建对应的环境类</span></span><br><span class="line">    <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> getOrCreateEnvironment();</span><br><span class="line">    <span class="comment">// 将命令行的参数添加到Springboot环境变量中</span></span><br><span class="line">    <span class="comment">// 配置spring.profiles.active</span></span><br><span class="line">    configureEnvironment(environment, applicationArguments.getSourceArgs());</span><br><span class="line">    <span class="comment">// 将 ConfigurationPropertySources 附加到 Environment，让 Spring Environment 识别 ConfigurationPropertySource</span></span><br><span class="line">    ConfigurationPropertySources.attach(environment);</span><br><span class="line">    <span class="comment">// 告诉所有的监听类，环境准备阶段</span></span><br><span class="line">    listeners.environmentPrepared(bootstrapContext, environment);</span><br><span class="line">    ApplicationInfoPropertySource.moveToEnd(environment);</span><br><span class="line">    DefaultPropertiesPropertySource.moveToEnd(environment);</span><br><span class="line">    Assert.state(!environment.containsProperty(<span class="string">&quot;spring.main.environment-prefix&quot;</span>),</span><br><span class="line">            <span class="string">&quot;Environment prefix cannot be set via properties.&quot;</span>);</span><br><span class="line">    bindToSpringApplication(environment);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.isCustomEnvironment) &#123;</span><br><span class="line">        <span class="type">EnvironmentConverter</span> <span class="variable">environmentConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EnvironmentConverter</span>(getClassLoader());</span><br><span class="line">        environment = environmentConverter.convertEnvironmentIfNecessary(environment, deduceEnvironmentClass());</span><br><span class="line">    &#125;</span><br><span class="line">    ConfigurationPropertySources.attach(environment);</span><br><span class="line">    <span class="keyword">return</span> environment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ConfigurableEnvironment <span class="title function_">getOrCreateEnvironment</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.environment != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.environment;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在构造函数中已经赋值，此时拿出webapplication的类型</span></span><br><span class="line">    <span class="type">WebApplicationType</span> <span class="variable">webApplicationType</span> <span class="operator">=</span> <span class="built_in">this</span>.properties.getWebApplicationType();</span><br><span class="line">    <span class="comment">// 根据不同的webapplication类型创建不同的ConfigurableEnvironment</span></span><br><span class="line">    <span class="comment">// DefaultApplicationContextFactory</span></span><br><span class="line">    <span class="comment">// ServletWebServerApplicationContextFactory</span></span><br><span class="line">    <span class="comment">// ReactiveWebServerApplicationContextFactory</span></span><br><span class="line">    <span class="comment">// 会从META/spring.factories中获取ApplicationContextFactory并根据webApplicationType选取对应的类</span></span><br><span class="line">    <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationContextFactory.createEnvironment(webApplicationType);</span><br><span class="line">    <span class="keyword">if</span> (environment == <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.applicationContextFactory != ApplicationContextFactory.DEFAULT) &#123;</span><br><span class="line">        environment = ApplicationContextFactory.DEFAULT.createEnvironment(webApplicationType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (environment != <span class="literal">null</span>) ? environment : <span class="keyword">new</span> <span class="title class_">ApplicationEnvironment</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="准备应用上下文-prepareContext"><a href="#准备应用上下文-prepareContext" class="headerlink" title="准备应用上下文 prepareContext()"></a>准备应用上下文 <code>prepareContext()</code></h2><p>将参数绑定到应用程序上下文（ApplicationContext），为应用程序启动运行做好准备。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">prepareContext</span><span class="params">(DefaultBootstrapContext bootstrapContext, ConfigurableApplicationContext context,</span></span><br><span class="line"><span class="params">        ConfigurableEnvironment environment, SpringApplicationRunListeners listeners,</span></span><br><span class="line"><span class="params">        ApplicationArguments applicationArguments, Banner printedBanner)</span> &#123;</span><br><span class="line">    <span class="comment">// environment赋值给context</span></span><br><span class="line">    context.setEnvironment(environment);</span><br><span class="line">    postProcessApplicationContext(context);</span><br><span class="line">    addAotGeneratedInitializerIfNecessary(<span class="built_in">this</span>.initializers);</span><br><span class="line">    applyInitializers(context);</span><br><span class="line">    <span class="comment">//触发所有SpringApplicationRunListerner监听器的contextPrepared</span></span><br><span class="line">    listeners.contextPrepared(context);</span><br><span class="line">    <span class="comment">// 发送事件 当 bootstrapContext关闭且ApplicationContext准备好后发送该事件</span></span><br><span class="line">    bootstrapContext.close(context);</span><br><span class="line">    <span class="comment">//日志处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isLogStartupInfo()) &#123;</span><br><span class="line">        logStartupInfo(context.getParent() == <span class="literal">null</span>);</span><br><span class="line">        logStartupInfo(context);</span><br><span class="line">        logStartupProfileInfo(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Add boot specific singleton beans</span></span><br><span class="line">    <span class="comment">// 通过 应用上下文 获取BeanFactory</span></span><br><span class="line">    <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> context.getBeanFactory();</span><br><span class="line">    <span class="comment">// 通过 BeanFactory 注册单例对象 springApplicationArguments</span></span><br><span class="line">    beanFactory.registerSingleton(<span class="string">&quot;springApplicationArguments&quot;</span>, applicationArguments);</span><br><span class="line">    <span class="keyword">if</span> (printedBanner != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 通过 BeanFactory 注册单例对象 springBootBanner</span></span><br><span class="line">        beanFactory.registerSingleton(<span class="string">&quot;springBootBanner&quot;</span>, printedBanner);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> AbstractAutowireCapableBeanFactory autowireCapableBeanFactory) &#123;</span><br><span class="line">        autowireCapableBeanFactory.setAllowCircularReferences(<span class="built_in">this</span>.properties.isAllowCircularReferences());</span><br><span class="line">        <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> DefaultListableBeanFactory listableBeanFactory) &#123;</span><br><span class="line">            listableBeanFactory.setAllowBeanDefinitionOverriding(<span class="built_in">this</span>.properties.isAllowBeanDefinitionOverriding());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 懒加载 给应用上下文添加懒加载BeanFactory处理类</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isLazyInitialization()) &#123;</span><br><span class="line">        context.addBeanFactoryPostProcessor(<span class="keyword">new</span> <span class="title class_">LazyInitializationBeanFactoryPostProcessor</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isKeepAlive()) &#123;</span><br><span class="line">        context.addApplicationListener(<span class="keyword">new</span> <span class="title class_">KeepAlive</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    context.addBeanFactoryPostProcessor(<span class="keyword">new</span> <span class="title class_">PropertySourceOrderingBeanFactoryPostProcessor</span>(context));</span><br><span class="line">    <span class="keyword">if</span> (!AotDetector.useGeneratedArtifacts()) &#123;</span><br><span class="line">        <span class="comment">// Load the sources</span></span><br><span class="line">        Set&lt;Object&gt; sources = getAllSources();</span><br><span class="line">        Assert.notEmpty(sources, <span class="string">&quot;Sources must not be empty&quot;</span>);</span><br><span class="line">        load(context, sources.toArray(<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//触发所有SpringApplicationRunListerner监听器的contextLoaded</span></span><br><span class="line">    listeners.contextLoaded(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="启动应用上下文refreshContext"><a href="#启动应用上下文refreshContext" class="headerlink" title="启动应用上下文refreshContext()"></a>启动应用上下文<code>refreshContext()</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshContext</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isRegisterShutdownHook()) &#123;</span><br><span class="line">        shutdownHook.registerApplicationContext(context);</span><br><span class="line">    &#125;</span><br><span class="line">    refresh(context);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">(ConfigurableApplicationContext applicationContext)</span> &#123;</span><br><span class="line">    applicationContext.refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>applicationContext</code>有两种类：</p>
<ul>
<li><p><code>ReactiveWebServerApplicationContext</code></p>
</li>
<li><p><code>ServletWebServerApplicationContext</code></p>
</li>
</ul>
<p>他们的共同抽象父类<code>AbstractApplicationContext</code>，主要的refresh()方法也是在这个抽象父类中定义的。</p>
<p><code>refresh()</code> 是 Spring 容器启动的核心方法，负责加载 Bean、初始化 BeanFactory、注册监听器、完成 Bean 初始化，并最终发布 <code>ContextRefreshedEvent</code> 事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">    <span class="built_in">this</span>.startupShutdownLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.startupShutdownThread = Thread.currentThread();</span><br><span class="line"></span><br><span class="line">        <span class="type">StartupStep</span> <span class="variable">contextRefresh</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.refresh&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">        <span class="comment">// 检查SpringBoot中的环境变量</span></span><br><span class="line">        prepareRefresh();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line">        <span class="comment">// 从子类中获取beanfactory，默认是ConfigurableListableBeanFactory</span></span><br><span class="line">        <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">        <span class="comment">//为 ConfigurableListableBeanFactory配置一些基础设置和功能，以确保它能够正确地创建和管理 Bean</span></span><br><span class="line">        prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">            <span class="comment">// 允许子类对beanFactory中的bean在初始化之前修改bean</span></span><br><span class="line">            postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="type">StartupStep</span> <span class="variable">beanPostProcess</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.beans.post-process&quot;</span>);</span><br><span class="line">            <span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">            <span class="comment">// 处理注解的主要方法</span></span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line">            <span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">            <span class="comment">// 注册BeanPostProcessors的bean类</span></span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line">            beanPostProcess.end();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize message source for this context.</span></span><br><span class="line">            <span class="comment">// 添加消息bean</span></span><br><span class="line">            initMessageSource();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">            <span class="comment">// 添加事件传播bean</span></span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">            <span class="comment">// 处理子类的刷新，如Servlet的启动Tomcat</span></span><br><span class="line">            onRefresh();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">            <span class="comment">// 注册监听bean</span></span><br><span class="line">            registerListeners();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">            <span class="comment">// 初始化所有的 单例bean</span></span><br><span class="line">            <span class="comment">// 并将bean锁住</span></span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">            finishRefresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">catch</span> (RuntimeException | Error ex ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">            destroyBeans();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">            cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Propagate exception to caller.</span></span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            contextRefresh.end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.startupShutdownThread = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.startupShutdownLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">    <span class="comment">// Tell the internal bean factory to use the context&#x27;s class loader etc.</span></span><br><span class="line">    <span class="comment">// 为 BeanFactory 设置当前的类加载器,以便在加载 Bean 定义时使用</span></span><br><span class="line">    beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line">    <span class="comment">// 用于支持 Spring 表达式语言（SpEL），例如在 @Value 注解中解析表达式。</span></span><br><span class="line">    beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> <span class="title class_">StandardBeanExpressionResolver</span>(beanFactory.getBeanClassLoader()));</span><br><span class="line">    <span class="comment">// 用于处理资源（如 Resource 类型）的注入和解析</span></span><br><span class="line">    beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> <span class="title class_">ResourceEditorRegistrar</span>(<span class="built_in">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Configure the bean factory with context callbacks.</span></span><br><span class="line">    <span class="comment">// 实现了 ApplicationContextAware 接口的 Bean 能够感知到当前的 ApplicationContext</span></span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationContextAwareProcessor</span>(<span class="built_in">this</span>));</span><br><span class="line">    <span class="comment">// 配置 BeanFactory 忽略一些特定的 Aware 接口的依赖自动注入,因为这些接口的实现通常由 Spring 框架自动处理。</span></span><br><span class="line">    beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationStartupAware.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// BeanFactory interface not registered as resolvable type in a plain factory.</span></span><br><span class="line">    <span class="comment">// MessageSource registered (and found for autowiring) as a bean.</span></span><br><span class="line">    <span class="comment">// 为一些常见的类型注册默认的单例 Bean, 可以通过依赖注入直接获取对应的实例</span></span><br><span class="line">    beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">    beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="built_in">this</span>);</span><br><span class="line">    beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="built_in">this</span>);</span><br><span class="line">    beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register early post-processor for detecting inner beans as ApplicationListeners.</span></span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationListenerDetector</span>(<span class="built_in">this</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Detect a LoadTimeWeaver and prepare for weaving, if found.</span></span><br><span class="line">    <span class="keyword">if</span> (!NativeDetector.inNativeImage() &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">LoadTimeWeaverAwareProcessor</span>(beanFactory));</span><br><span class="line">        <span class="comment">// Set a temporary ClassLoader for type matching.</span></span><br><span class="line">        beanFactory.setTempClassLoader(<span class="keyword">new</span> <span class="title class_">ContextTypeMatchClassLoader</span>(beanFactory.getBeanClassLoader()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register default environment beans.</span></span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(APPLICATION_STARTUP_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(APPLICATION_STARTUP_BEAN_NAME, getApplicationStartup());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Bean扫描注册invokeBeanFactoryPostProcessors"><a href="#Bean扫描注册invokeBeanFactoryPostProcessors" class="headerlink" title="Bean扫描注册invokeBeanFactoryPostProcessors()"></a>Bean扫描注册<code>invokeBeanFactoryPostProcessors()</code></h2><p>通过<code>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</code>按优先级调用所有注册的 <code>BeanFactoryPostProcessor</code> 和 <code>BeanDefinitionRegistryPostProcessor</code>，完成对 Bean 定义的修改。</p>
<p>该方法主要完成BeanDefinition的扫描、解析、注册：</p>
<p>1.实例化实现了BeanDefinitionRegistryPostProcessor接口的Bean</p>
<p>2.调用实现了BeanDefinitionRegistryPostProcessor的postProcessBeanDefinitionRegistry()方法</p>
<p>3.实例化实现了BeanFactoryPostProcessor接口的Bean</p>
<p>4.调用实现了BeanFactoryPostProcessor的postProcessBeanFactory()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeBeanFactoryPostProcessors</span><span class="params">(</span></span><br><span class="line"><span class="params">        ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// WARNING: Although it may appear that the body of this method can be easily</span></span><br><span class="line">    <span class="comment">// refactored to avoid the use of multiple loops and multiple lists, the use</span></span><br><span class="line">    <span class="comment">// of multiple lists and multiple passes over the names of processors is</span></span><br><span class="line">    <span class="comment">// intentional. We must ensure that we honor the contracts for PriorityOrdered</span></span><br><span class="line">    <span class="comment">// and Ordered processors. Specifically, we must NOT cause processors to be</span></span><br><span class="line">    <span class="comment">// instantiated (via getBean() invocations) or registered in the ApplicationContext</span></span><br><span class="line">    <span class="comment">// in the wrong order.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Before submitting a pull request (PR) to change this method, please review the</span></span><br><span class="line">    <span class="comment">// list of all declined PRs involving changes to PostProcessorRegistrationDelegate</span></span><br><span class="line">    <span class="comment">// to ensure that your proposal does not result in a breaking change:</span></span><br><span class="line">    <span class="comment">// https://github.com/spring-projects/spring-framework/issues?q=PostProcessorRegistrationDelegate+is%3Aclosed+label%3A%22status%3A+declined%22</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span></span><br><span class="line">    Set&lt;String&gt; processedBeans = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> BeanDefinitionRegistry registry) &#123;</span><br><span class="line">        List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;</span><br><span class="line">            <span class="keyword">if</span> (postProcessor <span class="keyword">instanceof</span> BeanDefinitionRegistryPostProcessor registryProcessor) &#123;</span><br><span class="line">                registryProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">                registryProcessors.add(registryProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                regularPostProcessors.add(postProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">        <span class="comment">// uninitialized to let the bean factory post-processors apply to them!</span></span><br><span class="line">        <span class="comment">// Separate between BeanDefinitionRegistryPostProcessors that implement</span></span><br><span class="line">        <span class="comment">// PriorityOrdered, Ordered, and the rest.</span></span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">        String[] postProcessorNames =</span><br><span class="line">                beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">        registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">        currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span></span><br><span class="line">        postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">        registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">        currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">reiterate</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (reiterate) &#123;</span><br><span class="line">            reiterate = <span class="literal">false</span>;</span><br><span class="line">            postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!processedBeans.contains(ppName)) &#123;</span><br><span class="line">                    currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                    processedBeans.add(ppName);</span><br><span class="line">                    reiterate = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">            registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">            invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">            currentRegistryProcessors.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</span><br><span class="line">        invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Invoke factory processors registered with the context instance.</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">    <span class="comment">// uninitialized to let the bean factory post-processors apply to them!</span></span><br><span class="line">    String[] postProcessorNames =</span><br><span class="line">            beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span></span><br><span class="line">    <span class="comment">// Ordered, and the rest.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">        <span class="keyword">if</span> (processedBeans.contains(ppName)) &#123;</span><br><span class="line">            <span class="comment">// skip - already processed in first phase above</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">            priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            orderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">    sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;</span><br><span class="line">        orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Finally, invoke all other BeanFactoryPostProcessors.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">        nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clear cached merged bean definitions since the post-processors might have</span></span><br><span class="line">    <span class="comment">// modified the original metadata, for example, replacing placeholders in values...</span></span><br><span class="line">    beanFactory.clearMetadataCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="注解处理"><a href="#注解处理" class="headerlink" title="注解处理"></a>注解处理</h1><p> <code>prepareBeanFactory</code> 阶段，Spring 会为 BeanFactory 添加一些默认的处理器，这些处理器会影响后续注解的处理。例如：</p>
<ul>
<li><p>添加 <code>ApplicationContextAwareProcessor</code>，用于处理 Aware 接口（如 ApplicationContextAware）。</p>
</li>
<li><p>添加 <code>BeanNameAware</code> 和 <code>BeanFactoryAware</code> 的支持。</p>
</li>
</ul>
<p><code>invokeBeanFactoryPostProcessors</code> 阶段的核心处理器是 <code>ConfigurationClassPostProcessor</code>，它实现了 <code>BeanFactoryPostProcessor</code> 接口，负责解析配置类及其相关注解。它的执行逻辑包括：</p>
<ul>
<li>解析主配置类（例如带有 <code>@SpringBootApplication</code> 的类）。</li>
<li>处理 <code>@ComponentScan</code>，扫描并注册组件。</li>
<li>处理 <code>@Import</code>，加载导入的配置类或执行 ImportSelector&#x2F;ImportBeanDefinitionRegistrar。</li>
<li>处理 <code>@Bean</code>，将配置类中的 @Bean 方法注册为 Bean 定义。</li>
</ul>
<p><code>registerBeanPostProcessors</code> 阶段，Spring 会注册所有 <code>BeanPostProcessor</code>，这些处理器负责处理与 Bean 初始化和生命周期相关的注解。典型注解包括：</p>
<ul>
<li><strong><code>@Autowired</code></strong> 和 <strong>@Inject</strong>：由 <code>AutowiredAnnotationBeanPostProcessor</code> 处理，用于依赖注入。</li>
<li><code>@Value</code>：由 <code>AutowiredAnnotationBeanPostProcessor</code> 处理，用于属性值注入。</li>
<li><strong><code>@PostConstruct</code></strong> 和 <strong>@PreDestroy</strong>：由 <code>CommonAnnotationBeanPostProcessor</code> 处理，用于生命周期回调。</li>
<li>**<code>@Resource</code>**：由 <code>CommonAnnotationBeanPostProcessor</code> 处理，用于 JSR-250 注解的依赖注入。</li>
</ul>
<p><code>finishBeanFactoryInitialization</code> 阶段，Spring 会实例化所有单例 Bean，并触发 BeanPostProcessor 的处理逻辑。这一阶段会实际执行依赖注入、初始化回调等操作。典型注解包括：</p>
<ul>
<li>**<code>@Autowired</code>**：注入依赖。</li>
<li>**<code>@PostConstruct</code>**：执行初始化方法。</li>
<li>**<code>@EventListener</code>**：由 EventListenerMethodProcessor 处理，注册事件监听器。</li>
</ul>
<p>Spring Boot 还扩展了许多自定义注解，这些注解的处理逻辑分布在不同的阶段。例如：</p>
<ul>
<li><strong><code>@ConditionalOnClass</code>,<code>@ConditionalOnMissingBean</code> 等条件注解</strong>：由 ConditionEvaluator 在 <code>invokeBeanFactoryPostProcessors</code> 阶段处理，用于决定是否加载某些配置类或 Bean。</li>
<li>**<code>@SpringBootApplication</code>**：由 <code>ConfigurationClassPostProcessor</code> 在 <code>invokeBeanFactoryPostProcessors</code> 阶段处理，分解为 <code>@Configuration</code> <code>@ComponentScan</code> 和 <code>@EnableAutoConfiguration</code>。</li>
<li><strong><code>@RestController</code></strong> 和 **<code>@RequestMapping</code>**：由 Spring MVC 相关的 BeanPostProcessor（如 RequestMappingHandlerMapping）在 <code>finishBeanFactoryInitialization</code> 阶段处理，用于注册控制器和映射请求路径。</li>
</ul>
<table>
<thead>
<tr>
<th>注解类型</th>
<th>处理阶段</th>
<th>核心处理器</th>
</tr>
</thead>
<tbody><tr>
<td>@Configuration</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>ConfigurationClassPostProcessor</td>
</tr>
<tr>
<td>@ComponentScan</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>ConfigurationClassPostProcessor</td>
</tr>
<tr>
<td>@Import</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>ConfigurationClassPostProcessor</td>
</tr>
<tr>
<td>@EnableAutoConfiguration</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>AutoConfigurationImportSelector</td>
</tr>
<tr>
<td>@ConditionalOnClass 等</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>ConditionEvaluator</td>
</tr>
<tr>
<td>@Bean</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>ConfigurationClassPostProcessor</td>
</tr>
<tr>
<td>@Autowired</td>
<td>registerBeanPostProcessors &#x2F; finishBeanFactoryInitialization</td>
<td>AutowiredAnnotationBeanPostProcessor</td>
</tr>
<tr>
<td>@Value</td>
<td>registerBeanPostProcessors &#x2F; finishBeanFactoryInitialization</td>
<td>AutowiredAnnotationBeanPostProcessor</td>
</tr>
<tr>
<td>@PostConstruct</td>
<td>registerBeanPostProcessors &#x2F; finishBeanFactoryInitialization</td>
<td>CommonAnnotationBeanPostProcessor</td>
</tr>
<tr>
<td>@EventListener</td>
<td>finishBeanFactoryInitialization</td>
<td>EventListenerMethodProcessor</td>
</tr>
<tr>
<td>@RestController</td>
<td>finishBeanFactoryInitialization</td>
<td>RequestMappingHandlerMapping</td>
</tr>
<tr>
<td>@RequestMapping</td>
<td>finishBeanFactoryInitialization</td>
<td>RequestMappingHandlerMapping</td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/03/03/cf/%E5%8F%8C%E6%8C%87%E9%92%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/03/cf/%E5%8F%8C%E6%8C%87%E9%92%88/" class="post-title-link" itemprop="url">双指针</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-03-03 19:51:00 / Modified: 22:30:00" itemprop="dateCreated datePublished" datetime="2025-03-03T19:51:00+08:00">2025-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/leetcode/" itemprop="url" rel="index"><span itemprop="name">leetcode</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>双指针主要用于遍历数组，两个指针指向不同的元素，从而协同完成任务。也可以延伸到多个数组的多个指针。 </p>
<p>若两个指针指向同一数组，遍历方向相同且不会相交，则也称为滑动窗口（两个指针包围的区域即为当前的窗口），经常用于区间搜索。 </p>
<p>若两个指针指向同一数组，但是遍历方向相反，则可以用来进行搜索，待搜索的数组往往是排好序的。</p>
</blockquote>
<p>注： C和CPP是支持指针的，直接操作内存内容，但Java中是不支持指针的。</p>
<h2 id="两数值和"><a href="#两数值和" class="headerlink" title="两数值和"></a>两数值和</h2><p>双指针实现：$O(n)$</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span>[] twoSum(<span class="type">int</span>[] numbers, <span class="type">int</span> target) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span>, right = numbers.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (left &lt; right &amp;&amp; numbers[left] + numbers[right] != target) &#123;</span><br><span class="line">        <span class="keyword">if</span>(numbers[left] + numbers[right] &lt; target)&#123;</span><br><span class="line">            left++;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            right--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;left + <span class="number">1</span>, right + <span class="number">1</span>&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>二分搜索实现：$O(nlog(n))$</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span>[] twoSum(<span class="type">int</span>[] numbers, <span class="type">int</span> target) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numbers.length; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> target - numbers[i];</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> binarySearch(numbers, i + <span class="number">1</span>, numbers.length - <span class="number">1</span>, val);</span><br><span class="line">        <span class="keyword">if</span> (index != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">int</span>[] &#123; i + <span class="number">1</span>, index + <span class="number">1</span> &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">binarySearch</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> start, <span class="type">int</span> end, <span class="type">int</span> val)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (start &lt;= end) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> start + (end - start) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (arr[mid] == val) &#123;</span><br><span class="line">            <span class="keyword">return</span> mid;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (arr[mid] &gt; val) &#123;</span><br><span class="line">            end = mid - <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            start = mid + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/03/02/cf/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/02/cf/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">常用工具类</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-02 17:05:44" itemprop="dateCreated datePublished" datetime="2025-03-02T17:05:44+08:00">2025-03-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-03-03 17:13:06" itemprop="dateModified" datetime="2025-03-03T17:13:06+08:00">2025-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/leetcode/" itemprop="url" rel="index"><span itemprop="name">leetcode</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="复杂度"><a href="#复杂度" class="headerlink" title="复杂度"></a>复杂度</h2><p>基本题目要求都是1s内完成。根据不同复杂度对应的n值</p>
<table>
<thead>
<tr>
<th>复杂度</th>
<th>N值</th>
</tr>
</thead>
<tbody><tr>
<td>$O(log(N))$</td>
<td>$10^{20}$</td>
</tr>
<tr>
<td>$O(N^{\frac{1}{2}})$</td>
<td>$10^{12}$</td>
</tr>
<tr>
<td>$O(N)$</td>
<td>$10^6$</td>
</tr>
<tr>
<td>$O(N^2)$</td>
<td>$10^3$</td>
</tr>
<tr>
<td>$O(N^3)$</td>
<td>$100$</td>
</tr>
<tr>
<td>$O(N^4)$</td>
<td>50</td>
</tr>
<tr>
<td>$O(2^N)$</td>
<td>20</td>
</tr>
<tr>
<td>$O(N!)$</td>
<td>10</td>
</tr>
</tbody></table>
<h2 id="数组复制"><a href="#数组复制" class="headerlink" title="数组复制"></a>数组复制</h2><p><strong>Arrays.copyOf</strong>：由Arrays类提供</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T[] copyOf(T[] original, <span class="type">int</span> newLength)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T,U&gt; T[] copyOf(U[] original, <span class="type">int</span> newLength, Class&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>[]&gt; newType)</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] original = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"><span class="type">int</span>[] copied = Arrays.copyOf(original, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>其中<code>original</code>可以是泛型类数组：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">method</span><span class="params">(T[] arr)</span>&#123;</span><br><span class="line">    T[] newArr = Arrays.copyOf(arr, arr.length)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>System.arraycopy</strong>： 是本地方法，更底层效率更高。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">arraycopy</span><span class="params">(Object src, <span class="type">int</span> srcPos, Object dest, <span class="type">int</span> destPos, <span class="type">int</span> length)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] original = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"><span class="type">int</span>[] copied = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">3</span>];</span><br><span class="line">System.arraycopy(original, <span class="number">2</span>, copied, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line"><span class="comment">// copied = &#123;3, 4, 5&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="数组排序"><a href="#数组排序" class="headerlink" title="数组排序"></a>数组排序</h2><p>对象数组：让对象实现<code>Comparable</code>接口，并重写<code>compareTo()</code>方法。</p>
<p>基本类型数组：向Arrays.sort传入<code>Comparator</code>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[][] points;</span><br><span class="line">Arrays.sort(points, (o1, o2) -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (o1[<span class="number">1</span>] != o2[<span class="number">1</span>]) &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.compare(o1[<span class="number">1</span>], o2[<span class="number">1</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.compare(o1[<span class="number">0</span>], o2[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/03/01/cf/%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/01/cf/%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" class="post-title-link" itemprop="url">基本数据结构</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-01 22:10:06" itemprop="dateCreated datePublished" datetime="2025-03-01T22:10:06+08:00">2025-03-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-03-03 11:33:52" itemprop="dateModified" datetime="2025-03-03T11:33:52+08:00">2025-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/leetcode/" itemprop="url" rel="index"><span itemprop="name">leetcode</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="最小（大）堆"><a href="#最小（大）堆" class="headerlink" title="最小（大）堆"></a>最小（大）堆</h1><p>最小堆的主要操作：</p>
<ul>
<li>将已有数组进行堆化</li>
<li>向最小堆中的添加，删除操作</li>
<li>将最小堆的数组排序化</li>
</ul>
<h2 id="堆化已有数组"><a href="#堆化已有数组" class="headerlink" title="堆化已有数组"></a>堆化已有数组</h2><blockquote>
<p>从最后一个非叶子节点开始向下调整。</p>
</blockquote>
<p>向下调整：</p>
<ul>
<li>选择左右儿子中值更大且大于本节点值的节点，与本节点交换位置（本节点值大于左右儿子时不需要操作）</li>
<li>交换后，将交换后的儿子节点继续执行向下调整</li>
</ul>
<p>向上调整：</p>
<ul>
<li>将儿子元素与父亲比较，如果儿子元素大于父亲元素，则与父亲元素交换</li>
<li>交换后，堆交换后的父亲节点继续执行向上调整</li>
</ul>
<p>在一个完全二叉树中，最后一个非叶子节点是 $n&#x2F;2-1$，对所有的非叶子节点执行向下调整。完成后数组elements即成为最小（大）堆。</p>
<p>添加元素：将元素添加到数组最后（完全二叉树最后一个叶子节点）然后对该元素执行向上调整</p>
<p>删除元素：删除根节点元素（数组第一个元素），将最后一个元素赋值给根节点并对根节点执行向下调整</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">minHeap</span>&lt;T <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;T&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> T[] elements;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">minHeap</span><span class="params">(T[] arr)</span> &#123;</span><br><span class="line">        elements = Arrays.copyOf(arr, arr.length);        </span><br><span class="line">        <span class="comment">// 对所有非叶子节点执行向下调整</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> arr.length / <span class="number">2</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            downMove(elements, i, elements.length - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//向下调整</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">downMove</span><span class="params">(T[] elements, <span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">parent</span> <span class="operator">=</span> start;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start * <span class="number">2</span> + <span class="number">1</span>; i &lt;= end; i = i * <span class="number">2</span> + <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//选择左右儿子中较大的</span></span><br><span class="line">            <span class="keyword">if</span> (i &lt; end &amp;&amp; elements[i].compareTo(elements[i + <span class="number">1</span>]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//如果较大的儿子比父亲值还大，需要交换位置，并对儿子节点继续向下调整，否则退出循环</span></span><br><span class="line">            <span class="keyword">if</span> (elements[i].compareTo(elements[parent]) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">T</span> <span class="variable">tmp</span> <span class="operator">=</span> elements[parent];</span><br><span class="line">                elements[parent] = elements[i];</span><br><span class="line">                elements[i] = tmp;</span><br><span class="line">                parent = i;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ds;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">minHeap</span>&lt;T <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;T&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> T[] elements;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">minHeap</span><span class="params">(T[] arr, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        size = arr.length;</span><br><span class="line">        elements = Arrays.copyOf(arr, Math.max(arr.length, size));</span><br><span class="line">        <span class="comment">// 对所有非叶子节点执行向下调整</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> arr.length / <span class="number">2</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            downMove(elements, i, elements.length - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向下调整</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">downMove</span><span class="params">(T[] elements, <span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">parent</span> <span class="operator">=</span> start;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start * <span class="number">2</span> + <span class="number">1</span>; i &lt;= end; i = i * <span class="number">2</span> + <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 选择左右儿子中较大的</span></span><br><span class="line">            <span class="keyword">if</span> (i &lt; end &amp;&amp; elements[i].compareTo(elements[i + <span class="number">1</span>]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果较大的儿子比父亲值还大，需要交换位置，并对儿子节点继续向下调整，否则退出循环</span></span><br><span class="line">            <span class="keyword">if</span> (elements[i].compareTo(elements[parent]) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">T</span> <span class="variable">tmp</span> <span class="operator">=</span> elements[parent];</span><br><span class="line">                elements[parent] = elements[i];</span><br><span class="line">                elements[i] = tmp;</span><br><span class="line">                parent = i;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">upMove</span><span class="params">(T[] elements, <span class="type">int</span> start)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">child</span> <span class="operator">=</span> start;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (start - <span class="number">1</span>) / <span class="number">2</span>; i &gt; <span class="number">0</span>; i = (i - <span class="number">1</span>) / <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (elements[child].compareTo(elements[i]) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">T</span> <span class="variable">tmp</span> <span class="operator">=</span> elements[child];</span><br><span class="line">                elements[child] = elements[i];</span><br><span class="line">                elements[i] = tmp;</span><br><span class="line">                child = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加元素至最后一个位置并向上调整</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(T element)</span> &#123;</span><br><span class="line">        elements[size] = element;</span><br><span class="line">        upMove(elements, size);</span><br><span class="line">        size++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后一个元素覆盖第一个元素并向下调整</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">        elements[<span class="number">0</span>] = elements[size - <span class="number">1</span>];</span><br><span class="line">        size--;</span><br><span class="line">        downMove(elements, <span class="number">0</span>, size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T[] heapSort() &#123;</span><br><span class="line">        sortArrayFromHeap(elements);</span><br><span class="line">        <span class="keyword">return</span> elements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sortArrayFromHeap</span><span class="params">(T[] elements)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> elements.length - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="type">T</span> <span class="variable">tmp</span> <span class="operator">=</span> elements[<span class="number">0</span>];</span><br><span class="line">            elements[<span class="number">0</span>] = elements[i];</span><br><span class="line">            elements[i] = tmp;</span><br><span class="line">            downMove(elements, <span class="number">0</span>, i - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] arr = &#123; -<span class="number">4</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">9</span>, -<span class="number">5</span>, -<span class="number">1</span>, <span class="number">0</span>, -<span class="number">7</span>, -<span class="number">1</span> &#125;;</span><br><span class="line">        Integer[] arrInteger = Arrays.stream(arr).boxed().toArray(Integer[]::<span class="keyword">new</span>);</span><br><span class="line">        minHeap&lt;Integer&gt; m = <span class="keyword">new</span> <span class="title class_">minHeap</span>&lt;&gt;(arrInteger, arrInteger.length + <span class="number">10</span>);</span><br><span class="line">        m.add(<span class="number">10</span>);</span><br><span class="line">        <span class="type">int</span>[] res = Arrays.stream(m.elements).mapToInt(Integer::intValue).toArray();</span><br><span class="line">        System.out.println(Arrays.toString(res));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/02/23/react/vscode%E5%89%8D%E7%AB%AF%E6%8F%92%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/23/react/vscode%E5%89%8D%E7%AB%AF%E6%8F%92%E4%BB%B6/" class="post-title-link" itemprop="url">vscode前端插件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-02-23 18:34:44" itemprop="dateCreated datePublished" datetime="2025-02-23T18:34:44+08:00">2025-02-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-05-11 23:57:03" itemprop="dateModified" datetime="2025-05-11T23:57:03+08:00">2025-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><p>Quokka.js</p>
</li>
<li><p>Import Cost </p>
</li>
<li><p>Color Highlight</p>
</li>
<li><p>CSS Peek</p>
</li>
<li><p>REST Client</p>
</li>
<li><p>Live Server</p>
</li>
<li><p>JSON</p>
</li>
<li><p>json2ts</p>
</li>
<li><p>Path Intellisense</p>
</li>
<li><p>Path Autocomplete</p>
</li>
<li><p>Npm Intellisense</p>
</li>
<li><p>NPM</p>
</li>
<li><p>NPM-Scripts</p>
</li>
<li><p>JavaScript (ES6) code snippets</p>
</li>
<li><p>Tailwind CSS IntelliSense</p>
</li>
<li><p>ESLint</p>
</li>
<li><p>Prettier - Code formatter</p>
</li>
<li><p>Nextjs snippets</p>
</li>
<li><p>Simple React Snippets</p>
</li>
<li><p>Git Graph</p>
</li>
<li><p>Hex Editor</p>
</li>
<li><p>Code Runner</p>
</li>
<li><p>IntelliJ IDEA Keybindings</p>
</li>
<li><p>Material Icon Theme</p>
</li>
<li><p>Atom One Dark Theme</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">YingZheng</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/caohongchuan" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"caohongchuan","repo":"caohongchuan.github.io","client_id":"967bc44f66d40841715d","client_secret":"8d7caaf8d49e847e9da60bfab064fc2acad2b66d","admin_user":"caohongchuan","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"en | zh-CN","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"c853ec00cc9d13bc22336b7d45d1416e"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
