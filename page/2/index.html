<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"caohongchuan.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":"auto","version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
<meta property="og:type" content="website">
<meta property="og:title" content="yingzheng">
<meta property="og:url" content="http://caohongchuan.github.io/page/2/index.html">
<meta property="og:site_name" content="yingzheng">
<meta property="og:description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="YingZheng">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://caohongchuan.github.io/page/2/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>yingzheng</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">yingzheng</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="YingZheng"
      src="/images/photo.png">
  <p class="site-author-name" itemprop="name">YingZheng</p>
  <div class="site-description" itemprop="description">Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/caohongchuan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;caohongchuan" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yingzhengttt@gmail.com" title="E-Mail → mailto:yingzhengttt@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/03/17/springboot/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A1%86%E6%9E%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/17/springboot/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A1%86%E6%9E%B6/" class="post-title-link" itemprop="url">SpringBoot 数据库框架</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-17 20:06:24" itemprop="dateCreated datePublished" datetime="2025-03-17T20:06:24+08:00">2025-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-03-18 22:11:32" itemprop="dateModified" datetime="2025-03-18T22:11:32+08:00">2025-03-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/springboot/" itemprop="url" rel="index"><span itemprop="name">springboot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>SpringBoot连接数据库基本都通过数据库框架，主要框架分为纯底层框架，半ORM框架，ORM框架。</p>
<p>ORM框架：ORM（Object-Relational Mapping）框架是一种编程技术，用于在对象模型和关系数据库之间建立映射，从而实现数据的持久化存储和操作。具体来说，ORM框架将数据库中的表（table）映射为编程语言中的类（class），表中的记录（record）映射为类的实例（object），字段（field）映射为对象的属性（attribute）。</p>
</blockquote>
<h1 id="SpringBoot数据库框架"><a href="#SpringBoot数据库框架" class="headerlink" title="SpringBoot数据库框架"></a>SpringBoot数据库框架</h1><p>在使用 Spring Boot 开发应用时，选择合适的数据库框架（主要是 ORM 框架）对项目的开发效率和性能至关重要。</p>
<h2 id="1-Spring-Data-JPA（ORM框架）"><a href="#1-Spring-Data-JPA（ORM框架）" class="headerlink" title="1.Spring Data JPA（ORM框架）"></a>1.Spring Data JPA（ORM框架）</h2><blockquote>
<p>Spring Data JPA 是 Spring Boot 的默认 ORM 框架，基于 <strong>Hibernate</strong> 实现。它提供了简单易用的接口和注解，可以极大减少样板代码。</p>
</blockquote>
<p>程序员不需要编写SQL语句，框架已经高度封装CRUD，调用对应的Java方法即可执行SQL语句。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-MyBatis（半ORM框架）"><a href="#2-MyBatis（半ORM框架）" class="headerlink" title="2. MyBatis（半ORM框架）"></a>2. MyBatis（半ORM框架）</h2><blockquote>
<p>MyBatis 是一个轻量级的持久层框架，提供 SQL 映射功能，开发者可以直接编写 SQL 语句。</p>
</blockquote>
<p>MyBatis允许程序员自行编写SQL语句，并通过<code>@Mapper</code>将编写的SQL封装到Java对象并注册为Spring的Bean中，程序员可以通过<code>@Autowired</code>获取Java对象并调用方法执行对应的SQL语句。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">&lt;/dependency</span><br></pre></td></tr></table></figure>

<h2 id="3-Spring-JDBC（纯底层框架）"><a href="#3-Spring-JDBC（纯底层框架）" class="headerlink" title="3.Spring JDBC（纯底层框架）"></a>3.Spring JDBC（纯底层框架）</h2><blockquote>
<p>Spring JDBC 是 Spring 提供的最底层的 JDBC 封装，适合直接操作数据库的场景。</p>
</blockquote>
<p>所有的SQL都需要程序员手动编写，不支持ORM的功能。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="4-Hibernate（ORM框架）"><a href="#4-Hibernate（ORM框架）" class="headerlink" title="4. Hibernate（ORM框架）"></a>4. Hibernate（ORM框架）</h2><blockquote>
<p>Hibernate 是一个功能强大的 ORM 框架，Spring Data JPA 底层就是基于 Hibernate 实现的。如果你需要直接使用 Hibernate，可以绕过 Spring Data JPA。这里就不做详细介绍了。</p>
</blockquote>
<table>
<thead>
<tr>
<th>框架</th>
<th>推荐场景</th>
<th>学习曲线</th>
<th>性能优化空间</th>
</tr>
</thead>
<tbody><tr>
<td>Spring Data JPA</td>
<td>中小型项目，快速开发</td>
<td>低</td>
<td>中等</td>
</tr>
<tr>
<td>MyBatis</td>
<td>性能敏感型项目，复杂查询</td>
<td>中等</td>
<td>高</td>
</tr>
<tr>
<td>Hibernate</td>
<td>需要高级 ORM 特性</td>
<td>高</td>
<td>中等</td>
</tr>
<tr>
<td>JOOQ</td>
<td>类型安全 SQL 查询，复杂数据库操作</td>
<td>中等</td>
<td>高</td>
</tr>
<tr>
<td>Spring JDBC</td>
<td>极致性能，轻量级应用</td>
<td>低</td>
<td>最高</td>
</tr>
</tbody></table>
<hr>
<p>对于有经验的程序员，Mybatis框架是一个很好的选择，程序员可以自定义SQL语句用于优化性能，又可以通过ORM框架将SQL语句封装到Java对象中。</p>
<p>如果对数据库不甚了解，可以选择Spring Data JPA通过Java对象直接执行SQL语句，不需要了解SQL语句。</p>
<h1 id="Mybatis数据库框架"><a href="#Mybatis数据库框架" class="headerlink" title="Mybatis数据库框架"></a>Mybatis数据库框架</h1><p>添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="加载DataSource"><a href="#加载DataSource" class="headerlink" title="加载DataSource"></a>加载DataSource</h2><p>当类路径中存在<code>javax.sql.DataSource</code>和嵌入式数据库相关的类，会激活自动配置类<code>DataSourceAutoConfiguration</code>用于配置<code>DataSource</code>的Bean。</p>
<p>其中<code>DataSourceAutoConfiguration</code>存在于<code>org.springframework.boot:spring-boot-autoconfigure</code>的<code>META-INF/spring/org.sringframework.boot.autoconfigure.AutoConfiguration.imports</code>。</p>
<blockquote>
<p>SpringBoot启动过程中，在处理注解<code>@EnableAutoConfiguration</code>时，会在<code>@Import(AutoConfigurationImportSelector.class)</code>导入<code>AutoConfigurationImportSelector</code>，该类会搜索classpath内的所有<code>/META-INF/spring/xxx.imports</code>内的自动配置类。</p>
<p>注解的处理逻辑存在于<code>AbstractApplicationContext.refresh.invokeBeanFactoryPostProcessors(beanFactory)</code>中。</p>
</blockquote>
<p><code>org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration(before = SqlInitializationAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; DataSource.class, EmbeddedDatabaseType.class &#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(type = &quot;io.r2dbc.spi.ConnectionFactory&quot;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(DataSourceProperties.class)</span></span><br><span class="line"><span class="meta">@Import(&#123; DataSourcePoolMetadataProvidersConfiguration.class, DataSourceCheckpointRestoreConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceAutoConfiguration</span> &#123;</span><br><span class="line"><span class="comment">//......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="触发条件"><a href="#触发条件" class="headerlink" title="触发条件"></a>触发条件</h3><p><code>@ConditionalOnClass(&#123; DataSource.class, EmbeddedDatabaseType.class &#125;)</code>只有Spring中同时具有<code>DataSource.class</code>和<code>EmbeddedDatabaseType.class</code>才会加载该配置类。其中<code>DataSource.class</code>是JDK标准库的一部分所以条件横为真。</p>
<ul>
<li><p>当引入<code>mysql-connector-j</code>会提供<code>com.mysql.cj.jdbc.MysqlDataSource</code>和数据库驱动。</p>
</li>
<li><p>当引入<code>mybatis-spring-boot-starter</code>，包含<code>spring-jdbc</code>依赖，其中包含了<code>/org/springframework/spring-jdbc/6.2.3/spring-jdbc-6.2.3.jar!/org/springframework/jdbc/datasource/embedded/EmbeddedDatabaseType.class</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mybatis-spring-boot-starter</span><br><span class="line">├── mybatis-spring-boot-autoconfigure</span><br><span class="line">├── mybatis</span><br><span class="line">├── mybatis-spring</span><br><span class="line">└── spring-boot-starter-jdbc</span><br><span class="line">    ├── spring-jdbc</span><br><span class="line">    └── HikariCP（默认连接池）</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>javax.sql.DataSource</strong>：由 JDK 提供，总是存在（Java 6 及以上版本）。</p>
<p><strong>EmbeddedDatabaseType</strong>：由 spring-jdbc 提供，通过 mybatis-spring-boot-starter 间接引入。</p>
<h3 id="读取数据库配置信息"><a href="#读取数据库配置信息" class="headerlink" title="读取数据库配置信息"></a>读取数据库配置信息</h3><p><code>@EnableConfigurationProperties(DataSourceProperties.class)</code>，该注解会将配置中的数据库信息封装到<code>DataSourceProperties.class</code>，并加载为Spring Bean。</p>
<h3 id="加载数据池"><a href="#加载数据池" class="headerlink" title="加载数据池"></a>加载数据池</h3><p><code>@Import(&#123; DataSourcePoolMetadataProvidersConfiguration.class, DataSourceCheckpointRestoreConfiguration.class &#125;)</code>通过<code>DataSourcePoolMetadataProvidersConfiguration.class</code>配置数据池。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourcePoolMetadataProvidersConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass(org.apache.tomcat.jdbc.pool.DataSource.class)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TomcatDataSourcePoolMetadataProviderConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		DataSourcePoolMetadataProvider <span class="title function_">tomcatPoolDataSourceMetadataProvider</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> (dataSource) -&gt; &#123;</span><br><span class="line">				org.apache.tomcat.jdbc.pool.<span class="type">DataSource</span> <span class="variable">tomcatDataSource</span> <span class="operator">=</span> DataSourceUnwrapper.unwrap(dataSource,</span><br><span class="line">						ConnectionPoolMBean.class, org.apache.tomcat.jdbc.pool.DataSource.class);</span><br><span class="line">				<span class="keyword">if</span> (tomcatDataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TomcatDataSourcePoolMetadata</span>(tomcatDataSource);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass(HikariDataSource.class)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">HikariPoolDataSourceMetadataProviderConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		DataSourcePoolMetadataProvider <span class="title function_">hikariPoolDataSourceMetadataProvider</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> (dataSource) -&gt; &#123;</span><br><span class="line">				<span class="type">HikariDataSource</span> <span class="variable">hikariDataSource</span> <span class="operator">=</span> DataSourceUnwrapper.unwrap(dataSource, HikariConfigMXBean.class,</span><br><span class="line">						HikariDataSource.class);</span><br><span class="line">				<span class="keyword">if</span> (hikariDataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSourcePoolMetadata</span>(hikariDataSource);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass(BasicDataSource.class)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CommonsDbcp2PoolDataSourceMetadataProviderConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		DataSourcePoolMetadataProvider <span class="title function_">commonsDbcp2PoolDataSourceMetadataProvider</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> (dataSource) -&gt; &#123;</span><br><span class="line">				<span class="type">BasicDataSource</span> <span class="variable">dbcpDataSource</span> <span class="operator">=</span> DataSourceUnwrapper.unwrap(dataSource, BasicDataSourceMXBean.class,</span><br><span class="line">						BasicDataSource.class);</span><br><span class="line">				<span class="keyword">if</span> (dbcpDataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonsDbcp2DataSourcePoolMetadata</span>(dbcpDataSource);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass(&#123; PoolDataSource.class, OracleConnection.class &#125;)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OracleUcpPoolDataSourceMetadataProviderConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		DataSourcePoolMetadataProvider <span class="title function_">oracleUcpPoolDataSourceMetadataProvider</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> (dataSource) -&gt; &#123;</span><br><span class="line">				<span class="type">PoolDataSource</span> <span class="variable">ucpDataSource</span> <span class="operator">=</span> DataSourceUnwrapper.unwrap(dataSource, PoolDataSource.class);</span><br><span class="line">				<span class="keyword">if</span> (ucpDataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OracleUcpDataSourcePoolMetadata</span>(ucpDataSource);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过源码可以得出，提供了4种数据库链接池：</p>
<p><strong>HikariCP</strong>（默认）：</p>
<ul>
<li>类：<code>com.zaxxer.hikari.HikariDataSource</code></li>
<li>依赖：<code>com.zaxxer:HikariCP</code></li>
<li>默认引入：通过 <code>spring-boot-starter-jdbc</code> 或 <code>spring-boot-starter-data-jpa</code>。</li>
</ul>
<p><strong>Tomcat JDBC</strong>：</p>
<ul>
<li>类：<code>org.apache.tomcat.jdbc.pool.DataSource</code></li>
<li>依赖：<code>org.apache.tomcat:tomcat-jdbc</code></li>
<li>使用条件：类路径中存在，且未引入 HikariCP。</li>
</ul>
<p><strong>Commons DBCP2</strong>：</p>
<ul>
<li>类：<code>org.apache.commons.dbcp2.BasicDataSource</code></li>
<li>依赖：<code>org.apache.commons:commons-dbcp2</code></li>
<li>使用条件：类路径中存在，且未引入 HikariCP 或 Tomcat JDBC。</li>
</ul>
<p><strong>OracleUcp：</strong></p>
<p>在<code>spring-boot-starter-jdbc</code>中引入了<code>HikariCP</code>，所以Mybatis会自动配置<code>HikariDataSourcePoolMetadata</code></p>
<p>可以通过配置文件指定数据池类型：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">org.apache.tomcat.jdbc.pool.DataSource</span></span><br></pre></td></tr></table></figure>

<p>并加入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zaxxer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>HikariCP<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/03/11/springboot/SpringBoot%20bean%E5%8A%A0%E8%BD%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/11/springboot/SpringBoot%20bean%E5%8A%A0%E8%BD%BD/" class="post-title-link" itemprop="url">SpringBoot Bean加载</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-11 16:29:32" itemprop="dateCreated datePublished" datetime="2025-03-11T16:29:32+08:00">2025-03-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-03-12 14:16:10" itemprop="dateModified" datetime="2025-03-12T14:16:10+08:00">2025-03-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/springboot/" itemprop="url" rel="index"><span itemprop="name">springboot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>了解Java注解原理后，可知除了内置注解(@Override等)，其他的通过元注解编写的注解需要自行编写注解处理器并让JVM加载这些处理器以用于解析注解。</p>
<p>目前为止，SpringBoot中使用了大量的注解来简化开发，如启动类的<code>@SpringBootApplication</code>，自定义bean的<code>@Configuration</code> <code>@bean</code>这些自定义注解都需要SpringBoot框架去解析。本文将通过SpringBoot加载Bean来讲解注解的处理。</p>
</blockquote>
<h1 id="SpringBoot启动时Bean的加载过程"><a href="#SpringBoot启动时Bean的加载过程" class="headerlink" title="SpringBoot启动时Bean的加载过程"></a>SpringBoot启动时Bean的加载过程</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">|--LearnApplication //启动类</span><br><span class="line">|----SpringApplication.run()</span><br><span class="line">|------refreshContext(context);</span><br><span class="line">|--------applicationContext.refresh(); //此处以ServletWebServerApplicationContext为例子</span><br><span class="line">|----------AbstractApplicationContext.refresh() //实际调用的是该抽象类的方法</span><br><span class="line">|------------invokeBeanFactoryPostProcessors(beanFactory); //本方法是扫描注解加载Bean的核心方法</span><br><span class="line">|--------------PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</span><br></pre></td></tr></table></figure>

<p>通过对SpringBoot启动流程的分析，扫描注解加载Bean类的核心方法是<code>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</code></p>
<h1 id="PostProcessorRegistrationDelegate-invokeBeanFactoryPostProcessors-详解"><a href="#PostProcessorRegistrationDelegate-invokeBeanFactoryPostProcessors-详解" class="headerlink" title="PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors()详解"></a><code>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors()</code>详解</h1><blockquote>
<p>这个方法写的是真垃圾，看它在注解中直接加入issue链接就知道它写的多乱了。</p>
</blockquote>
<p>该方法执行 <code>BeanFactoryPostProcessor</code> 及其子接口 <code>BeanDefinitionRegistryPostProcessor</code> 的关键方法。</p>
<ul>
<li><p><strong>执行 <code>BeanDefinitionRegistryPostProcessor</code></strong></p>
<ul>
<li>先执行 <code>PriorityOrdered</code> 的 <code>BeanDefinitionRegistryPostProcessor</code>（按优先级排序）</li>
<li>再执行 <code>Ordered</code> 的 <code>BeanDefinitionRegistryPostProcessor</code></li>
<li>最后执行普通的 <code>BeanDefinitionRegistryPostProcessor</code></li>
</ul>
</li>
<li><p><strong>执行 <code>BeanFactoryPostProcessor</code></strong></p>
<ul>
<li><p>先执行 <code>PriorityOrdered</code> 的 <code>BeanFactoryPostProcessor</code></p>
</li>
<li><p>再执行 <code>Ordered</code> 的 <code>BeanFactoryPostProcessor</code></p>
</li>
<li><p>最后执行普通的 <code>BeanFactoryPostProcessor</code></p>
</li>
</ul>
</li>
</ul>
<p>*注：在 Spring 中，<code>BeanFactoryPostProcessor</code> 用于 <strong>在 Bean 实例化之前</strong> 修改 <strong>BeanDefinition</strong>，而 <code>BeanDefinitionRegistryPostProcessor</code> 则 <strong>可以额外注册新的 BeanDefinition</strong>。*</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeBeanFactoryPostProcessors</span><span class="params">(</span></span><br><span class="line"><span class="params">        ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// WARNING: Although it may appear that the body of this method can be easily</span></span><br><span class="line">    <span class="comment">// refactored to avoid the use of multiple loops and multiple lists, the use</span></span><br><span class="line">    <span class="comment">// of multiple lists and multiple passes over the names of processors is</span></span><br><span class="line">    <span class="comment">// intentional. We must ensure that we honor the contracts for PriorityOrdered</span></span><br><span class="line">    <span class="comment">// and Ordered processors. Specifically, we must NOT cause processors to be</span></span><br><span class="line">    <span class="comment">// instantiated (via getBean() invocations) or registered in the ApplicationContext</span></span><br><span class="line">    <span class="comment">// in the wrong order.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Before submitting a pull request (PR) to change this method, please review the</span></span><br><span class="line">    <span class="comment">// list of all declined PRs involving changes to PostProcessorRegistrationDelegate</span></span><br><span class="line">    <span class="comment">// to ensure that your proposal does not result in a breaking change:</span></span><br><span class="line">    <span class="comment">// https://github.com/spring-projects/spring-framework/issues?q=PostProcessorRegistrationDelegate+is%3Aclosed+label%3A%22status%3A+declined%22</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span></span><br><span class="line">    Set&lt;String&gt; processedBeans = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 BeanFactory 是 BeanDefinitionRegistry，则执行 BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> BeanDefinitionRegistry registry) &#123;</span><br><span class="line">        List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		</span><br><span class="line">         <span class="comment">// 先处理方法参数传入的 BeanFactoryPostProcessors（非 Spring 扫描的）</span></span><br><span class="line">        <span class="keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;</span><br><span class="line">            <span class="keyword">if</span> (postProcessor <span class="keyword">instanceof</span> BeanDefinitionRegistryPostProcessor registryProcessor) &#123;</span><br><span class="line">                registryProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">                registryProcessors.add(registryProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                regularPostProcessors.add(postProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">        <span class="comment">// 这里会处理内置于SpringBoot的ConfigurationClassPostProcessor</span></span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 首先处理实现PriorityOrdered的BeanDefinitionRegistryPostProcessors</span></span><br><span class="line">        String[] postProcessorNames =</span><br><span class="line">                beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//排序</span></span><br><span class="line">        sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">        registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">        <span class="comment">//调用postProcessBeanDefinitionRegistry方法</span></span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">        currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 首先处理实现 Ordered 的BeanDefinitionRegistryPostProcessors</span></span><br><span class="line">        postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">        registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">        <span class="comment">//调用postProcessBeanDefinitionRegistry方法</span></span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">        currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最后 执行普通的 BeanDefinitionRegistryPostProcessor</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">reiterate</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (reiterate) &#123;</span><br><span class="line">            reiterate = <span class="literal">false</span>;</span><br><span class="line">            postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!processedBeans.contains(ppName)) &#123;</span><br><span class="line">                    currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                    processedBeans.add(ppName);</span><br><span class="line">                    reiterate = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">            registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">            invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">            currentRegistryProcessors.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span></span><br><span class="line">        <span class="comment">// 调用 BeanDefinitionRegistryPostProcessor 和 BeanFactoryPostProcessor 的postProcessBeanFactory()方法</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</span><br><span class="line">        invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果 BeanFactory 不是 BeanDefinitionRegistry，则直接执行普通的 BeanFactoryPostProcessor 的postProcessBeanFactory()方法</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理 Spring 容器注册的 BeanFactoryPostProcessor</span></span><br><span class="line">    String[] postProcessorNames =</span><br><span class="line">            beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span></span><br><span class="line">    <span class="comment">// Ordered, and the rest.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">        <span class="keyword">if</span> (processedBeans.contains(ppName)) &#123;</span><br><span class="line">            <span class="comment">// skip - already processed in first phase above</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">            priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            orderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">    sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;</span><br><span class="line">        orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Finally, invoke all other BeanFactoryPostProcessors.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">        nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clear cached merged bean definitions since the post-processors might have</span></span><br><span class="line">    <span class="comment">// modified the original metadata, for example, replacing placeholders in values...</span></span><br><span class="line">    beanFactory.clearMetadataCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ConfigurationClassPostProcessor"><a href="#ConfigurationClassPostProcessor" class="headerlink" title="ConfigurationClassPostProcessor"></a><code>ConfigurationClassPostProcessor</code></h1><blockquote>
<p><code>ConfigurationClassPostProcessor</code> 是 **Spring 内部关键的 <code>BeanFactoryPostProcessor</code>**，它的主要作用是 <strong>解析 <code>@Configuration</code>、<code>@ComponentScan</code>、<code>@Import</code>、<code>@Bean</code> 等注解</strong>，并将解析后的 <strong>BeanDefinition</strong> 注册到 <code>BeanFactory</code> 中。</p>
</blockquote>
<p>Spring 在 <code>invokeBeanFactoryPostProcessors()</code> 时执行所有 <code>BeanFactoryPostProcessor</code>，其中 <code>ConfigurationClassPostProcessor</code> 是 <strong>Spring 内置的 <code>BeanFactoryPostProcessor</code>，优先执行</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>通过<code>beanFactory.getBeanNamesForType()</code>来获取<code>BeanDefinitionRegistryPostProcessor.class</code>的后处理类。调试后会得到<code>postProcessorNames=org.springframework.context.annotation.internalConfigurationAnnotationProcessor</code>然后将这个名字传入<code>beanFactory.getBean()</code>并获取它的bean类型，得到的bean类就是<code>ConfigurationClassPostProcessor</code>。后续会调用该类的<code>postProcessBeanDefinitionRegistry()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">registryId</span> <span class="operator">=</span> System.identityHashCode(registry);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.registriesPostProcessed.contains(registryId)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                <span class="string">&quot;postProcessBeanDefinitionRegistry already called on this post-processor against &quot;</span> + registry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.factoriesPostProcessed.contains(registryId)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                <span class="string">&quot;postProcessBeanFactory already called on this post-processor against &quot;</span> + registry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.registriesPostProcessed.add(registryId);</span><br><span class="line"></span><br><span class="line">    processConfigBeanDefinitions(registry);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processConfigBeanDefinitions</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    List&lt;BeanDefinitionHolder&gt; configCandidates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 获取所有注册的bean类型</span></span><br><span class="line">    String[] candidateNames = registry.getBeanDefinitionNames();</span><br><span class="line">	<span class="comment">//遍历所有的bean类，寻找有@Configuration注解的类</span></span><br><span class="line">    <span class="keyword">for</span> (String beanName : candidateNames) &#123;</span><br><span class="line">        <span class="type">BeanDefinition</span> <span class="variable">beanDef</span> <span class="operator">=</span> registry.getBeanDefinition(beanName);</span><br><span class="line">        <span class="keyword">if</span> (beanDef.getAttribute(ConfigurationClassUtils.CONFIGURATION_CLASS_ATTRIBUTE) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;Bean definition has already been processed as a configuration class: &quot;</span> + beanDef);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果bean类中包含@Configuration注解则将该类加入到configCandidates List中</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, <span class="built_in">this</span>.metadataReaderFactory)) &#123;</span><br><span class="line">            configCandidates.add(<span class="keyword">new</span> <span class="title class_">BeanDefinitionHolder</span>(beanDef, beanName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return immediately if no @Configuration classes were found</span></span><br><span class="line">    <span class="keyword">if</span> (configCandidates.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据@Order排序</span></span><br><span class="line">    configCandidates.sort((bd1, bd2) -&gt; &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i1</span> <span class="operator">=</span> ConfigurationClassUtils.getOrder(bd1.getBeanDefinition());</span><br><span class="line">        <span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> ConfigurationClassUtils.getOrder(bd2.getBeanDefinition());</span><br><span class="line">        <span class="keyword">return</span> Integer.compare(i1, i2);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Detect any custom bean name generation strategy supplied through the enclosing application context</span></span><br><span class="line">    <span class="type">SingletonBeanRegistry</span> <span class="variable">singletonRegistry</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (registry <span class="keyword">instanceof</span> SingletonBeanRegistry sbr) &#123;</span><br><span class="line">        singletonRegistry = sbr;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.localBeanNameGeneratorSet) &#123;</span><br><span class="line">            <span class="type">BeanNameGenerator</span> <span class="variable">generator</span> <span class="operator">=</span> (BeanNameGenerator) singletonRegistry.getSingleton(</span><br><span class="line">                    AnnotationConfigUtils.CONFIGURATION_BEAN_NAME_GENERATOR);</span><br><span class="line">            <span class="keyword">if</span> (generator != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.componentScanBeanNameGenerator = generator;</span><br><span class="line">                <span class="built_in">this</span>.importBeanNameGenerator = generator;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.environment == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.environment = <span class="keyword">new</span> <span class="title class_">StandardEnvironment</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parse each @Configuration class</span></span><br><span class="line">    <span class="comment">// 通过ConfigurationClassParser解析@Configuration的类</span></span><br><span class="line">    <span class="type">ConfigurationClassParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigurationClassParser</span>(</span><br><span class="line">            <span class="built_in">this</span>.metadataReaderFactory, <span class="built_in">this</span>.problemReporter, <span class="built_in">this</span>.environment,</span><br><span class="line">            <span class="built_in">this</span>.resourceLoader, <span class="built_in">this</span>.componentScanBeanNameGenerator, registry);</span><br><span class="line"></span><br><span class="line">    Set&lt;BeanDefinitionHolder&gt; candidates = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(configCandidates);</span><br><span class="line">    Set&lt;ConfigurationClass&gt; alreadyParsed = CollectionUtils.newHashSet(configCandidates.size());</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="type">StartupStep</span> <span class="variable">processConfig</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.config-classes.parse&quot;</span>);</span><br><span class="line">        parser.parse(candidates);</span><br><span class="line">        parser.validate();</span><br><span class="line"></span><br><span class="line">        Set&lt;ConfigurationClass&gt; configClasses = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(parser.getConfigurationClasses());</span><br><span class="line">        configClasses.removeAll(alreadyParsed);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the model and create bean definitions based on its content</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.reader == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.reader = <span class="keyword">new</span> <span class="title class_">ConfigurationClassBeanDefinitionReader</span>(</span><br><span class="line">                    registry, <span class="built_in">this</span>.sourceExtractor, <span class="built_in">this</span>.resourceLoader, <span class="built_in">this</span>.environment,</span><br><span class="line">                    <span class="built_in">this</span>.importBeanNameGenerator, parser.getImportRegistry());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.reader.loadBeanDefinitions(configClasses);</span><br><span class="line">        alreadyParsed.addAll(configClasses);</span><br><span class="line">        processConfig.tag(<span class="string">&quot;classCount&quot;</span>, () -&gt; String.valueOf(configClasses.size())).end();</span><br><span class="line"></span><br><span class="line">        candidates.clear();</span><br><span class="line">        <span class="keyword">if</span> (registry.getBeanDefinitionCount() &gt; candidateNames.length) &#123;</span><br><span class="line">            String[] newCandidateNames = registry.getBeanDefinitionNames();</span><br><span class="line">            Set&lt;String&gt; oldCandidateNames = Set.of(candidateNames);</span><br><span class="line">            Set&lt;String&gt; alreadyParsedClasses = CollectionUtils.newHashSet(alreadyParsed.size());</span><br><span class="line">            <span class="keyword">for</span> (ConfigurationClass configurationClass : alreadyParsed) &#123;</span><br><span class="line">                alreadyParsedClasses.add(configurationClass.getMetadata().getClassName());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (String candidateName : newCandidateNames) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!oldCandidateNames.contains(candidateName)) &#123;</span><br><span class="line">                    <span class="type">BeanDefinition</span> <span class="variable">bd</span> <span class="operator">=</span> registry.getBeanDefinition(candidateName);</span><br><span class="line">                    <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, <span class="built_in">this</span>.metadataReaderFactory) &amp;&amp;</span><br><span class="line">                            !alreadyParsedClasses.contains(bd.getBeanClassName())) &#123;</span><br><span class="line">                        candidates.add(<span class="keyword">new</span> <span class="title class_">BeanDefinitionHolder</span>(bd, candidateName));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            candidateNames = newCandidateNames;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (!candidates.isEmpty());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span></span><br><span class="line">    <span class="keyword">if</span> (singletonRegistry != <span class="literal">null</span> &amp;&amp; !singletonRegistry.containsSingleton(IMPORT_REGISTRY_BEAN_NAME)) &#123;</span><br><span class="line">        singletonRegistry.registerSingleton(IMPORT_REGISTRY_BEAN_NAME, parser.getImportRegistry());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Store the PropertySourceDescriptors to contribute them Ahead-of-time if necessary</span></span><br><span class="line">    <span class="built_in">this</span>.propertySourceDescriptors = parser.getPropertySourceDescriptors();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.metadataReaderFactory <span class="keyword">instanceof</span> CachingMetadataReaderFactory cachingMetadataReaderFactory) &#123;</span><br><span class="line">        <span class="comment">// Clear cache in externally provided MetadataReaderFactory; this is a no-op</span></span><br><span class="line">        <span class="comment">// for a shared cache since it&#x27;ll be cleared by the ApplicationContext.</span></span><br><span class="line">        cachingMetadataReaderFactory.clearCache();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/03/04/springboot/SpringBoot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/04/springboot/SpringBoot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">SpringBoot启动流程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-04 00:00:38" itemprop="dateCreated datePublished" datetime="2025-03-04T00:00:38+08:00">2025-03-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-03-17 20:06:36" itemprop="dateModified" datetime="2025-03-17T20:06:36+08:00">2025-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/springboot/" itemprop="url" rel="index"><span itemprop="name">springboot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>Spring Boot 是一个开源的 Java 框架，用于简化 Spring 应用程序的开发。它是 Spring 生态系统的一部分，旨在帮助开发人员更快速和方便地创建独立、生产级的 Spring 应用。</p>
<ul>
<li><p>快速入门：Spring Boot 通过约定优于配置的原则，使开发者可以快速上手，无需繁琐的 XML 配置。</p>
</li>
<li><p>自带嵌入式服务器：Spring Boot 支持嵌入式服务器（如 Tomcat Jetty 和 Undertow），开发者无需单独部署应用服务器，可以直接运行 Java 应用。</p>
</li>
<li><p>自动配置：Spring Boot 提供了自动配置功能，根据项目的类路径和配置自动设置 Spring 应用的各种组件，减少了大量的配置工作。</p>
</li>
<li><p>生产级特性：Spring Boot 内置了许多生产环境所需的功能，如健康检查、指标监控、应用配置管理等。</p>
</li>
<li><p>开箱即用：Spring Boot 提供了一系列的 starter 依赖，简化了依赖管理。例如，spring-boot-starter-web 可以帮助快速构建基于 Spring MVC 的 web 应用。</p>
</li>
<li><p>支持微服务架构：Spring Boot 适合构建微服务应用，结合 Spring Cloud，能够实现分布式系统的开发。1.</p>
</li>
</ul>
</blockquote>
<h1 id="1-SpringBootApplication注解"><a href="#1-SpringBootApplication注解" class="headerlink" title="1.@SpringBootApplication注解"></a>1.<code>@SpringBootApplication</code>注解</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LearnApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(LearnApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpringBoot启动类中包含<code>@SpringBootApplication</code>注解和<code>SpringApplication.run(LearnApplication.class, args);</code>方法。SpringBoot的入口是main方法。本章节先讲解<code>@SpringBootApplication</code>注解。</p>
<blockquote>
<p>在 Java 中，<strong>注解（Annotation）</strong> 是一种元数据的形式，可以添加到代码中（例如类、方法、字段等），以提供额外的信息。注解本身并不直接影响代码的执行逻辑，但可以通过反射机制或编译时处理来实现特定的功能。</p>
<p>注解主要分为：</p>
<ul>
<li><p><strong>元注解</strong>：用于定义其他注解的行为  （<code>@Retention</code>,<code>@Target</code>,<code>@Documented</code>,<code>@Inherited</code>）</p>
</li>
<li><p><strong>内置注解</strong>：该类注解的执行器被内置到了Javac中，由Javac负责解析注解。（<code>@Override</code>,<code>@Deprecated</code>,<code>@SuppressWarnings</code>）</p>
</li>
<li><p><strong>自定义注解</strong>：使用元注解自定义注解，需要编写<em>注解处理器</em>来处理该类注解。自定义注解的处理取决于<code>@Retention</code>定义的阶段。</p>
<ul>
<li><p><code>RetentionPolicy.SOURCE</code>：注解仅保留在源代码中，编译后丢弃。该类注解由编译器或源码级工具在编译时处理。</p>
<p>注：内置注解也属于该类，但内置注解是嵌入到编译器中的语义分析和语法分析中，属于编译器的一部分。但该类的自定义注解的处理需要通过<strong>注解处理器（Annotation Processor）</strong>处理，在 javac 编译时，注解处理器会扫描源代码中的注解，并根据注解信息执行特定逻辑，例如生成新代码、验证规则或抛出错误，比较常用的就是Lombok的注解。</p>
</li>
<li><p><code>RetentionPolicy.CLASS</code>：注解保留在编译后的 .class 文件中，但运行时不可见。也是由<strong>注解处理器（Annotation Processor）</strong>处理。用于生成代码或验证，可用在构建工具中，一般不常用。</p>
</li>
<li><p><code>RetentionPolicy.RUNTIME</code>：注解保留到运行时，可通过反射访问。由程序在运行时通过反射动态读取和处理。比较常见的就是各种框架，如SpringBoot。</p>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>通过<code>@SpringBootApplication</code>注解的源码注释可以得出，其为一个组合注解，组合了<code>@SpringBootConfiguration</code>, <code>@EnableAutoConfiguration</code>, <code>@ComponentScan</code>。经过后面的源码分析，可以得出SpringBoot并不是直接处理<code>@SpringBootApplication</code>而是处理他的三个组合注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123; @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span></span><br><span class="line"><span class="meta">		@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@AliasFor(annotation = EnableAutoConfiguration.class)</span></span><br><span class="line">	Class&lt;?&gt;[] exclude() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@AliasFor(annotation = ComponentScan.class, attribute = &quot;basePackages&quot;)</span></span><br><span class="line">	String[] scanBasePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@AliasFor(annotation = ComponentScan.class, attribute = &quot;basePackageClasses&quot;)</span></span><br><span class="line">	Class&lt;?&gt;[] scanBasePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@AliasFor(annotation = ComponentScan.class, attribute = &quot;nameGenerator&quot;)</span></span><br><span class="line">	Class&lt;? <span class="keyword">extends</span> <span class="title class_">BeanNameGenerator</span>&gt; nameGenerator() <span class="keyword">default</span> BeanNameGenerator.class;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@AliasFor(annotation = Configuration.class)</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">proxyBeanMethods</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>@SpringBootConfiguration</code>组合了<code>@Configuration</code>，表明是一个Java配置类</li>
<li><code>@EnableAutoConfiguration</code> 组合了<code>@AutoConfigurationPackage</code>和<code>@Import(AutoConfigurationImportSelector.class)</code>用于将所有符合配置条件的 Bean 都加载到 IOC 容器中</li>
<li><code>@ComponentScan</code>指明了包搜索路径以及需要过滤的类</li>
</ul>
<h1 id="2-SpringApplication-run-LearnApplication-class-args"><a href="#2-SpringApplication-run-LearnApplication-class-args" class="headerlink" title="2.SpringApplication.run(LearnApplication.class, args);"></a>2.<code>SpringApplication.run(LearnApplication.class, args);</code></h1><p><code>SpringApplication.run(LearnApplication.class, args);</code>是整个SpringBoot的入口。查看源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(Class&lt;?&gt;[] primarySources, String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(primarySources).run(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建<code>ConfigurableApplicationContext</code>实例</li>
<li>运行该实例</li>
</ul>
<h2 id="SpringAplplication构造函数"><a href="#SpringAplplication构造函数" class="headerlink" title="SpringAplplication构造函数"></a>SpringAplplication构造函数</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">    Assert.notNull(primarySources, <span class="string">&quot;PrimarySources must not be null&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.primarySources = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(Arrays.asList(primarySources));</span><br><span class="line">    <span class="comment">//判断WEB应用的类型</span></span><br><span class="line">    <span class="built_in">this</span>.properties.setWebApplicationType(WebApplicationType.deduceFromClasspath());</span><br><span class="line">    <span class="comment">// 将类型为BootstrapRegistryInitializer的初始化类数组赋值给this.bootstrapRegistryInitializers</span></span><br><span class="line">    <span class="built_in">this</span>.bootstrapRegistryInitializers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">            getSpringFactoriesInstances(BootstrapRegistryInitializer.class));</span><br><span class="line">    <span class="comment">//将类型为ApplicationContextInitializer的初始化类数组赋值给this.initializers</span></span><br><span class="line">    setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));</span><br><span class="line">    <span class="comment">//将类型为ApplicationListener的监听类数组赋值给this.listeners</span></span><br><span class="line">    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));</span><br><span class="line">    <span class="comment">// 从调用栈中拿到main方法所在的类</span></span><br><span class="line">    <span class="built_in">this</span>.mainApplicationClass = deduceMainApplicationClass();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Class&lt;?&gt; deduceMainApplicationClass() &#123;</span><br><span class="line">    <span class="comment">//使用Java9引入的StackWalker遍历当前线程的调用栈</span></span><br><span class="line">    <span class="keyword">return</span> StackWalker.getInstance(StackWalker.Option.RETAIN_CLASS_REFERENCE)</span><br><span class="line">        <span class="comment">// 找到第一个包含main方法的类并返回它的Class&lt;?&gt;</span></span><br><span class="line">        .walk(<span class="built_in">this</span>::findMainClass)</span><br><span class="line">        <span class="comment">//找不到返回null</span></span><br><span class="line">        .orElse(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> Optional&lt;Class&lt;?&gt;&gt; findMainClass(Stream&lt;StackFrame&gt; stack) &#123;</span><br><span class="line">    <span class="keyword">return</span> stack.filter((frame) -&gt; Objects.equals(frame.getMethodName(), <span class="string">&quot;main&quot;</span>))</span><br><span class="line">        .findFirst()</span><br><span class="line">        .map(StackWalker.StackFrame::getDeclaringClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpringApplication 构造函数的参数是资源加载器和主程序源（SpringBoot启动类）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断WEB应用的类型</span></span><br><span class="line"><span class="built_in">this</span>.properties.setWebApplicationType(WebApplicationType.deduceFromClasspath());</span><br></pre></td></tr></table></figure>

<p><code>WebApplicationType</code>有三种类型：</p>
<ul>
<li><code>NONE</code>：程序不是WEB应用，不需要启动内置WEB服务器</li>
<li><code>SERVLET</code>： 程序是WEB应用，需要启动WEB服务器</li>
<li><code>REACTIVE</code>：程序是响应式WEB应用，启动REACTIVE WEB服务器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] SERVLET_INDICATOR_CLASSES = &#123; <span class="string">&quot;jakarta.servlet.Servlet&quot;</span>,</span><br><span class="line">        <span class="string">&quot;org.springframework.web.context.ConfigurableWebApplicationContext&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WEBMVC_INDICATOR_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.springframework.web.servlet.DispatcherServlet&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WEBFLUX_INDICATOR_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.springframework.web.reactive.DispatcherHandler&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JERSEY_INDICATOR_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.glassfish.jersey.servlet.ServletContainer&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> WebApplicationType <span class="title function_">deduceFromClasspath</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ClassUtils.isPresent(WEBFLUX_INDICATOR_CLASS, <span class="literal">null</span>) &amp;&amp; !ClassUtils.isPresent(WEBMVC_INDICATOR_CLASS, <span class="literal">null</span>)</span><br><span class="line">            &amp;&amp; !ClassUtils.isPresent(JERSEY_INDICATOR_CLASS, <span class="literal">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> WebApplicationType.REACTIVE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (String className : SERVLET_INDICATOR_CLASSES) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ClassUtils.isPresent(className, <span class="literal">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> WebApplicationType.NONE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> WebApplicationType.SERVLET;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>判断方法很简单，就是寻找在Classpath加载路径上有某些Class，比如有<code>DispatcherHandler</code>且没有<code>DispatcherServlet</code>和<code>ServletContainer</code>则是响应式WEB应用。如果包含<code>Servlet</code> <code>ConfigurableWebApplicationContext</code>则是Servlet WEB应用。否则就不是WEB应用。</p>
<p>下面三个赋值中都使用了<code>getSpringFactoriesInstances()</code>用于获取Spring工厂对象。即将对应的class文件加载到内存对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">getSpringFactoriesInstances</span><span class="params">(Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getSpringFactoriesInstances(type, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">getSpringFactoriesInstances</span><span class="params">(Class&lt;T&gt; type, ArgumentResolver argumentResolver)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> SpringFactoriesLoader.forDefaultResourceLocation(getClassLoader()).load(type, argumentResolver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getSpringFactoriesInstances"><a href="#getSpringFactoriesInstances" class="headerlink" title="getSpringFactoriesInstances()"></a><code>getSpringFactoriesInstances()</code></h3><blockquote>
<p>classpath 是Java的系统变量，Javac通过classpath寻找class文件或依赖包。classpath默认路径是当前目录下（<code>./</code>）以及<code>javac -cp xxx</code>指定的路径。</p>
<p>在SpringBoot中，对classpath进行了增强：</p>
<ul>
<li><p>开发模式：classpath 包含了<code>target/classes/</code>(编译前来自于<code>src/main/resources/</code>)和Maven从本地仓库中获取的依赖包（<code>~/.m2/repository/xxx.jar</code>)。此模式下Maven会解析pom.xml，并自动添加<code>~/.m2/repository/</code> 里的 JAR 到 classpath</p>
</li>
<li><p>Spring Boot Fat JAR 模式：此时SpringBoot不使用classpath，而是用 <code>LaunchedURLClassLoader</code> 来解析 <code>BOOT-INF/lib/</code> 里的 JAR。此模式下Maven会将依赖包从<code>~/.m2/repository/</code>中直接复制到<code>target/myapp-1.0.0.jar/BOOT-INF/lib/</code>中。</p>
</li>
</ul>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">target/myapp-1.0.0.jar</span><br><span class="line"> ├── BOOT-INF/classes/        <span class="comment"># 编译后的 .class 文件</span></span><br><span class="line"> ├── BOOT-INF/lib/            <span class="comment"># 所有依赖的 JAR</span></span><br><span class="line"> ├── META-INF/MANIFEST.MF     <span class="comment"># 启动信息</span></span><br><span class="line"> ├── org/springframework/...  <span class="comment"># Spring 相关类</span></span><br></pre></td></tr></table></figure>

<p>注：开发模式中，也可以不使用Maven的启动，直接使用Java命令。编译之后执行<code>java -cp target/classes:$(mvn dependency:build-classpath) com.example.MainApplication</code>，使用<code>-cp</code>参数将<code>target/classes</code>和<code>~/.m2/repository/</code>下的依赖包添加到classpath中，也可以正常启动项目。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//maven中查看依赖</span><br><span class="line">mvn dependency:tree</span><br><span class="line">//输出依赖的完整路径</span><br><span class="line">mvn dependency:build-classpath</span><br></pre></td></tr></table></figure>
</blockquote>
<p>了解了classpath工作原理，重点讲解<code>SpringFactoriesLoader.forDefaultResourceLocation(getClassLoader()).load(type, argumentResolver);</code>该类是利用<code>classloader</code>将classpath中的所有满足要求的类都加载进来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SpringFactoriesLoader <span class="title function_">forDefaultResourceLocation</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> forResourceLocation(FACTORIES_RESOURCE_LOCATION, classLoader);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SpringFactoriesLoader <span class="title function_">forResourceLocation</span><span class="params">(String resourceLocation, <span class="meta">@Nullable</span> ClassLoader classLoader)</span> &#123;</span><br><span class="line">    Assert.hasText(resourceLocation, <span class="string">&quot;&#x27;resourceLocation&#x27; must not be empty&quot;</span>);</span><br><span class="line">    <span class="comment">//获取classloader</span></span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">resourceClassLoader</span> <span class="operator">=</span> (classLoader != <span class="literal">null</span> ? classLoader :</span><br><span class="line">            SpringFactoriesLoader.class.getClassLoader());</span><br><span class="line">    <span class="comment">//从缓存中查看该classloader是否存在，如果没有创建一个cache[classloader]=hashmap&lt;string, SpringFactoriesLoader&gt; </span></span><br><span class="line">    <span class="comment">//并将该hashmap返回给loaders</span></span><br><span class="line">    Map&lt;String, SpringFactoriesLoader&gt; loaders = cache.computeIfAbsent(</span><br><span class="line">            resourceClassLoader, key -&gt; <span class="keyword">new</span> <span class="title class_">ConcurrentReferenceHashMap</span>&lt;&gt;());</span><br><span class="line">    <span class="comment">//获取loaders[&quot;META-INF/spring.factories&quot;]，如果不存在，创建一个新的SpringFactoriesLoader</span></span><br><span class="line">    <span class="comment">//参数1:classloader</span></span><br><span class="line">    <span class="comment">//参数2:factories : Map&lt;String, List&lt;String&gt;&gt;</span></span><br><span class="line">    <span class="keyword">return</span> loaders.computeIfAbsent(resourceLocation, key -&gt;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SpringFactoriesLoader</span>(classLoader, loadFactoriesResource(resourceClassLoader, resourceLocation)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>FACTORIES_RESOURCE_LOCATION = &quot;META-INF/spring.factories&quot;</code>，ClassLoader是默认的类加载器 <code>Thread.currentThread().getContextClassLoader();</code> 通过调试<code>classloader = ClassLoaders$AppClassLoader</code></p>
<p><code>loadFactoriesResource()</code>会将符合条件的类加载进来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//classloader = ClassLoaders$AppClassLoader</span></span><br><span class="line"><span class="comment">//resourceLocation = &quot;META-INF/spring.factories&quot;</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">loadFactoriesResource</span><span class="params">(ClassLoader classLoader, String resourceLocation)</span> &#123;</span><br><span class="line">    	<span class="comment">//result中包含[初始化类型，对应需要加载的所有初始化类]</span></span><br><span class="line">		Map&lt;String, List&lt;String&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//classLoader将classpath路径下的所有的resourceLocation文件都加载到urls中</span></span><br><span class="line">            <span class="comment">//urls中包含了所有META-INF/spring.factories的文件路径</span></span><br><span class="line">			Enumeration&lt;URL&gt; urls = classLoader.getResources(resourceLocation);</span><br><span class="line">			<span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">                <span class="comment">//根据urls中的文件路径加载到UrlResource中</span></span><br><span class="line">                <span class="comment">//举个例子 resource=jar:file:/home/amber/.m2/repository/org/springframework/boot/spring-boot/3.4.3/spring-boot-3.4.3.jar!/META-INF/spring.factories</span></span><br><span class="line">				<span class="type">UrlResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlResource</span>(urls.nextElement());</span><br><span class="line">                <span class="comment">//将文件中的所有属性加载到properties中</span></span><br><span class="line">                <span class="comment">//Properties 是一个 ConcurrentHashMap&lt;Object, Object&gt;</span></span><br><span class="line">				<span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">                <span class="comment">//遍历所有属性</span></span><br><span class="line">				properties.forEach((name, value) -&gt; &#123;</span><br><span class="line">                    <span class="comment">//以逗号分割，将value字符串分割为String[]数组</span></span><br><span class="line">					String[] factoryImplementationNames = StringUtils.commaDelimitedListToStringArray((String) value);</span><br><span class="line">                    <span class="comment">//将&#123;name: ArrayList&lt;String&gt;&#123;&#125;&#125;放入到result中,ArrayList的长度就是value数组的长度</span></span><br><span class="line">					List&lt;String&gt; implementations = result.computeIfAbsent(((String) name).trim(),</span><br><span class="line">							key -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(factoryImplementationNames.length));</span><br><span class="line">                    <span class="comment">//将factoryImplementationNames流化，将每一个元素都trim后再将每一个元素添加到implementations中</span></span><br><span class="line">					Arrays.stream(factoryImplementationNames).map(String::trim).forEach(implementations::add);</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">//对每一种初始化类型中的所有初始化类去重</span></span><br><span class="line">			result.replaceAll(SpringFactoriesLoader::toDistinctUnmodifiableList);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unable to load factories from location [&quot;</span> + resourceLocation + <span class="string">&quot;]&quot;</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">    	<span class="comment">//返回一个不可以修改的Map，最终赋值给了SpringFactoriesLoader.factories</span></span><br><span class="line">		<span class="keyword">return</span> Collections.unmodifiableMap(result);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file:/home/amber/.m2/repository/org/springframework/boot/spring-boot/3.4.3/spring-boot-3.4.3.jar!/META-INF/spring.factories</span></span><br><span class="line"><span class="comment"># Logging Systems</span></span><br><span class="line"><span class="attr">org.springframework.boot.logging.LoggingSystemFactory</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.boot.logging.logback.LogbackLoggingSystem.Factory,\</span></span><br><span class="line"><span class="string">org.springframework.boot.logging.log4j2.Log4J2LoggingSystem.Factory,\</span></span><br><span class="line"><span class="string">org.springframework.boot.logging.java.JavaLoggingSystem.Factory</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># PropertySource Loaders</span></span><br><span class="line"><span class="attr">org.springframework.boot.env.PropertySourceLoader</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.boot.env.PropertiesPropertySourceLoader,\</span></span><br><span class="line"><span class="string">org.springframework.boot.env.YamlPropertySourceLoader</span></span><br><span class="line"><span class="attr">.....</span></span><br></pre></td></tr></table></figure>

<p>到目前已经通过<code>SpringFactoriesLoader.forDefaultResourceLocation(getClassLoader())</code>得到了<code>SpringFactoriesLoader</code>对象，其中包含了<code>SpringFactoriesLoader.classLoader</code>,<code>SpringFactoriesLoader.factories</code>。后续调用了该对象的<code>load(type, argumentResolver)</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">load</span><span class="params">(Class&lt;T&gt; factoryType, <span class="meta">@Nullable</span> FailureHandler failureHandler)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> load(factoryType, <span class="literal">null</span>, failureHandler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">load</span><span class="params">(Class&lt;T&gt; factoryType, <span class="meta">@Nullable</span> ArgumentResolver argumentResolver,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> FailureHandler failureHandler)</span> &#123;</span><br><span class="line"></span><br><span class="line">    Assert.notNull(factoryType, <span class="string">&quot;&#x27;factoryType&#x27; must not be null&quot;</span>);</span><br><span class="line">    <span class="comment">//构造函数中已经把&#123;初始化类型：[对应类型的实现类数组]&#125;放入到factories中</span></span><br><span class="line">    <span class="comment">//取出初始化类型为factoryType的类数组</span></span><br><span class="line">    List&lt;String&gt; implementationNames = loadFactoryNames(factoryType);</span><br><span class="line">    logger.trace(LogMessage.format(<span class="string">&quot;Loaded [%s] names: %s&quot;</span>, factoryType.getName(), implementationNames));</span><br><span class="line">    <span class="comment">//结果是一个类型为T的列表</span></span><br><span class="line">    List&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(implementationNames.size());</span><br><span class="line">    <span class="type">FailureHandler</span> <span class="variable">failureHandlerToUse</span> <span class="operator">=</span> (failureHandler != <span class="literal">null</span>) ? failureHandler : THROWING_FAILURE_HANDLER;</span><br><span class="line">    <span class="comment">//遍历所有的实现类</span></span><br><span class="line">    <span class="keyword">for</span> (String implementationName : implementationNames) &#123;</span><br><span class="line">        <span class="comment">//将实现类实例化</span></span><br><span class="line">        <span class="type">T</span> <span class="variable">factory</span> <span class="operator">=</span> instantiateFactory(implementationName, factoryType, argumentResolver, failureHandlerToUse);</span><br><span class="line">        <span class="comment">//将实例化的实现类放入到result中</span></span><br><span class="line">        <span class="keyword">if</span> (factory != <span class="literal">null</span>) &#123;</span><br><span class="line">            result.add(factory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据@Order @Priority对实现类进行排序</span></span><br><span class="line">    AnnotationAwareOrderComparator.sort(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;String&gt; <span class="title function_">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryType)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.factories.getOrDefault(factoryType.getName(), Collections.emptyList());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">instantiateFactory</span><span class="params">(String implementationName, Class&lt;T&gt; type,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> ArgumentResolver argumentResolver, FailureHandler failureHandler)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//使用class.forName(xxx, false, zzz)将xxx类加载到元数据区，只类加载不执行类初始化</span></span><br><span class="line">        Class&lt;?&gt; factoryImplementationClass = ClassUtils.forName(implementationName, <span class="built_in">this</span>.classLoader);</span><br><span class="line">        Assert.isTrue(type.isAssignableFrom(factoryImplementationClass), () -&gt;</span><br><span class="line">                <span class="string">&quot;Class [%s] is not assignable to factory type [%s]&quot;</span>.formatted(implementationName, type.getName()));</span><br><span class="line">        <span class="comment">//创建一个用于初始化factoryImplementationClass类的内部创建类（该类包含了factoryImplementationClass的构造方法）</span></span><br><span class="line">        FactoryInstantiator&lt;T&gt; factoryInstantiator = FactoryInstantiator.forClass(factoryImplementationClass);</span><br><span class="line">        <span class="comment">// 处理构造函数所需的参数，使用this.constructor.newInstance(args)创建factoryImplementationClass类</span></span><br><span class="line">        <span class="keyword">return</span> factoryInstantiator.instantiate(argumentResolver);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        failureHandler.handleFailure(type, implementationName, ex);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到目前为止，得出了<code>getSpringFactoriesInstances(xxx.class)</code>方法是将初始化类型为xxx.class的类从<code>META-INF/spring.factories</code>中提取出来，并返回该类型的所有的实现类，返回的是一个xxx.class类型的数组。</p>
<p><code>ConfigurableApplicationContext</code>后续的三个赋值都是利用<code>getSpringFactoriesInstances(xxx.class)</code>将初始化类数组赋值给类成员，最后一步是从调用栈中获取main方法所在的类。</p>
<h1 id="2-执行SpringApplication的run方法"><a href="#2-执行SpringApplication的run方法" class="headerlink" title="2. 执行SpringApplication的run方法"></a>2. 执行<code>SpringApplication</code>的run方法</h1><p><code>SpringApplication</code>构造函数中都是一些赋值操作，run方法才是真正启动SpringBoot项目。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(String... args)</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化启动时钟</span></span><br><span class="line">    <span class="type">Startup</span> <span class="variable">startup</span> <span class="operator">=</span> Startup.create();</span><br><span class="line">    <span class="comment">// 检查properties中是否注册关闭钩子</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isRegisterShutdownHook()) &#123;</span><br><span class="line">        <span class="comment">//启 Shutdown Hook注册机制，保证Spring Boot应用在JVM关闭时能够正确释放资源（如数据库连接池、线程池等）。</span></span><br><span class="line">        SpringApplication.shutdownHook.enableShutdownHookAddition();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建引导上下文</span></span><br><span class="line">    <span class="type">DefaultBootstrapContext</span> <span class="variable">bootstrapContext</span> <span class="operator">=</span> createBootstrapContext();</span><br><span class="line">    <span class="comment">// 创建应用上下文</span></span><br><span class="line">    <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 将环境变量中java.awt.headless设置为原值或者默认true</span></span><br><span class="line">    configureHeadlessProperty();</span><br><span class="line">    <span class="comment">// 用getSpringFactoriesInstances()方法获取了所有类型为</span></span><br><span class="line">    <span class="comment">// SpringApplicationRunListener.class的启动监听类，</span></span><br><span class="line">    <span class="comment">// 将其封装在SpringApplicationRunListeners类中</span></span><br><span class="line">    <span class="type">SpringApplicationRunListeners</span> <span class="variable">listeners</span> <span class="operator">=</span> getRunListeners(args);</span><br><span class="line">    <span class="comment">// 将bootstrapContext传递给所有的启动监听类</span></span><br><span class="line">    listeners.starting(bootstrapContext, <span class="built_in">this</span>.mainApplicationClass);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 解析命令行传入的参数，并封装到ApplicationArguments</span></span><br><span class="line">        <span class="type">ApplicationArguments</span> <span class="variable">applicationArguments</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultApplicationArguments</span>(args);</span><br><span class="line">        <span class="comment">// 准备环境</span></span><br><span class="line">        <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> prepareEnvironment(listeners, bootstrapContext, applicationArguments);</span><br><span class="line">        <span class="comment">// 打印Banner 根据条件 判断打印到log还是console，是使用默认值还是指定banner</span></span><br><span class="line">        <span class="type">Banner</span> <span class="variable">printedBanner</span> <span class="operator">=</span> printBanner(environment);</span><br><span class="line">        <span class="comment">// 根据WebApplicationType创建 应用程序上下文</span></span><br><span class="line">        <span class="comment">// 获取META-INF/spring.factories中的ApplicationContextFactory接口实现类</span></span><br><span class="line">        <span class="comment">// ReactiveWebServerApplicationContextFactory 创建了 ReactiveWebServerApplicationContext</span></span><br><span class="line">        <span class="comment">// ServletWebServerApplicationContextFactory 创建了 ServletWebServerApplicationContext</span></span><br><span class="line">        context = createApplicationContext();</span><br><span class="line">        <span class="comment">// 将applicationStartup赋值给context</span></span><br><span class="line">        <span class="comment">// applicationStartup 用于收集和分析应用的启动性能数据，帮助开发者优化 Spring Boot 启动过程</span></span><br><span class="line">        context.setApplicationStartup(<span class="built_in">this</span>.applicationStartup);</span><br><span class="line">        <span class="comment">// 准备 应用程序上下文</span></span><br><span class="line">        <span class="comment">// 将参数绑定到应用程序上下文（ApplicationContext）为应用程序启动运行做好准备</span></span><br><span class="line">        prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">        <span class="comment">// 启动 应用上下文 （SpringBoot核心启动方法）</span></span><br><span class="line">        refreshContext(context);</span><br><span class="line">        <span class="comment">// 刷新之后需要的处理，默认是空</span></span><br><span class="line">        afterRefresh(context, applicationArguments);</span><br><span class="line">        <span class="comment">//SpringBoot启动</span></span><br><span class="line">        startup.started();</span><br><span class="line">        <span class="comment">//日志	</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isLogStartupInfo()) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">StartupInfoLogger</span>(<span class="built_in">this</span>.mainApplicationClass, environment).logStarted(getApplicationLog(), startup);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将ConfigurableApplicationContext传递给所有的启动监听类，表明started</span></span><br><span class="line">        listeners.started(context, startup.timeTakenToStarted());</span><br><span class="line">        callRunners(context, applicationArguments);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> handleRunFailure(context, ex, listeners);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (context.isRunning()) &#123;</span><br><span class="line">            listeners.ready(context, startup.ready());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> handleRunFailure(context, ex, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建引导程序上下文createBootstrapContext"><a href="#创建引导程序上下文createBootstrapContext" class="headerlink" title="创建引导程序上下文createBootstrapContext()"></a>创建引导程序上下文<code>createBootstrapContext()</code></h2><p>引导程序上下文的作用：<strong>在 <code>SpringApplication</code> 启动过程中，提前注册某些组件，以便在应用上下文（<code>ApplicationContext</code>）正式创建时使用</strong>。</p>
<p><code>DefaultBootstrapContext</code> 存在的时间非常短，它只在 <code>SpringApplication.run()</code> 方法执行的早期阶段存在，等 <code>ApplicationContext</code> 初始化完成后，它就会被丢弃。</p>
<p>引导上下文主要用于支持 <strong>Spring Cloud</strong> 的配置加载机制（例如 Spring Cloud Config）。它并不是 Spring Boot 核心的一部分，而是 Spring Cloud 提供的高级功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DefaultBootstrapContext</span> <span class="variable">bootstrapContext</span> <span class="operator">=</span> createBootstrapContext();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> DefaultBootstrapContext <span class="title function_">createBootstrapContext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 创建引导上下文</span></span><br><span class="line">    <span class="type">DefaultBootstrapContext</span> <span class="variable">bootstrapContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultBootstrapContext</span>();</span><br><span class="line">    <span class="comment">// 构造函数中已经将BootstrapRegistryInitializer类型的初始化类型数组赋值给了this.bootstrapRegistryInitializers</span></span><br><span class="line">    <span class="comment">// 遍历初始化类型数组，并执行每一个初始化类型的initialize方法，将引导上下文DefaultBootstrapContext赋值给它</span></span><br><span class="line">    <span class="built_in">this</span>.bootstrapRegistryInitializers.forEach((initializer) -&gt; initializer.initialize(bootstrapContext));</span><br><span class="line">    <span class="keyword">return</span> bootstrapContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="监听类SpringApplicationRunListeners"><a href="#监听类SpringApplicationRunListeners" class="headerlink" title="监听类SpringApplicationRunListeners"></a>监听类<code>SpringApplicationRunListeners</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SpringApplicationRunListeners <span class="title function_">getRunListeners</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ArgumentResolver</span> <span class="variable">argumentResolver</span> <span class="operator">=</span> ArgumentResolver.of(SpringApplication.class, <span class="built_in">this</span>);</span><br><span class="line">    argumentResolver = argumentResolver.and(String[].class, args);</span><br><span class="line">    <span class="comment">// 通过getSpringFactoriesInstances()获取所有接口为SpringApplicationRunListener.class的实现类</span></span><br><span class="line">    List&lt;SpringApplicationRunListener&gt; listeners = getSpringFactoriesInstances(SpringApplicationRunListener.class,</span><br><span class="line">            argumentResolver);</span><br><span class="line">    <span class="type">SpringApplicationHook</span> <span class="variable">hook</span> <span class="operator">=</span> applicationHook.get();</span><br><span class="line">    <span class="type">SpringApplicationRunListener</span> <span class="variable">hookListener</span> <span class="operator">=</span> (hook != <span class="literal">null</span>) ? hook.getRunListener(<span class="built_in">this</span>) : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (hookListener != <span class="literal">null</span>) &#123;</span><br><span class="line">        listeners = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(listeners);</span><br><span class="line">        listeners.add(hookListener);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将监听类List和applicationStartup传递給SpringApplicationRunListeners</span></span><br><span class="line">    <span class="comment">// 其中this.applicationStartup是一个性能分析工具，默认状态下，它什么都没做，是一个空实现。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringApplicationRunListeners</span>(logger, listeners, <span class="built_in">this</span>.applicationStartup);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如<code>starting()</code>方法赋值监听名称为<code>&quot;spring.boot.application.starting&quot;</code>并将bootstrapContext通过<code>listener.starting()</code>赋值给每一个监听类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SpringApplicationRunListeners</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Log log;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;SpringApplicationRunListener&gt; listeners;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ApplicationStartup applicationStartup;</span><br><span class="line"></span><br><span class="line">	SpringApplicationRunListeners(Log log, List&lt;SpringApplicationRunListener&gt; listeners,</span><br><span class="line">			ApplicationStartup applicationStartup) &#123;</span><br><span class="line">		<span class="built_in">this</span>.log = log;</span><br><span class="line">		<span class="built_in">this</span>.listeners = List.copyOf(listeners);</span><br><span class="line">		<span class="built_in">this</span>.applicationStartup = applicationStartup;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">starting</span><span class="params">(ConfigurableBootstrapContext bootstrapContext, Class&lt;?&gt; mainApplicationClass)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.starting&quot;</span>, (listener) -&gt; listener.starting(bootstrapContext),</span><br><span class="line">				(step) -&gt; &#123;</span><br><span class="line">					<span class="keyword">if</span> (mainApplicationClass != <span class="literal">null</span>) &#123;</span><br><span class="line">						step.tag(<span class="string">&quot;mainApplicationClass&quot;</span>, mainApplicationClass.getName());</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">environmentPrepared</span><span class="params">(ConfigurableBootstrapContext bootstrapContext, ConfigurableEnvironment environment)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.environment-prepared&quot;</span>,</span><br><span class="line">				(listener) -&gt; listener.environmentPrepared(bootstrapContext, environment));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">contextPrepared</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.context-prepared&quot;</span>, (listener) -&gt; listener.contextPrepared(context));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">contextLoaded</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.context-loaded&quot;</span>, (listener) -&gt; listener.contextLoaded(context));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">started</span><span class="params">(ConfigurableApplicationContext context, Duration timeTaken)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.started&quot;</span>, (listener) -&gt; listener.started(context, timeTaken));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">ready</span><span class="params">(ConfigurableApplicationContext context, Duration timeTaken)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.ready&quot;</span>, (listener) -&gt; listener.ready(context, timeTaken));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(ConfigurableApplicationContext context, Throwable exception)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.failed&quot;</span>,</span><br><span class="line">				(listener) -&gt; callFailedListener(listener, context, exception), (step) -&gt; &#123;</span><br><span class="line">					step.tag(<span class="string">&quot;exception&quot;</span>, exception.getClass().toString());</span><br><span class="line">					step.tag(<span class="string">&quot;message&quot;</span>, exception.getMessage());</span><br><span class="line">				&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">callFailedListener</span><span class="params">(SpringApplicationRunListener listener, ConfigurableApplicationContext context,</span></span><br><span class="line"><span class="params">			Throwable exception)</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			listener.failed(context, exception);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">			<span class="keyword">if</span> (exception == <span class="literal">null</span>) &#123;</span><br><span class="line">				ReflectionUtils.rethrowRuntimeException(ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.log.isDebugEnabled()) &#123;</span><br><span class="line">				<span class="built_in">this</span>.log.error(<span class="string">&quot;Error handling failed&quot;</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> ex.getMessage();</span><br><span class="line">				message = (message != <span class="literal">null</span>) ? message : <span class="string">&quot;no error message&quot;</span>;</span><br><span class="line">				<span class="built_in">this</span>.log.warn(<span class="string">&quot;Error handling failed (&quot;</span> + message + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doWithListeners</span><span class="params">(String stepName, Consumer&lt;SpringApplicationRunListener&gt; listenerAction)</span> &#123;</span><br><span class="line">		doWithListeners(stepName, listenerAction, <span class="literal">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//每一个方法都调用了doWithListeners()</span></span><br><span class="line">    <span class="comment">//参数1：步骤名称</span></span><br><span class="line">    <span class="comment">//参数2：消费型函数式接口，它可以接收一个 SpringApplicationRunListener 对象，并对其执行某些操作。</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doWithListeners</span><span class="params">(String stepName, Consumer&lt;SpringApplicationRunListener&gt; listenerAction,</span></span><br><span class="line"><span class="params">			Consumer&lt;StartupStep&gt; stepAction)</span> &#123;</span><br><span class="line">        <span class="comment">// 性能监听，默认是空函数</span></span><br><span class="line">		<span class="type">StartupStep</span> <span class="variable">step</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(stepName);</span><br><span class="line">        <span class="comment">// listeners是SpringApplicationRunListener对象的List</span></span><br><span class="line">        <span class="comment">// 对listeners中的每一个SpringApplicationRunListener对象执行listenerAction方法。</span></span><br><span class="line">		<span class="built_in">this</span>.listeners.forEach(listenerAction);</span><br><span class="line">		<span class="keyword">if</span> (stepAction != <span class="literal">null</span>) &#123;</span><br><span class="line">			stepAction.accept(step);</span><br><span class="line">		&#125;</span><br><span class="line">		step.end();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="准备环境-prepareEnvironment"><a href="#准备环境-prepareEnvironment" class="headerlink" title="准备环境 prepareEnvironment()"></a>准备环境 <code>prepareEnvironment()</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ConfigurableEnvironment <span class="title function_">prepareEnvironment</span><span class="params">(SpringApplicationRunListeners listeners,</span></span><br><span class="line"><span class="params">        DefaultBootstrapContext bootstrapContext, ApplicationArguments applicationArguments)</span> &#123;</span><br><span class="line">    <span class="comment">// Create and configure the environment</span></span><br><span class="line">    <span class="comment">// 根据应用类型创建对应的环境类</span></span><br><span class="line">    <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> getOrCreateEnvironment();</span><br><span class="line">    <span class="comment">// 将命令行的参数添加到Springboot环境变量中</span></span><br><span class="line">    <span class="comment">// 配置spring.profiles.active</span></span><br><span class="line">    configureEnvironment(environment, applicationArguments.getSourceArgs());</span><br><span class="line">    <span class="comment">// 将 ConfigurationPropertySources 附加到 Environment，让 Spring Environment 识别 ConfigurationPropertySource</span></span><br><span class="line">    ConfigurationPropertySources.attach(environment);</span><br><span class="line">    <span class="comment">// 告诉所有的监听类，环境准备阶段</span></span><br><span class="line">    listeners.environmentPrepared(bootstrapContext, environment);</span><br><span class="line">    ApplicationInfoPropertySource.moveToEnd(environment);</span><br><span class="line">    DefaultPropertiesPropertySource.moveToEnd(environment);</span><br><span class="line">    Assert.state(!environment.containsProperty(<span class="string">&quot;spring.main.environment-prefix&quot;</span>),</span><br><span class="line">            <span class="string">&quot;Environment prefix cannot be set via properties.&quot;</span>);</span><br><span class="line">    bindToSpringApplication(environment);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.isCustomEnvironment) &#123;</span><br><span class="line">        <span class="type">EnvironmentConverter</span> <span class="variable">environmentConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EnvironmentConverter</span>(getClassLoader());</span><br><span class="line">        environment = environmentConverter.convertEnvironmentIfNecessary(environment, deduceEnvironmentClass());</span><br><span class="line">    &#125;</span><br><span class="line">    ConfigurationPropertySources.attach(environment);</span><br><span class="line">    <span class="keyword">return</span> environment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ConfigurableEnvironment <span class="title function_">getOrCreateEnvironment</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.environment != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.environment;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在构造函数中已经赋值，此时拿出webapplication的类型</span></span><br><span class="line">    <span class="type">WebApplicationType</span> <span class="variable">webApplicationType</span> <span class="operator">=</span> <span class="built_in">this</span>.properties.getWebApplicationType();</span><br><span class="line">    <span class="comment">// 根据不同的webapplication类型创建不同的ConfigurableEnvironment</span></span><br><span class="line">    <span class="comment">// DefaultApplicationContextFactory</span></span><br><span class="line">    <span class="comment">// ServletWebServerApplicationContextFactory</span></span><br><span class="line">    <span class="comment">// ReactiveWebServerApplicationContextFactory</span></span><br><span class="line">    <span class="comment">// 会从META/spring.factories中获取ApplicationContextFactory并根据webApplicationType选取对应的类</span></span><br><span class="line">    <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationContextFactory.createEnvironment(webApplicationType);</span><br><span class="line">    <span class="keyword">if</span> (environment == <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.applicationContextFactory != ApplicationContextFactory.DEFAULT) &#123;</span><br><span class="line">        environment = ApplicationContextFactory.DEFAULT.createEnvironment(webApplicationType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (environment != <span class="literal">null</span>) ? environment : <span class="keyword">new</span> <span class="title class_">ApplicationEnvironment</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="准备应用上下文-prepareContext"><a href="#准备应用上下文-prepareContext" class="headerlink" title="准备应用上下文 prepareContext()"></a>准备应用上下文 <code>prepareContext()</code></h2><p>将参数绑定到应用程序上下文（ApplicationContext），为应用程序启动运行做好准备。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">prepareContext</span><span class="params">(DefaultBootstrapContext bootstrapContext, ConfigurableApplicationContext context,</span></span><br><span class="line"><span class="params">        ConfigurableEnvironment environment, SpringApplicationRunListeners listeners,</span></span><br><span class="line"><span class="params">        ApplicationArguments applicationArguments, Banner printedBanner)</span> &#123;</span><br><span class="line">    <span class="comment">// environment赋值给context</span></span><br><span class="line">    context.setEnvironment(environment);</span><br><span class="line">    postProcessApplicationContext(context);</span><br><span class="line">    addAotGeneratedInitializerIfNecessary(<span class="built_in">this</span>.initializers);</span><br><span class="line">    applyInitializers(context);</span><br><span class="line">    <span class="comment">//触发所有SpringApplicationRunListerner监听器的contextPrepared</span></span><br><span class="line">    listeners.contextPrepared(context);</span><br><span class="line">    <span class="comment">// 发送事件 当 bootstrapContext关闭且ApplicationContext准备好后发送该事件</span></span><br><span class="line">    bootstrapContext.close(context);</span><br><span class="line">    <span class="comment">//日志处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isLogStartupInfo()) &#123;</span><br><span class="line">        logStartupInfo(context.getParent() == <span class="literal">null</span>);</span><br><span class="line">        logStartupInfo(context);</span><br><span class="line">        logStartupProfileInfo(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Add boot specific singleton beans</span></span><br><span class="line">    <span class="comment">// 通过 应用上下文 获取BeanFactory</span></span><br><span class="line">    <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> context.getBeanFactory();</span><br><span class="line">    <span class="comment">// 通过 BeanFactory 注册单例对象 springApplicationArguments</span></span><br><span class="line">    beanFactory.registerSingleton(<span class="string">&quot;springApplicationArguments&quot;</span>, applicationArguments);</span><br><span class="line">    <span class="keyword">if</span> (printedBanner != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 通过 BeanFactory 注册单例对象 springBootBanner</span></span><br><span class="line">        beanFactory.registerSingleton(<span class="string">&quot;springBootBanner&quot;</span>, printedBanner);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> AbstractAutowireCapableBeanFactory autowireCapableBeanFactory) &#123;</span><br><span class="line">        autowireCapableBeanFactory.setAllowCircularReferences(<span class="built_in">this</span>.properties.isAllowCircularReferences());</span><br><span class="line">        <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> DefaultListableBeanFactory listableBeanFactory) &#123;</span><br><span class="line">            listableBeanFactory.setAllowBeanDefinitionOverriding(<span class="built_in">this</span>.properties.isAllowBeanDefinitionOverriding());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 懒加载 给应用上下文添加懒加载BeanFactory处理类</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isLazyInitialization()) &#123;</span><br><span class="line">        context.addBeanFactoryPostProcessor(<span class="keyword">new</span> <span class="title class_">LazyInitializationBeanFactoryPostProcessor</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isKeepAlive()) &#123;</span><br><span class="line">        context.addApplicationListener(<span class="keyword">new</span> <span class="title class_">KeepAlive</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    context.addBeanFactoryPostProcessor(<span class="keyword">new</span> <span class="title class_">PropertySourceOrderingBeanFactoryPostProcessor</span>(context));</span><br><span class="line">    <span class="keyword">if</span> (!AotDetector.useGeneratedArtifacts()) &#123;</span><br><span class="line">        <span class="comment">// Load the sources</span></span><br><span class="line">        Set&lt;Object&gt; sources = getAllSources();</span><br><span class="line">        Assert.notEmpty(sources, <span class="string">&quot;Sources must not be empty&quot;</span>);</span><br><span class="line">        load(context, sources.toArray(<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//触发所有SpringApplicationRunListerner监听器的contextLoaded</span></span><br><span class="line">    listeners.contextLoaded(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="启动应用上下文refreshContext"><a href="#启动应用上下文refreshContext" class="headerlink" title="启动应用上下文refreshContext()"></a>启动应用上下文<code>refreshContext()</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshContext</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isRegisterShutdownHook()) &#123;</span><br><span class="line">        shutdownHook.registerApplicationContext(context);</span><br><span class="line">    &#125;</span><br><span class="line">    refresh(context);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">(ConfigurableApplicationContext applicationContext)</span> &#123;</span><br><span class="line">    applicationContext.refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>applicationContext</code>有两种类：</p>
<ul>
<li><p><code>ReactiveWebServerApplicationContext</code></p>
</li>
<li><p><code>ServletWebServerApplicationContext</code></p>
</li>
</ul>
<p>他们的共同抽象父类<code>AbstractApplicationContext</code>，主要的refresh()方法也是在这个抽象父类中定义的。</p>
<p><code>refresh()</code> 是 Spring 容器启动的核心方法，负责加载 Bean、初始化 BeanFactory、注册监听器、完成 Bean 初始化，并最终发布 <code>ContextRefreshedEvent</code> 事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">    <span class="built_in">this</span>.startupShutdownLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.startupShutdownThread = Thread.currentThread();</span><br><span class="line"></span><br><span class="line">        <span class="type">StartupStep</span> <span class="variable">contextRefresh</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.refresh&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">        <span class="comment">// 检查SpringBoot中的环境变量</span></span><br><span class="line">        prepareRefresh();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line">        <span class="comment">// 从子类中获取beanfactory，默认是ConfigurableListableBeanFactory</span></span><br><span class="line">        <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">        <span class="comment">//为 ConfigurableListableBeanFactory配置一些基础设置和功能，以确保它能够正确地创建和管理 Bean</span></span><br><span class="line">        prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">            <span class="comment">// 允许子类对beanFactory中的bean在初始化之前修改bean</span></span><br><span class="line">            postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="type">StartupStep</span> <span class="variable">beanPostProcess</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.beans.post-process&quot;</span>);</span><br><span class="line">            <span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">            <span class="comment">// 处理注解的主要方法</span></span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line">            <span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">            <span class="comment">// 注册BeanPostProcessors的bean类</span></span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line">            beanPostProcess.end();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize message source for this context.</span></span><br><span class="line">            <span class="comment">// 添加消息bean</span></span><br><span class="line">            initMessageSource();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">            <span class="comment">// 添加事件传播bean</span></span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">            <span class="comment">// 处理子类的刷新，如Servlet的启动Tomcat</span></span><br><span class="line">            onRefresh();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">            <span class="comment">// 注册监听bean</span></span><br><span class="line">            registerListeners();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">            <span class="comment">// 初始化所有的 单例bean</span></span><br><span class="line">            <span class="comment">// 并将bean锁住</span></span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">            finishRefresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">catch</span> (RuntimeException | Error ex ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">            destroyBeans();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">            cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Propagate exception to caller.</span></span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            contextRefresh.end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.startupShutdownThread = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.startupShutdownLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">    <span class="comment">// Tell the internal bean factory to use the context&#x27;s class loader etc.</span></span><br><span class="line">    <span class="comment">// 为 BeanFactory 设置当前的类加载器,以便在加载 Bean 定义时使用</span></span><br><span class="line">    beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line">    <span class="comment">// 用于支持 Spring 表达式语言（SpEL），例如在 @Value 注解中解析表达式。</span></span><br><span class="line">    beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> <span class="title class_">StandardBeanExpressionResolver</span>(beanFactory.getBeanClassLoader()));</span><br><span class="line">    <span class="comment">// 用于处理资源（如 Resource 类型）的注入和解析</span></span><br><span class="line">    beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> <span class="title class_">ResourceEditorRegistrar</span>(<span class="built_in">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Configure the bean factory with context callbacks.</span></span><br><span class="line">    <span class="comment">// 实现了 ApplicationContextAware 接口的 Bean 能够感知到当前的 ApplicationContext</span></span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationContextAwareProcessor</span>(<span class="built_in">this</span>));</span><br><span class="line">    <span class="comment">// 配置 BeanFactory 忽略一些特定的 Aware 接口的依赖自动注入,因为这些接口的实现通常由 Spring 框架自动处理。</span></span><br><span class="line">    beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationStartupAware.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// BeanFactory interface not registered as resolvable type in a plain factory.</span></span><br><span class="line">    <span class="comment">// MessageSource registered (and found for autowiring) as a bean.</span></span><br><span class="line">    <span class="comment">// 为一些常见的类型注册默认的单例 Bean, 可以通过依赖注入直接获取对应的实例</span></span><br><span class="line">    beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">    beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="built_in">this</span>);</span><br><span class="line">    beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="built_in">this</span>);</span><br><span class="line">    beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register early post-processor for detecting inner beans as ApplicationListeners.</span></span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationListenerDetector</span>(<span class="built_in">this</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Detect a LoadTimeWeaver and prepare for weaving, if found.</span></span><br><span class="line">    <span class="keyword">if</span> (!NativeDetector.inNativeImage() &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">LoadTimeWeaverAwareProcessor</span>(beanFactory));</span><br><span class="line">        <span class="comment">// Set a temporary ClassLoader for type matching.</span></span><br><span class="line">        beanFactory.setTempClassLoader(<span class="keyword">new</span> <span class="title class_">ContextTypeMatchClassLoader</span>(beanFactory.getBeanClassLoader()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register default environment beans.</span></span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(APPLICATION_STARTUP_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(APPLICATION_STARTUP_BEAN_NAME, getApplicationStartup());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Bean扫描注册invokeBeanFactoryPostProcessors"><a href="#Bean扫描注册invokeBeanFactoryPostProcessors" class="headerlink" title="Bean扫描注册invokeBeanFactoryPostProcessors()"></a>Bean扫描注册<code>invokeBeanFactoryPostProcessors()</code></h2><p>通过<code>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</code>按优先级调用所有注册的 <code>BeanFactoryPostProcessor</code> 和 <code>BeanDefinitionRegistryPostProcessor</code>，完成对 Bean 定义的修改。</p>
<p>该方法主要完成BeanDefinition的扫描、解析、注册：</p>
<p>1.实例化实现了BeanDefinitionRegistryPostProcessor接口的Bean</p>
<p>2.调用实现了BeanDefinitionRegistryPostProcessor的postProcessBeanDefinitionRegistry()方法</p>
<p>3.实例化实现了BeanFactoryPostProcessor接口的Bean</p>
<p>4.调用实现了BeanFactoryPostProcessor的postProcessBeanFactory()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeBeanFactoryPostProcessors</span><span class="params">(</span></span><br><span class="line"><span class="params">        ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// WARNING: Although it may appear that the body of this method can be easily</span></span><br><span class="line">    <span class="comment">// refactored to avoid the use of multiple loops and multiple lists, the use</span></span><br><span class="line">    <span class="comment">// of multiple lists and multiple passes over the names of processors is</span></span><br><span class="line">    <span class="comment">// intentional. We must ensure that we honor the contracts for PriorityOrdered</span></span><br><span class="line">    <span class="comment">// and Ordered processors. Specifically, we must NOT cause processors to be</span></span><br><span class="line">    <span class="comment">// instantiated (via getBean() invocations) or registered in the ApplicationContext</span></span><br><span class="line">    <span class="comment">// in the wrong order.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Before submitting a pull request (PR) to change this method, please review the</span></span><br><span class="line">    <span class="comment">// list of all declined PRs involving changes to PostProcessorRegistrationDelegate</span></span><br><span class="line">    <span class="comment">// to ensure that your proposal does not result in a breaking change:</span></span><br><span class="line">    <span class="comment">// https://github.com/spring-projects/spring-framework/issues?q=PostProcessorRegistrationDelegate+is%3Aclosed+label%3A%22status%3A+declined%22</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span></span><br><span class="line">    Set&lt;String&gt; processedBeans = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> BeanDefinitionRegistry registry) &#123;</span><br><span class="line">        List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;</span><br><span class="line">            <span class="keyword">if</span> (postProcessor <span class="keyword">instanceof</span> BeanDefinitionRegistryPostProcessor registryProcessor) &#123;</span><br><span class="line">                registryProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">                registryProcessors.add(registryProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                regularPostProcessors.add(postProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">        <span class="comment">// uninitialized to let the bean factory post-processors apply to them!</span></span><br><span class="line">        <span class="comment">// Separate between BeanDefinitionRegistryPostProcessors that implement</span></span><br><span class="line">        <span class="comment">// PriorityOrdered, Ordered, and the rest.</span></span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">        String[] postProcessorNames =</span><br><span class="line">                beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">        registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">        currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span></span><br><span class="line">        postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">        registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">        currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">reiterate</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (reiterate) &#123;</span><br><span class="line">            reiterate = <span class="literal">false</span>;</span><br><span class="line">            postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!processedBeans.contains(ppName)) &#123;</span><br><span class="line">                    currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                    processedBeans.add(ppName);</span><br><span class="line">                    reiterate = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">            registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">            invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">            currentRegistryProcessors.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</span><br><span class="line">        invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Invoke factory processors registered with the context instance.</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">    <span class="comment">// uninitialized to let the bean factory post-processors apply to them!</span></span><br><span class="line">    String[] postProcessorNames =</span><br><span class="line">            beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span></span><br><span class="line">    <span class="comment">// Ordered, and the rest.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">        <span class="keyword">if</span> (processedBeans.contains(ppName)) &#123;</span><br><span class="line">            <span class="comment">// skip - already processed in first phase above</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">            priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            orderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">    sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;</span><br><span class="line">        orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Finally, invoke all other BeanFactoryPostProcessors.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">        nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clear cached merged bean definitions since the post-processors might have</span></span><br><span class="line">    <span class="comment">// modified the original metadata, for example, replacing placeholders in values...</span></span><br><span class="line">    beanFactory.clearMetadataCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="注解处理"><a href="#注解处理" class="headerlink" title="注解处理"></a>注解处理</h1><p> <code>prepareBeanFactory</code> 阶段，Spring 会为 BeanFactory 添加一些默认的处理器，这些处理器会影响后续注解的处理。例如：</p>
<ul>
<li><p>添加 <code>ApplicationContextAwareProcessor</code>，用于处理 Aware 接口（如 ApplicationContextAware）。</p>
</li>
<li><p>添加 <code>BeanNameAware</code> 和 <code>BeanFactoryAware</code> 的支持。</p>
</li>
</ul>
<p><code>invokeBeanFactoryPostProcessors</code> 阶段的核心处理器是 <code>ConfigurationClassPostProcessor</code>，它实现了 <code>BeanFactoryPostProcessor</code> 接口，负责解析配置类及其相关注解。它的执行逻辑包括：</p>
<ul>
<li>解析主配置类（例如带有 <code>@SpringBootApplication</code> 的类）。</li>
<li>处理 <code>@ComponentScan</code>，扫描并注册组件。</li>
<li>处理 <code>@Import</code>，加载导入的配置类或执行 ImportSelector&#x2F;ImportBeanDefinitionRegistrar。</li>
<li>处理 <code>@Bean</code>，将配置类中的 @Bean 方法注册为 Bean 定义。</li>
</ul>
<p><code>registerBeanPostProcessors</code> 阶段，Spring 会注册所有 <code>BeanPostProcessor</code>，这些处理器负责处理与 Bean 初始化和生命周期相关的注解。典型注解包括：</p>
<ul>
<li><strong><code>@Autowired</code></strong> 和 <strong>@Inject</strong>：由 <code>AutowiredAnnotationBeanPostProcessor</code> 处理，用于依赖注入。</li>
<li><code>@Value</code>：由 <code>AutowiredAnnotationBeanPostProcessor</code> 处理，用于属性值注入。</li>
<li><strong><code>@PostConstruct</code></strong> 和 <strong>@PreDestroy</strong>：由 <code>CommonAnnotationBeanPostProcessor</code> 处理，用于生命周期回调。</li>
<li>**<code>@Resource</code>**：由 <code>CommonAnnotationBeanPostProcessor</code> 处理，用于 JSR-250 注解的依赖注入。</li>
</ul>
<p><code>finishBeanFactoryInitialization</code> 阶段，Spring 会实例化所有单例 Bean，并触发 BeanPostProcessor 的处理逻辑。这一阶段会实际执行依赖注入、初始化回调等操作。典型注解包括：</p>
<ul>
<li>**<code>@Autowired</code>**：注入依赖。</li>
<li>**<code>@PostConstruct</code>**：执行初始化方法。</li>
<li>**<code>@EventListener</code>**：由 EventListenerMethodProcessor 处理，注册事件监听器。</li>
</ul>
<p>Spring Boot 还扩展了许多自定义注解，这些注解的处理逻辑分布在不同的阶段。例如：</p>
<ul>
<li><strong><code>@ConditionalOnClass</code>,<code>@ConditionalOnMissingBean</code> 等条件注解</strong>：由 ConditionEvaluator 在 <code>invokeBeanFactoryPostProcessors</code> 阶段处理，用于决定是否加载某些配置类或 Bean。</li>
<li>**<code>@SpringBootApplication</code>**：由 <code>ConfigurationClassPostProcessor</code> 在 <code>invokeBeanFactoryPostProcessors</code> 阶段处理，分解为 <code>@Configuration</code> <code>@ComponentScan</code> 和 <code>@EnableAutoConfiguration</code>。</li>
<li><strong><code>@RestController</code></strong> 和 **<code>@RequestMapping</code>**：由 Spring MVC 相关的 BeanPostProcessor（如 RequestMappingHandlerMapping）在 <code>finishBeanFactoryInitialization</code> 阶段处理，用于注册控制器和映射请求路径。</li>
</ul>
<table>
<thead>
<tr>
<th>注解类型</th>
<th>处理阶段</th>
<th>核心处理器</th>
</tr>
</thead>
<tbody><tr>
<td>@Configuration</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>ConfigurationClassPostProcessor</td>
</tr>
<tr>
<td>@ComponentScan</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>ConfigurationClassPostProcessor</td>
</tr>
<tr>
<td>@Import</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>ConfigurationClassPostProcessor</td>
</tr>
<tr>
<td>@EnableAutoConfiguration</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>AutoConfigurationImportSelector</td>
</tr>
<tr>
<td>@ConditionalOnClass 等</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>ConditionEvaluator</td>
</tr>
<tr>
<td>@Bean</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>ConfigurationClassPostProcessor</td>
</tr>
<tr>
<td>@Autowired</td>
<td>registerBeanPostProcessors &#x2F; finishBeanFactoryInitialization</td>
<td>AutowiredAnnotationBeanPostProcessor</td>
</tr>
<tr>
<td>@Value</td>
<td>registerBeanPostProcessors &#x2F; finishBeanFactoryInitialization</td>
<td>AutowiredAnnotationBeanPostProcessor</td>
</tr>
<tr>
<td>@PostConstruct</td>
<td>registerBeanPostProcessors &#x2F; finishBeanFactoryInitialization</td>
<td>CommonAnnotationBeanPostProcessor</td>
</tr>
<tr>
<td>@EventListener</td>
<td>finishBeanFactoryInitialization</td>
<td>EventListenerMethodProcessor</td>
</tr>
<tr>
<td>@RestController</td>
<td>finishBeanFactoryInitialization</td>
<td>RequestMappingHandlerMapping</td>
</tr>
<tr>
<td>@RequestMapping</td>
<td>finishBeanFactoryInitialization</td>
<td>RequestMappingHandlerMapping</td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/03/03/cf/%E5%8F%8C%E6%8C%87%E9%92%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/03/cf/%E5%8F%8C%E6%8C%87%E9%92%88/" class="post-title-link" itemprop="url">双指针</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-03-03 19:51:00 / Modified: 22:30:00" itemprop="dateCreated datePublished" datetime="2025-03-03T19:51:00+08:00">2025-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/leetcode/" itemprop="url" rel="index"><span itemprop="name">leetcode</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>双指针主要用于遍历数组，两个指针指向不同的元素，从而协同完成任务。也可以延伸到多个数组的多个指针。 </p>
<p>若两个指针指向同一数组，遍历方向相同且不会相交，则也称为滑动窗口（两个指针包围的区域即为当前的窗口），经常用于区间搜索。 </p>
<p>若两个指针指向同一数组，但是遍历方向相反，则可以用来进行搜索，待搜索的数组往往是排好序的。</p>
</blockquote>
<p>注： C和CPP是支持指针的，直接操作内存内容，但Java中是不支持指针的。</p>
<h2 id="两数值和"><a href="#两数值和" class="headerlink" title="两数值和"></a>两数值和</h2><p>双指针实现：$O(n)$</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span>[] twoSum(<span class="type">int</span>[] numbers, <span class="type">int</span> target) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span>, right = numbers.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (left &lt; right &amp;&amp; numbers[left] + numbers[right] != target) &#123;</span><br><span class="line">        <span class="keyword">if</span>(numbers[left] + numbers[right] &lt; target)&#123;</span><br><span class="line">            left++;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            right--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;left + <span class="number">1</span>, right + <span class="number">1</span>&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>二分搜索实现：$O(nlog(n))$</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span>[] twoSum(<span class="type">int</span>[] numbers, <span class="type">int</span> target) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numbers.length; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> target - numbers[i];</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> binarySearch(numbers, i + <span class="number">1</span>, numbers.length - <span class="number">1</span>, val);</span><br><span class="line">        <span class="keyword">if</span> (index != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">int</span>[] &#123; i + <span class="number">1</span>, index + <span class="number">1</span> &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">binarySearch</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> start, <span class="type">int</span> end, <span class="type">int</span> val)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (start &lt;= end) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> start + (end - start) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (arr[mid] == val) &#123;</span><br><span class="line">            <span class="keyword">return</span> mid;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (arr[mid] &gt; val) &#123;</span><br><span class="line">            end = mid - <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            start = mid + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/03/02/cf/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/02/cf/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">常用工具类</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-02 17:05:44" itemprop="dateCreated datePublished" datetime="2025-03-02T17:05:44+08:00">2025-03-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-03-03 17:13:06" itemprop="dateModified" datetime="2025-03-03T17:13:06+08:00">2025-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/leetcode/" itemprop="url" rel="index"><span itemprop="name">leetcode</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="复杂度"><a href="#复杂度" class="headerlink" title="复杂度"></a>复杂度</h2><p>基本题目要求都是1s内完成。根据不同复杂度对应的n值</p>
<table>
<thead>
<tr>
<th>复杂度</th>
<th>N值</th>
</tr>
</thead>
<tbody><tr>
<td>$O(log(N))$</td>
<td>$10^{20}$</td>
</tr>
<tr>
<td>$O(N^{\frac{1}{2}})$</td>
<td>$10^{12}$</td>
</tr>
<tr>
<td>$O(N)$</td>
<td>$10^6$</td>
</tr>
<tr>
<td>$O(N^2)$</td>
<td>$10^3$</td>
</tr>
<tr>
<td>$O(N^3)$</td>
<td>$100$</td>
</tr>
<tr>
<td>$O(N^4)$</td>
<td>50</td>
</tr>
<tr>
<td>$O(2^N)$</td>
<td>20</td>
</tr>
<tr>
<td>$O(N!)$</td>
<td>10</td>
</tr>
</tbody></table>
<h2 id="数组复制"><a href="#数组复制" class="headerlink" title="数组复制"></a>数组复制</h2><p><strong>Arrays.copyOf</strong>：由Arrays类提供</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T[] copyOf(T[] original, <span class="type">int</span> newLength)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T,U&gt; T[] copyOf(U[] original, <span class="type">int</span> newLength, Class&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>[]&gt; newType)</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] original = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"><span class="type">int</span>[] copied = Arrays.copyOf(original, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>其中<code>original</code>可以是泛型类数组：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">method</span><span class="params">(T[] arr)</span>&#123;</span><br><span class="line">    T[] newArr = Arrays.copyOf(arr, arr.length)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>System.arraycopy</strong>： 是本地方法，更底层效率更高。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">arraycopy</span><span class="params">(Object src, <span class="type">int</span> srcPos, Object dest, <span class="type">int</span> destPos, <span class="type">int</span> length)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] original = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"><span class="type">int</span>[] copied = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">3</span>];</span><br><span class="line">System.arraycopy(original, <span class="number">2</span>, copied, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line"><span class="comment">// copied = &#123;3, 4, 5&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="数组排序"><a href="#数组排序" class="headerlink" title="数组排序"></a>数组排序</h2><p>对象数组：让对象实现<code>Comparable</code>接口，并重写<code>compareTo()</code>方法。</p>
<p>基本类型数组：向Arrays.sort传入<code>Comparator</code>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[][] points;</span><br><span class="line">Arrays.sort(points, (o1, o2) -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (o1[<span class="number">1</span>] != o2[<span class="number">1</span>]) &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.compare(o1[<span class="number">1</span>], o2[<span class="number">1</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.compare(o1[<span class="number">0</span>], o2[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/03/01/cf/%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/01/cf/%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" class="post-title-link" itemprop="url">基本数据结构</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-01 22:10:06" itemprop="dateCreated datePublished" datetime="2025-03-01T22:10:06+08:00">2025-03-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-03-03 11:33:52" itemprop="dateModified" datetime="2025-03-03T11:33:52+08:00">2025-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/leetcode/" itemprop="url" rel="index"><span itemprop="name">leetcode</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="最小（大）堆"><a href="#最小（大）堆" class="headerlink" title="最小（大）堆"></a>最小（大）堆</h1><p>最小堆的主要操作：</p>
<ul>
<li>将已有数组进行堆化</li>
<li>向最小堆中的添加，删除操作</li>
<li>将最小堆的数组排序化</li>
</ul>
<h2 id="堆化已有数组"><a href="#堆化已有数组" class="headerlink" title="堆化已有数组"></a>堆化已有数组</h2><blockquote>
<p>从最后一个非叶子节点开始向下调整。</p>
</blockquote>
<p>向下调整：</p>
<ul>
<li>选择左右儿子中值更大且大于本节点值的节点，与本节点交换位置（本节点值大于左右儿子时不需要操作）</li>
<li>交换后，将交换后的儿子节点继续执行向下调整</li>
</ul>
<p>向上调整：</p>
<ul>
<li>将儿子元素与父亲比较，如果儿子元素大于父亲元素，则与父亲元素交换</li>
<li>交换后，堆交换后的父亲节点继续执行向上调整</li>
</ul>
<p>在一个完全二叉树中，最后一个非叶子节点是 $n&#x2F;2-1$，对所有的非叶子节点执行向下调整。完成后数组elements即成为最小（大）堆。</p>
<p>添加元素：将元素添加到数组最后（完全二叉树最后一个叶子节点）然后对该元素执行向上调整</p>
<p>删除元素：删除根节点元素（数组第一个元素），将最后一个元素赋值给根节点并对根节点执行向下调整</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">minHeap</span>&lt;T <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;T&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> T[] elements;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">minHeap</span><span class="params">(T[] arr)</span> &#123;</span><br><span class="line">        elements = Arrays.copyOf(arr, arr.length);        </span><br><span class="line">        <span class="comment">// 对所有非叶子节点执行向下调整</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> arr.length / <span class="number">2</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            downMove(elements, i, elements.length - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//向下调整</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">downMove</span><span class="params">(T[] elements, <span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">parent</span> <span class="operator">=</span> start;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start * <span class="number">2</span> + <span class="number">1</span>; i &lt;= end; i = i * <span class="number">2</span> + <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//选择左右儿子中较大的</span></span><br><span class="line">            <span class="keyword">if</span> (i &lt; end &amp;&amp; elements[i].compareTo(elements[i + <span class="number">1</span>]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//如果较大的儿子比父亲值还大，需要交换位置，并对儿子节点继续向下调整，否则退出循环</span></span><br><span class="line">            <span class="keyword">if</span> (elements[i].compareTo(elements[parent]) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">T</span> <span class="variable">tmp</span> <span class="operator">=</span> elements[parent];</span><br><span class="line">                elements[parent] = elements[i];</span><br><span class="line">                elements[i] = tmp;</span><br><span class="line">                parent = i;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ds;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">minHeap</span>&lt;T <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;T&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> T[] elements;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">minHeap</span><span class="params">(T[] arr, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        size = arr.length;</span><br><span class="line">        elements = Arrays.copyOf(arr, Math.max(arr.length, size));</span><br><span class="line">        <span class="comment">// 对所有非叶子节点执行向下调整</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> arr.length / <span class="number">2</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            downMove(elements, i, elements.length - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向下调整</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">downMove</span><span class="params">(T[] elements, <span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">parent</span> <span class="operator">=</span> start;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start * <span class="number">2</span> + <span class="number">1</span>; i &lt;= end; i = i * <span class="number">2</span> + <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 选择左右儿子中较大的</span></span><br><span class="line">            <span class="keyword">if</span> (i &lt; end &amp;&amp; elements[i].compareTo(elements[i + <span class="number">1</span>]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果较大的儿子比父亲值还大，需要交换位置，并对儿子节点继续向下调整，否则退出循环</span></span><br><span class="line">            <span class="keyword">if</span> (elements[i].compareTo(elements[parent]) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">T</span> <span class="variable">tmp</span> <span class="operator">=</span> elements[parent];</span><br><span class="line">                elements[parent] = elements[i];</span><br><span class="line">                elements[i] = tmp;</span><br><span class="line">                parent = i;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">upMove</span><span class="params">(T[] elements, <span class="type">int</span> start)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">child</span> <span class="operator">=</span> start;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (start - <span class="number">1</span>) / <span class="number">2</span>; i &gt; <span class="number">0</span>; i = (i - <span class="number">1</span>) / <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (elements[child].compareTo(elements[i]) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">T</span> <span class="variable">tmp</span> <span class="operator">=</span> elements[child];</span><br><span class="line">                elements[child] = elements[i];</span><br><span class="line">                elements[i] = tmp;</span><br><span class="line">                child = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加元素至最后一个位置并向上调整</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(T element)</span> &#123;</span><br><span class="line">        elements[size] = element;</span><br><span class="line">        upMove(elements, size);</span><br><span class="line">        size++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后一个元素覆盖第一个元素并向下调整</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">        elements[<span class="number">0</span>] = elements[size - <span class="number">1</span>];</span><br><span class="line">        size--;</span><br><span class="line">        downMove(elements, <span class="number">0</span>, size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T[] heapSort() &#123;</span><br><span class="line">        sortArrayFromHeap(elements);</span><br><span class="line">        <span class="keyword">return</span> elements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sortArrayFromHeap</span><span class="params">(T[] elements)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> elements.length - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="type">T</span> <span class="variable">tmp</span> <span class="operator">=</span> elements[<span class="number">0</span>];</span><br><span class="line">            elements[<span class="number">0</span>] = elements[i];</span><br><span class="line">            elements[i] = tmp;</span><br><span class="line">            downMove(elements, <span class="number">0</span>, i - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] arr = &#123; -<span class="number">4</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">9</span>, -<span class="number">5</span>, -<span class="number">1</span>, <span class="number">0</span>, -<span class="number">7</span>, -<span class="number">1</span> &#125;;</span><br><span class="line">        Integer[] arrInteger = Arrays.stream(arr).boxed().toArray(Integer[]::<span class="keyword">new</span>);</span><br><span class="line">        minHeap&lt;Integer&gt; m = <span class="keyword">new</span> <span class="title class_">minHeap</span>&lt;&gt;(arrInteger, arrInteger.length + <span class="number">10</span>);</span><br><span class="line">        m.add(<span class="number">10</span>);</span><br><span class="line">        <span class="type">int</span>[] res = Arrays.stream(m.elements).mapToInt(Integer::intValue).toArray();</span><br><span class="line">        System.out.println(Arrays.toString(res));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/02/23/react/vscode%E5%89%8D%E7%AB%AF%E6%8F%92%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/23/react/vscode%E5%89%8D%E7%AB%AF%E6%8F%92%E4%BB%B6/" class="post-title-link" itemprop="url">vscode前端插件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-02-23 18:34:44" itemprop="dateCreated datePublished" datetime="2025-02-23T18:34:44+08:00">2025-02-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-05-11 23:57:03" itemprop="dateModified" datetime="2025-05-11T23:57:03+08:00">2025-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><p>Quokka.js</p>
</li>
<li><p>Import Cost </p>
</li>
<li><p>Color Highlight</p>
</li>
<li><p>CSS Peek</p>
</li>
<li><p>REST Client</p>
</li>
<li><p>Live Server</p>
</li>
<li><p>JSON</p>
</li>
<li><p>json2ts</p>
</li>
<li><p>Path Intellisense</p>
</li>
<li><p>Path Autocomplete</p>
</li>
<li><p>Npm Intellisense</p>
</li>
<li><p>NPM</p>
</li>
<li><p>NPM-Scripts</p>
</li>
<li><p>JavaScript (ES6) code snippets</p>
</li>
<li><p>Tailwind CSS IntelliSense</p>
</li>
<li><p>ESLint</p>
</li>
<li><p>Prettier - Code formatter</p>
</li>
<li><p>Nextjs snippets</p>
</li>
<li><p>Simple React Snippets</p>
</li>
<li><p>Git Graph</p>
</li>
<li><p>Hex Editor</p>
</li>
<li><p>Code Runner</p>
</li>
<li><p>IntelliJ IDEA Keybindings</p>
</li>
<li><p>Material Icon Theme</p>
</li>
<li><p>Atom One Dark Theme</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/02/19/springboot/SpringBoot%20Swagger/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/19/springboot/SpringBoot%20Swagger/" class="post-title-link" itemprop="url">SpringBoot Swagger</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-02-19 10:48:34 / Modified: 12:34:58" itemprop="dateCreated datePublished" datetime="2025-02-19T10:48:34+08:00">2025-02-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/springboot/" itemprop="url" rel="index"><span itemprop="name">springboot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h1><p>SpringBoot依赖<a target="_blank" rel="noopener" href="https://springdoc.org/">springdoc-openapi</a>对接口API进行注解</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springdoc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springdoc-openapi-starter-webmvc-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置信息<code>application.yml</code>中添加swagger-ui</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">springdoc:</span></span><br><span class="line">    <span class="attr">swagger-ui:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">swagger-ui.html</span></span><br></pre></td></tr></table></figure>

<p>启动项目后就可以通过 <code>https://localhost:8443/swagger-ui.html</code> 或者<code>https://localhost:8443/swagger-ui/index.html#/</code>访问后端接口信息。</p>
<h1 id="Swagger-注解"><a href="#Swagger-注解" class="headerlink" title="Swagger 注解"></a>Swagger 注解</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_52774158/article/details/131081371">Swagger Annotation Tutorial</a></p>
<h2 id="Tag"><a href="#Tag" class="headerlink" title="@Tag"></a>@Tag</h2><p>API分组</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Tag(name = &quot;OAuth2 Authorization&quot;, description = &quot;OAuth2 登陆接口&quot;)</span></span><br></pre></td></tr></table></figure>

<h2 id="Operation"><a href="#Operation" class="headerlink" title="@Operation"></a>@Operation</h2><p>用于描述API操作</p>
<ul>
<li>summary：操作的摘要信息。</li>
<li>description：操作的详细描述。</li>
<li>tags：指定 @Tag 注解的对象数组，用于将操作归类到特定的分组。</li>
<li>parameters：指定 @Parameter 注解的对象数组，用于描述操作的输入参数</li>
<li>responses：指定 @ApiResponse 注解的对象数组，用于描述操作的响应结果。</li>
<li>requestBody：指定 @RequestBody 注解的对象，用于描述操作的请求体。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = &quot;跳转到 OAuth2 授权页面&quot;, description = &quot;两次重定向，跳转到Github登陆页面，登陆后与后端交换Token，最后跳转到origin_url&quot;)</span></span><br></pre></td></tr></table></figure>

<h2 id="Parameter"><a href="#Parameter" class="headerlink" title="@Parameter"></a>@Parameter</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Parameter(name = &quot;origin_url&quot;, required = true, description = &quot;OAuth2流程结束后会跳转到该URL&quot;)</span></span><br></pre></td></tr></table></figure>

<h2 id="ApiResponse"><a href="#ApiResponse" class="headerlink" title="@ApiResponse"></a>@ApiResponse</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiResponse(responseCode = &quot;301&quot;, description = &quot;两次跳转到Github登陆窗口&quot;)</span></span><br></pre></td></tr></table></figure>

<h2 id="OpenAPIDefinition"><a href="#OpenAPIDefinition" class="headerlink" title="@OpenAPIDefinition"></a>@OpenAPIDefinition</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OpenAPIDefinition(</span></span><br><span class="line"><span class="meta">        info = @Info(</span></span><br><span class="line"><span class="meta">                title = &quot;User Manager API&quot;,</span></span><br><span class="line"><span class="meta">                version = &quot;1.0.0&quot;,</span></span><br><span class="line"><span class="meta">                description = &quot;用户信息管理API&quot;,</span></span><br><span class="line"><span class="meta">                contact = @Contact(</span></span><br><span class="line"><span class="meta">                        name = &quot;yingzheng&quot;,</span></span><br><span class="line"><span class="meta">                        email = &quot;yingzhengttt@gmail.com&quot;</span></span><br><span class="line"><span class="meta">                )</span></span><br><span class="line"><span class="meta">        )</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/02/17/react/electron_nextjs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/17/react/electron_nextjs/" class="post-title-link" itemprop="url">NextJs集成Electron</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-02-17 10:30:47" itemprop="dateCreated datePublished" datetime="2025-02-17T10:30:47+08:00">2025-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-02-18 15:23:29" itemprop="dateModified" datetime="2025-02-18T15:23:29+08:00">2025-02-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>Electron 简单来说就是一个浏览器套壳打包方案，相当于你开发了一个网页后，通过浏览器能访问这个网页；然后如果你想把网页打包成一个单独的应用的话，可以使用Electron，它内置了 chromium 和 node.js 运行环境，使用 Electron 相当于构建了一个只显示你的网页的浏览器程序。而且Electron可以通过node.js提供一些浏览器不能提供的功能。</p>
<p>Electron 支持 <strong>URL 加载</strong>和<strong>文件加载</strong>两种方式。</p>
<ul>
<li>URL加载是传入一个URL，显示URL内容。</li>
<li>文件加载是传入HTML文件，Electron通过文件渲染内容。</li>
</ul>
<p>理论上来说，只要能进行静态导出，就能兼容各种前端框架。同时也提供了 Next.js 动态路由的加载的方式。</p>
</blockquote>
<h2 id="创建Nextjs工程文件"><a href="#创建Nextjs工程文件" class="headerlink" title="创建Nextjs工程文件"></a>创建Nextjs工程文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx create-next-app@latest electron_nextjs</span><br></pre></td></tr></table></figure>

<p>创建参数全部使用默认即可（使用Typescript，使用Tailwind CSS，使用App Router）</p>
<h2 id="打包Nextjs工程"><a href="#打包Nextjs工程" class="headerlink" title="打包Nextjs工程"></a>打包Nextjs工程</h2><p>在<code>package.json</code>的scripts中已经有了build。</p>
<p>Nextjs打包有两种方式（需要配置<code>next.config.js</code>）：</p>
<ul>
<li><p>静态模式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//next.config.js</span></span><br><span class="line"><span class="keyword">import</span> type &#123;<span class="title class_">NextConfig</span>&#125; <span class="keyword">from</span> <span class="string">&quot;next&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="attr">nextConfig</span>: <span class="title class_">NextConfig</span> = &#123;</span><br><span class="line">    <span class="attr">output</span>: <span class="string">&#x27;export&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> nextConfig;</span><br></pre></td></tr></table></figure>
</li>
<li><p>动态模式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//next.config.js</span></span><br><span class="line"><span class="keyword">import</span> type &#123;<span class="title class_">NextConfig</span>&#125; <span class="keyword">from</span> <span class="string">&quot;next&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="attr">nextConfig</span>: <span class="title class_">NextConfig</span> = &#123;</span><br><span class="line">    <span class="attr">output</span>: <span class="string">&#x27;standalone&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> nextConfig;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>静态模式</strong>是将工程压缩到一个HTML中，Electron只需要使用文件加载加载该HTML即可。但静态模式无法进行网络请求所以只用在一些仅展示的页面中，比如博客，公司简介等。</p>
<p>静态导出会将内容导出到<code>out/</code>目录下的<code>index.html</code>中，后续Electron只需要加载该文件即可（本文不讨论）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line">mainWindow.<span class="title function_">loadFile</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../out/index.html&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>本文采用<strong>动态模式</strong>，即Nextjs将以standalone模式进行打包，文件被导出到<code>.next/standalone</code>文件夹下，其中有<code>server.js</code>用于启动该项目。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node ./server.js</span><br></pre></td></tr></table></figure>

<p>为了将公共资源包也整合进<code>.next/standalone</code>，需要重定义package.json中的<code>next build</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//package.json</span></span><br><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build:next&quot;</span><span class="punctuation">:</span> <span class="string">&quot;next build &amp;&amp; cp -r public .next/standalone/ &amp;&amp; cp -r .next/static .next/standalone/.next/&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>定义<code>build:next</code>脚本，执行<code>next build</code>后将<code>public</code>和<code>.next/static</code>导入到 <code>.next/standalone</code>中。</p>
<p>执行<code>npm run build:next</code> 即可打包Nextjs项目，然后进入<code>.next/standalone</code>使用<code>node ./server.js</code>启动Nextjs项目。</p>
<p>至此，Nextjs的打包过程就完成了。</p>
<h2 id="配置Electron"><a href="#配置Electron" class="headerlink" title="配置Electron"></a>配置Electron</h2><p>根据<a target="_blank" rel="noopener" href="https://www.electronjs.org/docs/latest/tutorial/tutorial-first-app#initializing-your-npm-project">Electron官网</a>，将Electron依赖加入到项目中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install electron --save-dev</span><br></pre></td></tr></table></figure>

<p>为了能同时启动Nextjs和Electron，安装<code>concurrently</code>依赖包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install concurrently --save-dev</span><br></pre></td></tr></table></figure>

<p>创建<code>main/main.js</code>文件作为Electron的启动入口，以及<code>main/preload.js</code>作为主进程与渲染进程的桥梁。</p>
<p>添加包依赖，需要在<code>main/main.js</code>中使用，<code>electron-is-dev</code>用于判断是否处于dev开发过程，<code>get-port-please</code>是用于获取一个未被使用的端口，用于启动nextjs的standalone。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install electron-is-dev get-port-please</span><br></pre></td></tr></table></figure>

<p><code>main/main.js</code></p>
<p>主要功能实现（第一个功能在后续Nextjs中会用到，目前没用）：</p>
<ul>
<li>关闭系统自带状态栏，启用自定义按钮。（需要在前端css设置 <code>app-region: drag</code>，提供可拖拽区域）。</li>
<li>loadURL前进行轮训，直至nextjs服务启动，保证Electron加载URL时，Nextjs已经启动。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main/main.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;app, <span class="title class_">BrowserWindow</span>&#125; <span class="keyword">from</span> <span class="string">&quot;electron&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> isDev <span class="keyword">from</span> <span class="string">&quot;electron-is-dev&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">&quot;http&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;fileURLToPath&#125; <span class="keyword">from</span> <span class="string">&#x27;url&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;dirname&#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&quot;node:path&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;getPort&#125; <span class="keyword">from</span> <span class="string">&quot;get-port-please&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;startServer&#125; <span class="keyword">from</span> <span class="string">&quot;next/dist/server/lib/start-server.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> __filename = <span class="title function_">fileURLToPath</span>(<span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>);</span><br><span class="line"><span class="keyword">const</span> __dirname = <span class="title function_">dirname</span>(__filename);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> win = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断Nextjs是否启动成功，每一秒检查一次</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">waitForNextJs</span> = (<span class="params">bg_url</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> interval = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            http.<span class="title function_">get</span>(bg_url, <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (res.<span class="property">statusCode</span> === <span class="number">200</span>) &#123;</span><br><span class="line">                    <span class="built_in">clearInterval</span>(interval);</span><br><span class="line">                    <span class="title function_">resolve</span>(); <span class="comment">// Next.js 启动完成</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Next.js not yet started, retrying...&#x27;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动Nextjs standalone包</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">startNextJSServer</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> nextJSPort = <span class="keyword">await</span> <span class="title function_">getPort</span>(&#123;<span class="attr">portRange</span>: [<span class="number">3000</span>, <span class="number">8000</span>]&#125;);</span><br><span class="line">        <span class="keyword">const</span> webDir = path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;../.next/standalone/&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;path: &quot;</span> + webDir);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">startServer</span>(&#123;</span><br><span class="line">            <span class="attr">dir</span>: webDir,</span><br><span class="line">            <span class="attr">isDev</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">hostname</span>: <span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">            <span class="attr">port</span>: nextJSPort,</span><br><span class="line">            <span class="attr">customServer</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">allowRetry</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">keepAliveTimeout</span>: <span class="number">5000</span>,</span><br><span class="line">            <span class="attr">minimalMode</span>: <span class="literal">false</span>,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> nextJSPort;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Error starting Next.js server:&quot;</span>, error);</span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BrowserWindow使用自定义状态栏</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">createWindow</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    win = <span class="keyword">new</span> <span class="title class_">BrowserWindow</span>(&#123;</span><br><span class="line">        <span class="attr">width</span>: <span class="number">1000</span>,</span><br><span class="line">        <span class="attr">height</span>: <span class="number">800</span>,</span><br><span class="line">        <span class="attr">minWidth</span>: <span class="number">600</span>,</span><br><span class="line">        <span class="attr">minHeight</span>: <span class="number">400</span>,</span><br><span class="line">        <span class="attr">titleBarStyle</span>: <span class="string">&#x27;hidden&#x27;</span>,   <span class="comment">//关闭系统自带状态栏</span></span><br><span class="line">        <span class="attr">titleBarOverlay</span>: &#123;</span><br><span class="line">            <span class="attr">color</span>: <span class="string">&quot;rgba(255, 255, 255, 0)&quot;</span>,</span><br><span class="line">            <span class="attr">symbolColor</span>: <span class="string">&#x27;rgba(255, 255, 255, 0)&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="attr">webPreferences</span>: &#123;</span><br><span class="line">            <span class="attr">preload</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;preload.js&#x27;</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 首先加载Loading页面，等待Nextjs的启动</span></span><br><span class="line">    win.<span class="title function_">loadFile</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../public/loading.html&#x27;</span>));</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">loadURL</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (isDev) &#123;</span><br><span class="line">            <span class="keyword">const</span> bg_url = <span class="string">&quot;http://localhost:3000&quot;</span>;</span><br><span class="line">            <span class="title function_">waitForNextJs</span>(bg_url).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                win.<span class="title function_">setTitleBarOverlay</span>(&#123;</span><br><span class="line">                    <span class="attr">color</span>: <span class="string">&quot;rgba(255, 255, 255, 0)&quot;</span>,</span><br><span class="line">                    <span class="attr">symbolColor</span>: <span class="string">&#x27;#74b1be&#x27;</span>,</span><br><span class="line">                    <span class="attr">height</span>: <span class="number">40</span></span><br><span class="line">                &#125;)</span><br><span class="line">                win.<span class="title function_">loadURL</span>(bg_url);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 启动 nextjs 打包后的 standalone 并获取启动 端口</span></span><br><span class="line">                <span class="keyword">const</span> port = <span class="keyword">await</span> <span class="title function_">startNextJSServer</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Next.js server started on port:&quot;</span>, port);</span><br><span class="line">                win.<span class="title function_">setTitleBarOverlay</span>(&#123;</span><br><span class="line">                    <span class="attr">color</span>: <span class="string">&quot;rgba(255, 255, 255, 0)&quot;</span>,</span><br><span class="line">                    <span class="attr">symbolColor</span>: <span class="string">&#x27;#74b1be&#x27;</span>,</span><br><span class="line">                    <span class="attr">height</span>: <span class="number">40</span></span><br><span class="line">                &#125;)</span><br><span class="line">                win.<span class="title function_">loadURL</span>(<span class="string">`http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Error starting Next.js server:&quot;</span>, error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title function_">loadURL</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// win.webContents.openDevTools();</span></span><br><span class="line">    <span class="comment">// win.webContents.on(&quot;did-fail-load&quot;, (e, code, desc) =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//     win.webContents.reloadIgnoringCache();</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">disableHardwareAcceleration</span>();</span><br><span class="line">app.<span class="title function_">whenReady</span>().<span class="title function_">then</span>(createWindow)</span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&quot;window-all-closed&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">platform</span> !== <span class="string">&quot;darwin&quot;</span>) &#123;</span><br><span class="line">        app.<span class="title function_">quit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><code>main/preload.js</code></p>
<p>目前没有使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main/preload.js</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>public/</code>目录下创建<code>loading.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--public/loading.html--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">100vh</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">100vw</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(to right, red, blue);</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>设置<code>package.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nextjs_electron&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;private&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;main/main.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;module&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;dev:next&quot;</span><span class="punctuation">:</span> <span class="string">&quot;next dev&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dev:electron&quot;</span><span class="punctuation">:</span> <span class="string">&quot;electron ./main/main.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;concurrently --kill-others  \&quot;npm run dev:next\&quot; \&quot;npm run dev:electron\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build:next&quot;</span><span class="punctuation">:</span> <span class="string">&quot;next build &amp;&amp; cp -r public .next/standalone/ &amp;&amp; cp -r .next/static .next/standalone/.next/&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    ...</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>执行 <code>npm run dev</code> 同时启动Nextjs和Electron。（目前窗口时不能拖动的，后续会在Nextjs中添加）</p>
<h2 id="Electron-Forge打包Electron"><a href="#Electron-Forge打包Electron" class="headerlink" title="Electron Forge打包Electron"></a>Electron Forge打包Electron</h2><p>根据<a target="_blank" rel="noopener" href="https://www.electronforge.io/import-existing-project#using-the-import-script">Electron Forge</a>官网教程安装打包工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev @electron-forge/cli</span><br><span class="line">npm <span class="built_in">exec</span> --package=@electron-forge/cli -c <span class="string">&quot;electron-forge import&quot;</span></span><br></pre></td></tr></table></figure>

<p>然后在<code>package.json</code>中配置需要打包的类型和平台并更新scripts</p>
<p><code>package.json</code></p>
<p><em>其中Scripts中<code>&quot;dev:nextweb&quot;: &quot;NEXT_PUBLIC_WEB=true next dev&quot;</code>是为了能让Nextjs能够以WEB的形式启动而不依赖于Electron。因为Nextjs某些特性只能在Electron中才能启动，使用该变量将这些特性只有在启用Electron才加载。</em></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nextjs_electron&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;private&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;main/main.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;module&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;dev:next&quot;</span><span class="punctuation">:</span> <span class="string">&quot;next dev&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dev:nextweb&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NEXT_PUBLIC_WEB=true next dev&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dev:electron&quot;</span><span class="punctuation">:</span> <span class="string">&quot;electron ./main/main.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;concurrently --kill-others  \&quot;npm run dev:next\&quot; \&quot;npm run dev:electron\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build:next&quot;</span><span class="punctuation">:</span> <span class="string">&quot;next build &amp;&amp; cp -r public .next/standalone/ &amp;&amp; cp -r .next/static .next/standalone/.next/&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build:electron&quot;</span><span class="punctuation">:</span> <span class="string">&quot;electron-forge package&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm run build:next &amp;&amp; npm run build:electron&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;make&quot;</span><span class="punctuation">:</span> <span class="string">&quot;electron-forge make&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dist&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm run build &amp;&amp; npm run make&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;electron-forge start&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;next lint&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;forge&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;packagerConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;makers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;@electron-forge/maker-deb&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;platforms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;linux&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="string">&quot;public/chat.png&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ichat for deb&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;productDescription&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ichat for deb&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  ... ...</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>注：打包过程中，本文设置了<code>makers.config.icon</code>，所以需要添加图片<code>public/chat.png</code>，不想设置icon可以直接在<code>package.json</code>中删除<code>makers.config.icon</code>。</p>
<p>执行<code>npm run dist</code>命令，即执行了<em>Nextjs的build</em>，<em>election-forge的package</em> 和 <em>election-forge的make</em>。最终的生成文件在<code>/out/make/</code>内。</p>
<p>注：本文生成的时Linux的deb文件，执行命令<code>sudo apt install ./nextjs_electron_0.1.0_amd64.deb</code>安装。</p>
<h2 id="Nextjs可拖拽状态栏-和-更改主题颜色（可选）"><a href="#Nextjs可拖拽状态栏-和-更改主题颜色（可选）" class="headerlink" title="Nextjs可拖拽状态栏 和 更改主题颜色（可选）"></a>Nextjs可拖拽状态栏 和 更改主题颜色（可选）</h2><blockquote>
<p>本Nextjs项目整合</p>
<ul>
<li><strong>HeroUI</strong>前端UI框架，具体方法参照<a target="_blank" rel="noopener" href="https://www.heroui.com/docs/frameworks/nextjs#manual-installation">HeroUI官方文档</a>的手动导入</li>
<li>**<a target="_blank" rel="noopener" href="https://www.heroui.com/docs/customization/dark-mode#using-next-themes">Next Theme</a>**主题切换，但要记得<a target="_blank" rel="noopener" href="https://github.com/pacocoursey/next-themes?tab=readme-ov-file#with-app">在html标签中添加</a><code>suppressHydrationWarning</code></li>
</ul>
</blockquote>
<p>添加上述两个依赖后，需要在<code>layout.tsx</code>中自定义状态栏，将状态栏所在的<code>div</code>的CSS添加<code>style=&#123;&#123;"app-region": 'drag'&#125;&#125;</code>。该CSS特性是Electron专属，可以让模块进行拖拽。</p>
<p><code>src/app/layout.tsx</code></p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;./globals.css&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">Providers</span>&#125; <span class="keyword">from</span> <span class="string">&quot;./providers&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">CustomBar</span> <span class="keyword">from</span> <span class="string">&quot;@/app/component/bar/CustomBar&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">RootLayout</span>(<span class="params">&#123;children,&#125;: <span class="title class_">Readonly</span>&lt;&#123; children: React.ReactNode; &#125;&gt;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">suppressHydrationWarning</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Providers</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;h-screen w-screen flex flex-col&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;bar_height w-full bg-bar_bg&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">CustomBar</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;flex-1&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    &#123;children&#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Providers</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>src/app/globals.css</code></p>
<p>其中定义一些TailwindCSS自定义的字段，可以在TailwindCSS中直接使用。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@tailwind</span> base;</span><br><span class="line"><span class="meta">@tailwind</span> components;</span><br><span class="line"><span class="meta">@tailwind</span> utilities;</span><br><span class="line"></span><br><span class="line">body &#123;</span><br><span class="line">    font-<span class="attr">family</span>: <span class="title class_">Arial</span>, <span class="title class_">Helvetica</span>, sans-serif;</span><br><span class="line">    <span class="attr">margin</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@layer</span> components &#123;</span><br><span class="line">    --header-<span class="attr">height</span>: 40px;</span><br><span class="line"></span><br><span class="line">    .<span class="property">bar_height</span> &#123;</span><br><span class="line">        <span class="attr">height</span>: <span class="title function_">var</span>(--header-height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .<span class="property">bar_icon</span> &#123;</span><br><span class="line">        <span class="attr">height</span>: <span class="title function_">var</span>(--header-height);</span><br><span class="line">        <span class="attr">width</span>: 40px;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>tailwind.config.ts</code></p>
<p>设置不同主题下的颜色，并设置自定义的颜色变量。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123;<span class="title class_">Config</span>&#125; <span class="keyword">from</span> <span class="string">&quot;tailwindcss&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;heroui&#125; <span class="keyword">from</span> <span class="string">&quot;@heroui/react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">content</span>: [</span><br><span class="line">        <span class="string">&quot;./src/pages/**/*.&#123;js,ts,jsx,tsx,mdx&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;./src/components/**/*.&#123;js,ts,jsx,tsx,mdx&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;./src/app/**/*.&#123;js,ts,jsx,tsx,mdx&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;./node_modules/@heroui/theme/dist/**/*.&#123;js,ts,jsx,tsx&#125;&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">darkMode</span>: <span class="string">&quot;class&quot;</span>,</span><br><span class="line">    <span class="attr">plugins</span>: [<span class="title function_">heroui</span>(&#123;</span><br><span class="line">        <span class="attr">themes</span>: &#123;</span><br><span class="line">            <span class="attr">light</span>: &#123;</span><br><span class="line">                <span class="attr">colors</span>: &#123;</span><br><span class="line">                    <span class="attr">background</span>: <span class="string">&quot;#FFFFFF&quot;</span>,</span><br><span class="line">                    <span class="attr">foreground</span>: <span class="string">&quot;#11181C&quot;</span>,</span><br><span class="line">                    <span class="attr">bar_bg</span>: <span class="string">&quot;#d4d4d8&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">dark</span>: &#123;</span><br><span class="line">                <span class="attr">colors</span>: &#123;</span><br><span class="line">                    <span class="attr">background</span>: <span class="string">&quot;#000000&quot;</span>,</span><br><span class="line">                    <span class="attr">foreground</span>: <span class="string">&quot;#ECEDEE&quot;</span>,</span><br><span class="line">                    <span class="attr">bar_bg</span>: <span class="string">&quot;#3f3f46&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)],</span><br><span class="line">&#125; <span class="keyword">satisfies</span> <span class="title class_">Config</span>;</span><br></pre></td></tr></table></figure>

<p><code>src/app/provider.tsx</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;use client&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">HeroUIProvider</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;@heroui/react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">ThemeProvider</span> <span class="keyword">as</span> <span class="title class_">NextThemesProvider</span>&#125; <span class="keyword">from</span> <span class="string">&quot;next-themes&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">Providers</span>(<span class="params">&#123;children&#125;: &#123; children: React.ReactNode &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">HeroUIProvider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">NextThemesProvider</span> <span class="attr">attribute</span>=<span class="string">&quot;class&quot;</span> <span class="attr">defaultTheme</span>=<span class="string">&quot;system&quot;</span> <span class="attr">enableSystem</span>=<span class="string">&#123;true&#125;</span> <span class="attr">themes</span>=<span class="string">&#123;[</span>&quot;<span class="attr">dark</span>&quot;, &quot;<span class="attr">light</span>&quot;]&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;children&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">NextThemesProvider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">HeroUIProvider</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>src/app/component/bar/CustomBar.tsx</code></p>
<p>Nextjs自定状态栏，为了满足能够同时支持WEB和ELECTRON两种启动方式，定义<code>NEXT_PUBLIC_WEB</code>全局变量，用来动态设置是否支持某些ELECTRON特性。后面会在<code>next.config.ts</code>中设置该变量。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use client&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ThemeSwitcher</span> <span class="keyword">from</span> <span class="string">&quot;@/app/component/bar/ThemeSwitcher&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Settings</span> <span class="keyword">from</span> <span class="string">&quot;@/app/component/bar/Settings&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">UserInfo</span> <span class="keyword">from</span> <span class="string">&quot;@/app/component/bar/UserInfo&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;useEffect, useState&#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">CustomBar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> [web, setWeb] = <span class="title function_">useState</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NEXT_PUBLIC_WEB</span> === <span class="string">&#x27;true&#x27;</span>) &#123;</span><br><span class="line">            <span class="title function_">setWeb</span>(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, [])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;h-full w-full flex flex-end gap-2 electron_pr&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">             <span class="attr">style</span>=<span class="string">&#123;web</span> ? &#123;&quot;<span class="attr">padding-right</span>&quot;<span class="attr">:</span> &quot;<span class="attr">0px</span>&quot;&#125; <span class="attr">:</span> &#123;&quot;<span class="attr">app-region</span>&quot;<span class="attr">:</span> &#x27;<span class="attr">drag</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;mr-auto&quot;</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;bar_icon&quot;</span> <span class="attr">style</span>=<span class="string">&#123;web</span> ? &#123;&#125; <span class="attr">:</span> &#123;&quot;<span class="attr">app-region</span>&quot;<span class="attr">:</span> &#x27;<span class="attr">no-drag</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ThemeSwitcher</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123;/*<span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;bar_icon&quot;</span> <span class="attr">style</span>=<span class="string">&#123;web</span> ? &#123;&#125; <span class="attr">:</span> &#123;&quot;<span class="attr">app-region</span>&quot;<span class="attr">:</span> &#x27;<span class="attr">no-drag</span>&#x27;&#125;&#125;&gt;</span>*/&#125;</span></span><br><span class="line"><span class="language-xml">            &#123;/*    <span class="tag">&lt;<span class="name">Settings</span>/&gt;</span>*/&#125;</span></span><br><span class="line"><span class="language-xml">            &#123;/*<span class="tag">&lt;/<span class="name">div</span>&gt;</span>*/&#125;</span></span><br><span class="line"><span class="language-xml">            &#123;/*<span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;bar_icon flex items-center justify-center&quot;</span> <span class="attr">style</span>=<span class="string">&#123;web</span> ? &#123;&#125; <span class="attr">:</span> &#123;&quot;<span class="attr">app-region</span>&quot;<span class="attr">:</span> &#x27;<span class="attr">no-drag</span>&#x27;&#125;&#125;&gt;</span>*/&#125;</span></span><br><span class="line"><span class="language-xml">            &#123;/*    <span class="tag">&lt;<span class="name">UserInfo</span>/&gt;</span>*/&#125;</span></span><br><span class="line"><span class="language-xml">            &#123;/*<span class="tag">&lt;/<span class="name">div</span>&gt;</span>*/&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ThemeSwitcher.tsx</code></p>
<p>使用<code>useTheme</code>来更改Nextjs的主题，使用HeroUI的<code>Dropdown</code>来提供更改按钮</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use client&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">Button</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@heroui/react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;useTheme&#125; <span class="keyword">from</span> <span class="string">&quot;next-themes&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123;useEffect, useState&#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">Dropdown</span>, <span class="title class_">DropdownItem</span>, <span class="title class_">DropdownMenu</span>, <span class="title class_">DropdownTrigger</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@heroui/dropdown&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">DarkIcon</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="attr">viewBox</span>=<span class="string">&quot;0 0 24 24&quot;</span> <span class="attr">width</span>=<span class="string">&quot;18&quot;</span> <span class="attr">height</span>=<span class="string">&quot;18&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;currentColor&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">path</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">d</span>=<span class="string">&quot;M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">path</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">LightIcon</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="attr">viewBox</span>=<span class="string">&quot;0 0 24 24&quot;</span> <span class="attr">width</span>=<span class="string">&quot;18&quot;</span> <span class="attr">height</span>=<span class="string">&quot;18&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;currentColor&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">path</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">d</span>=<span class="string">&quot;M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">path</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">SystemIcon</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="attr">viewBox</span>=<span class="string">&quot;0 0 24 24&quot;</span> <span class="attr">width</span>=<span class="string">&quot;18&quot;</span> <span class="attr">height</span>=<span class="string">&quot;18&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;currentColor&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">path</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">d</span>=<span class="string">&quot;M4 16H20V5H4V16ZM13 18V20H17V22H7V20H11V18H2.9918C2.44405 18 2 17.5511 2 16.9925V4.00748C2 3.45107 2.45531 3 2.9918 3H21.0082C21.556 3 22 3.44892 22 4.00748V16.9925C22 17.5489 21.5447 18 21.0082 18H13Z&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">path</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">ThemeSwitcher</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> [mounted, setMounted] = <span class="title function_">useState</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">const</span> &#123;theme, setTheme&#125; = <span class="title function_">useTheme</span>()</span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">setMounted</span>(<span class="literal">true</span>)</span><br><span class="line">    &#125;, [])</span><br><span class="line">    <span class="keyword">if</span> (!mounted) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">toggleTheme</span> = (<span class="params"><span class="attr">key</span>: <span class="title class_">React</span>.<span class="title class_">Key</span></span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (key === <span class="string">&quot;system&quot;</span>) &#123;</span><br><span class="line">            <span class="title function_">setTheme</span>(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key === <span class="string">&quot;dark&quot;</span>) &#123;</span><br><span class="line">            <span class="title function_">setTheme</span>(<span class="string">&quot;dark&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key === <span class="string">&quot;light&quot;</span>) &#123;</span><br><span class="line">            <span class="title function_">setTheme</span>(<span class="string">&quot;light&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;theme error&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">Dropdown</span> <span class="attr">classNames</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">content:</span> &quot;<span class="attr">min-w-32</span> <span class="attr">w-32</span>&quot;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">DropdownTrigger</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Button</span> <span class="attr">className</span>=<span class="string">&quot;h-10 w-10 min-w-10 p-0&quot;</span> <span class="attr">variant</span>=<span class="string">&quot;light&quot;</span> <span class="attr">isIconOnly</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    &#123;theme === &quot;system&quot; &amp;&amp; <span class="tag">&lt;<span class="name">SystemIcon</span>/&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">                    &#123;theme === &quot;light&quot; &amp;&amp; <span class="tag">&lt;<span class="name">LightIcon</span>/&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">                    &#123;theme === &quot;dark&quot; &amp;&amp; <span class="tag">&lt;<span class="name">DarkIcon</span>/&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">DropdownTrigger</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">DropdownMenu</span> <span class="attr">onAction</span>=<span class="string">&#123;toggleTheme&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                          <span class="attr">disallowEmptySelection</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">DropdownItem</span> <span class="attr">key</span>=<span class="string">&quot;light&quot;</span> <span class="attr">startContent</span>=<span class="string">&#123;</span>&lt;<span class="attr">LightIcon</span>/&gt;</span>&#125;&gt;Light<span class="tag">&lt;/<span class="name">DropdownItem</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">DropdownItem</span> <span class="attr">key</span>=<span class="string">&quot;dark&quot;</span> <span class="attr">startContent</span>=<span class="string">&#123;</span>&lt;<span class="attr">DarkIcon</span>/&gt;</span>&#125;&gt;Dark<span class="tag">&lt;/<span class="name">DropdownItem</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">DropdownItem</span> <span class="attr">key</span>=<span class="string">&quot;system&quot;</span> <span class="attr">startContent</span>=<span class="string">&#123;</span>&lt;<span class="attr">SystemIcon</span>/&gt;</span>&#125;&gt;System<span class="tag">&lt;/<span class="name">DropdownItem</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">DropdownMenu</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Dropdown</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>为了布局美观，将原来的<code>src/app/page.tsx</code>内容删除，改为</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span> main <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时执行<code>npm run dev</code>就可以启动程序了，并且可以切换主题。</p>
<p>但执行<code>npm run dist</code>打包的时候会报错，CSS中没有属性<code>app-region</code>，因为该特性是Electron特有的，在Nextjs打包时候会报错，为了不让Nextjs进行类型认证，在<code>next.config.ts</code>中设置跳过类型认证：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123;<span class="title class_">NextConfig</span>&#125; <span class="keyword">from</span> <span class="string">&quot;next&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">nextConfig</span>: <span class="title class_">NextConfig</span> = &#123;</span><br><span class="line">    <span class="attr">output</span>: <span class="string">&#x27;standalone&#x27;</span>,</span><br><span class="line">    <span class="attr">eslint</span>: &#123;</span><br><span class="line">        <span class="attr">ignoreDuringBuilds</span>: <span class="literal">true</span>, <span class="comment">// 忽略 eslint 检查</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">typescript</span>: &#123;</span><br><span class="line">        <span class="attr">ignoreBuildErrors</span>: <span class="literal">true</span>, <span class="comment">// 忽略 TypeScript 检查</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">env</span>: &#123;</span><br><span class="line">      <span class="attr">NEXT_PUBLIC_WEB</span>: process.<span class="property">env</span>.<span class="property">NEXT_PUBLIC_WEB</span> || <span class="string">&#x27;false&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> nextConfig;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/02/16/interview/Java%E9%9D%A2%E8%AF%95%E5%90%88%E9%9B%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/16/interview/Java%E9%9D%A2%E8%AF%95%E5%90%88%E9%9B%86/" class="post-title-link" itemprop="url">Java面试合集</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-02-16 17:45:24" itemprop="dateCreated datePublished" datetime="2025-02-16T17:45:24+08:00">2025-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-04-25 20:44:46" itemprop="dateModified" datetime="2025-04-25T20:44:46+08:00">2025-04-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/interview/" itemprop="url" rel="index"><span itemprop="name">interview</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="String"><a href="#String" class="headerlink" title="String"></a>String</h1><h3 id="String底层为和将char-改成了byte"><a href="#String底层为和将char-改成了byte" class="headerlink" title="String底层为和将char[]改成了byte[]"></a>String底层为和将char[]改成了byte[]</h3><p>在 Java 9 之前，String 的底层实现使用的是 char[]数组来存储字符数据。然而，随着 Unicode 编码的普及和多语言环境的需求增加，char 类型无法满足所有情况下的字符表示要求。因此，在 Java 9 中，String 的底层实现被修改为使用 byte[]数组来存储字符数据。</p>
<h3 id="解释-Java-在处理字符串拼接时如何优化性能-尤其是在-Java-9-以后的版本"><a href="#解释-Java-在处理字符串拼接时如何优化性能-尤其是在-Java-9-以后的版本" class="headerlink" title="解释 Java 在处理字符串拼接时如何优化性能,尤其是在 Java 9 以后的版本"></a>解释 Java 在处理字符串拼接时如何优化性能,尤其是在 Java 9 以后的版本</h3><p><strong>Java 9 之前的优化:</strong><br>编译期优化：在 Java 9 之前，编译器对字符串拼接做了优化。对于简单的字符串常量拼接，编译器会在编译期进行优化，将其直接替换为一个单独的字符串常量。例如：</p>
<p><code>String str = &quot;Hello, &quot; + &quot;world!&quot;;</code></p>
<p>这行代码在编译期会被优化成：</p>
<p><code>String str = &quot;Hello, world!&quot;;</code></p>
<p>使用 StringBuilder 进行拼接：对于包含变量的字符串拼接，Java 编译器会自动将拼接操作转换为使用 StringBuilder 进行的拼接操作。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str1</span> <span class="operator">=</span> <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> <span class="string">&quot;world&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> str1 + <span class="string">&quot;, &quot;</span> + str2 + <span class="string">&quot;!&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>在编译后的字节码中，上述代码会被转换为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">sb.append(str1);</span><br><span class="line">sb.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">sb.append(str2);</span><br><span class="line">sb.append(<span class="string">&quot;!&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> sb.toString();</span><br></pre></td></tr></table></figure>

<p><strong>Java 9 及以后的优化:</strong></p>
<p>在 Java 9 以后，JVM 引入了基于 <code>invokedynamic</code>指令的字符串拼接优化，进一步提升了性能。</p>
<p><code>invokedynamic</code> 指令：Java 9 引入了<code>invokedynamic</code> 指令来优化字符串拼接。编译器在处理字符串拼接时，会生成一个调用 <code>invokedynamic</code> 指令的字节码，而不是直接使用 <code>StringBuilder</code>。 <code>invokedynamic</code> 指令在运行时决定最佳的拼接策略。</p>
<ul>
<li><p>减少中间对象：通过动态拼接策略，减少了中间对象的创建，降低了内存使用和 GC 压力。</p>
</li>
<li><p>运行时优化：invokedynamic 指令允许 JVM 在运行时根据实际使用情况选择最佳策略，提高了代码的执行效率。</p>
</li>
<li><p>更高的灵活性：使用 invokedynamic 提供了更高的灵活性，允许未来的 JVM 优化进一步提升性能，而不需要改变应用代码。</p>
</li>
</ul>
<h3 id="描述一下字符串常量池（String-Pool）的工作原理"><a href="#描述一下字符串常量池（String-Pool）的工作原理" class="headerlink" title="描述一下字符串常量池（String Pool）的工作原理"></a>描述一下字符串常量池（String Pool）的工作原理</h3><p>字符串常量池（String Pool）是 Java 中用于存储字符串字面值的一种特殊内存区域。它的主要目的是为了节省内存和提高性能。以下是字符串常量池的工作原理和它如何影响字符串实例的具体描述：</p>
<ul>
<li>字符串字面值的存储：<ul>
<li>当一个字符串字面值被创建时，如 String str &#x3D; “Hello”;，JVM 会先检查字符串常量池中是否已经存在一个值为 “Hello” 的字符串。</li>
<li>如果常量池中已经存在这个字符串，JVM 不会创建新的字符串对象，而是直接返回常量池中的引用。这意味着相同的字符串字面值在内存中只会存储一次。</li>
</ul>
</li>
<li>字符串的 intern() 方法：<ul>
<li>可以显式地将一个字符串添加到常量池中，使用 intern() 方法。例如：String str &#x3D; new String(“Hello”).intern();</li>
<li>intern() 方法会检查常量池中是否存在一个值等于该字符串对象的字符串。如果存在，则返回池中的字符串引用；如果不存在，则将该字符串添加到常量池中，并返回该字符串的引用。</li>
</ul>
</li>
</ul>
<p>编译时的优化：编译器会自动将所有字符串字面值添加到常量池中。这意味着在编译时，字符串字面值就已经在常量池中，运行时直接使用。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">YingZheng</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/caohongchuan" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"caohongchuan","repo":"caohongchuan.github.io","client_id":"967bc44f66d40841715d","client_secret":"8d7caaf8d49e847e9da60bfab064fc2acad2b66d","admin_user":"caohongchuan","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"en | zh-CN","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"c853ec00cc9d13bc22336b7d45d1416e"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
