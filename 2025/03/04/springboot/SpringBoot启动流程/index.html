<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"caohongchuan.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":"auto","version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Spring Boot 是一个开源的 Java 框架，用于简化 Spring 应用程序的开发。它是 Spring 生态系统的一部分，旨在帮助开发人员更快速和方便地创建独立、生产级的 Spring 应用。  快速入门：Spring Boot 通过约定优于配置的原则，使开发者可以快速上手，无需繁琐的 XML 配置。  自带嵌入式服务器：Spring Boot 支持嵌入式服务器（如 Tomcat Je">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringBoot启动流程">
<meta property="og:url" content="http://caohongchuan.github.io/2025/03/04/springboot/SpringBoot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="yingzheng">
<meta property="og:description" content="Spring Boot 是一个开源的 Java 框架，用于简化 Spring 应用程序的开发。它是 Spring 生态系统的一部分，旨在帮助开发人员更快速和方便地创建独立、生产级的 Spring 应用。  快速入门：Spring Boot 通过约定优于配置的原则，使开发者可以快速上手，无需繁琐的 XML 配置。  自带嵌入式服务器：Spring Boot 支持嵌入式服务器（如 Tomcat Je">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-03-03T16:00:38.579Z">
<meta property="article:modified_time" content="2025-03-17T12:06:36.537Z">
<meta property="article:author" content="YingZheng">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://caohongchuan.github.io/2025/03/04/springboot/SpringBoot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://caohongchuan.github.io/2025/03/04/springboot/SpringBoot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/","path":"2025/03/04/springboot/SpringBoot启动流程/","title":"SpringBoot启动流程"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>SpringBoot启动流程 | yingzheng</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">yingzheng</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-SpringBootApplication%E6%B3%A8%E8%A7%A3"><span class="nav-number">1.</span> <span class="nav-text">1.@SpringBootApplication注解</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-SpringApplication-run-LearnApplication-class-args"><span class="nav-number">2.</span> <span class="nav-text">2.SpringApplication.run(LearnApplication.class, args);</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringAplplication%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="nav-number">2.1.</span> <span class="nav-text">SpringAplplication构造函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#getSpringFactoriesInstances"><span class="nav-number">2.1.1.</span> <span class="nav-text">getSpringFactoriesInstances()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E6%89%A7%E8%A1%8CSpringApplication%E7%9A%84run%E6%96%B9%E6%B3%95"><span class="nav-number">3.</span> <span class="nav-text">2. 执行SpringApplication的run方法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%BC%95%E5%AF%BC%E7%A8%8B%E5%BA%8F%E4%B8%8A%E4%B8%8B%E6%96%87createBootstrapContext"><span class="nav-number">3.1.</span> <span class="nav-text">创建引导程序上下文createBootstrapContext()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E5%90%AC%E7%B1%BBSpringApplicationRunListeners"><span class="nav-number">3.2.</span> <span class="nav-text">监听类SpringApplicationRunListeners</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83-prepareEnvironment"><span class="nav-number">3.3.</span> <span class="nav-text">准备环境 prepareEnvironment()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87-prepareContext"><span class="nav-number">3.4.</span> <span class="nav-text">准备应用上下文 prepareContext()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87refreshContext"><span class="nav-number">3.5.</span> <span class="nav-text">启动应用上下文refreshContext()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Bean%E6%89%AB%E6%8F%8F%E6%B3%A8%E5%86%8CinvokeBeanFactoryPostProcessors"><span class="nav-number">3.6.</span> <span class="nav-text">Bean扫描注册invokeBeanFactoryPostProcessors()</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86"><span class="nav-number">4.</span> <span class="nav-text">注解处理</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="YingZheng"
      src="/images/photo.png">
  <p class="site-author-name" itemprop="name">YingZheng</p>
  <div class="site-description" itemprop="description">Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/caohongchuan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;caohongchuan" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yingzhengttt@gmail.com" title="E-Mail → mailto:yingzhengttt@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://caohongchuan.github.io/2025/03/04/springboot/SpringBoot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/photo.png">
      <meta itemprop="name" content="YingZheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yingzheng">
      <meta itemprop="description" content="Programmer of Java and JavaScript. Programming with Springboot, Electron and React-Native.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="SpringBoot启动流程 | yingzheng">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringBoot启动流程
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-04 00:00:38" itemprop="dateCreated datePublished" datetime="2025-03-04T00:00:38+08:00">2025-03-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-03-17 20:06:36" itemprop="dateModified" datetime="2025-03-17T20:06:36+08:00">2025-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/springboot/" itemprop="url" rel="index"><span itemprop="name">springboot</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><blockquote>
<p>Spring Boot 是一个开源的 Java 框架，用于简化 Spring 应用程序的开发。它是 Spring 生态系统的一部分，旨在帮助开发人员更快速和方便地创建独立、生产级的 Spring 应用。</p>
<ul>
<li><p>快速入门：Spring Boot 通过约定优于配置的原则，使开发者可以快速上手，无需繁琐的 XML 配置。</p>
</li>
<li><p>自带嵌入式服务器：Spring Boot 支持嵌入式服务器（如 Tomcat Jetty 和 Undertow），开发者无需单独部署应用服务器，可以直接运行 Java 应用。</p>
</li>
<li><p>自动配置：Spring Boot 提供了自动配置功能，根据项目的类路径和配置自动设置 Spring 应用的各种组件，减少了大量的配置工作。</p>
</li>
<li><p>生产级特性：Spring Boot 内置了许多生产环境所需的功能，如健康检查、指标监控、应用配置管理等。</p>
</li>
<li><p>开箱即用：Spring Boot 提供了一系列的 starter 依赖，简化了依赖管理。例如，spring-boot-starter-web 可以帮助快速构建基于 Spring MVC 的 web 应用。</p>
</li>
<li><p>支持微服务架构：Spring Boot 适合构建微服务应用，结合 Spring Cloud，能够实现分布式系统的开发。1.</p>
</li>
</ul>
</blockquote>
<h1 id="1-SpringBootApplication注解"><a href="#1-SpringBootApplication注解" class="headerlink" title="1.@SpringBootApplication注解"></a>1.<code>@SpringBootApplication</code>注解</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LearnApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(LearnApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpringBoot启动类中包含<code>@SpringBootApplication</code>注解和<code>SpringApplication.run(LearnApplication.class, args);</code>方法。SpringBoot的入口是main方法。本章节先讲解<code>@SpringBootApplication</code>注解。</p>
<blockquote>
<p>在 Java 中，<strong>注解（Annotation）</strong> 是一种元数据的形式，可以添加到代码中（例如类、方法、字段等），以提供额外的信息。注解本身并不直接影响代码的执行逻辑，但可以通过反射机制或编译时处理来实现特定的功能。</p>
<p>注解主要分为：</p>
<ul>
<li><p><strong>元注解</strong>：用于定义其他注解的行为  （<code>@Retention</code>,<code>@Target</code>,<code>@Documented</code>,<code>@Inherited</code>）</p>
</li>
<li><p><strong>内置注解</strong>：该类注解的执行器被内置到了Javac中，由Javac负责解析注解。（<code>@Override</code>,<code>@Deprecated</code>,<code>@SuppressWarnings</code>）</p>
</li>
<li><p><strong>自定义注解</strong>：使用元注解自定义注解，需要编写<em>注解处理器</em>来处理该类注解。自定义注解的处理取决于<code>@Retention</code>定义的阶段。</p>
<ul>
<li><p><code>RetentionPolicy.SOURCE</code>：注解仅保留在源代码中，编译后丢弃。该类注解由编译器或源码级工具在编译时处理。</p>
<p>注：内置注解也属于该类，但内置注解是嵌入到编译器中的语义分析和语法分析中，属于编译器的一部分。但该类的自定义注解的处理需要通过<strong>注解处理器（Annotation Processor）</strong>处理，在 javac 编译时，注解处理器会扫描源代码中的注解，并根据注解信息执行特定逻辑，例如生成新代码、验证规则或抛出错误，比较常用的就是Lombok的注解。</p>
</li>
<li><p><code>RetentionPolicy.CLASS</code>：注解保留在编译后的 .class 文件中，但运行时不可见。也是由<strong>注解处理器（Annotation Processor）</strong>处理。用于生成代码或验证，可用在构建工具中，一般不常用。</p>
</li>
<li><p><code>RetentionPolicy.RUNTIME</code>：注解保留到运行时，可通过反射访问。由程序在运行时通过反射动态读取和处理。比较常见的就是各种框架，如SpringBoot。</p>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>通过<code>@SpringBootApplication</code>注解的源码注释可以得出，其为一个组合注解，组合了<code>@SpringBootConfiguration</code>, <code>@EnableAutoConfiguration</code>, <code>@ComponentScan</code>。经过后面的源码分析，可以得出SpringBoot并不是直接处理<code>@SpringBootApplication</code>而是处理他的三个组合注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123; @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span></span><br><span class="line"><span class="meta">		@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@AliasFor(annotation = EnableAutoConfiguration.class)</span></span><br><span class="line">	Class&lt;?&gt;[] exclude() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@AliasFor(annotation = ComponentScan.class, attribute = &quot;basePackages&quot;)</span></span><br><span class="line">	String[] scanBasePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@AliasFor(annotation = ComponentScan.class, attribute = &quot;basePackageClasses&quot;)</span></span><br><span class="line">	Class&lt;?&gt;[] scanBasePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@AliasFor(annotation = ComponentScan.class, attribute = &quot;nameGenerator&quot;)</span></span><br><span class="line">	Class&lt;? <span class="keyword">extends</span> <span class="title class_">BeanNameGenerator</span>&gt; nameGenerator() <span class="keyword">default</span> BeanNameGenerator.class;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@AliasFor(annotation = Configuration.class)</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">proxyBeanMethods</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>@SpringBootConfiguration</code>组合了<code>@Configuration</code>，表明是一个Java配置类</li>
<li><code>@EnableAutoConfiguration</code> 组合了<code>@AutoConfigurationPackage</code>和<code>@Import(AutoConfigurationImportSelector.class)</code>用于将所有符合配置条件的 Bean 都加载到 IOC 容器中</li>
<li><code>@ComponentScan</code>指明了包搜索路径以及需要过滤的类</li>
</ul>
<h1 id="2-SpringApplication-run-LearnApplication-class-args"><a href="#2-SpringApplication-run-LearnApplication-class-args" class="headerlink" title="2.SpringApplication.run(LearnApplication.class, args);"></a>2.<code>SpringApplication.run(LearnApplication.class, args);</code></h1><p><code>SpringApplication.run(LearnApplication.class, args);</code>是整个SpringBoot的入口。查看源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(Class&lt;?&gt;[] primarySources, String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(primarySources).run(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建<code>ConfigurableApplicationContext</code>实例</li>
<li>运行该实例</li>
</ul>
<h2 id="SpringAplplication构造函数"><a href="#SpringAplplication构造函数" class="headerlink" title="SpringAplplication构造函数"></a>SpringAplplication构造函数</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">    Assert.notNull(primarySources, <span class="string">&quot;PrimarySources must not be null&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.primarySources = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(Arrays.asList(primarySources));</span><br><span class="line">    <span class="comment">//判断WEB应用的类型</span></span><br><span class="line">    <span class="built_in">this</span>.properties.setWebApplicationType(WebApplicationType.deduceFromClasspath());</span><br><span class="line">    <span class="comment">// 将类型为BootstrapRegistryInitializer的初始化类数组赋值给this.bootstrapRegistryInitializers</span></span><br><span class="line">    <span class="built_in">this</span>.bootstrapRegistryInitializers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">            getSpringFactoriesInstances(BootstrapRegistryInitializer.class));</span><br><span class="line">    <span class="comment">//将类型为ApplicationContextInitializer的初始化类数组赋值给this.initializers</span></span><br><span class="line">    setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));</span><br><span class="line">    <span class="comment">//将类型为ApplicationListener的监听类数组赋值给this.listeners</span></span><br><span class="line">    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));</span><br><span class="line">    <span class="comment">// 从调用栈中拿到main方法所在的类</span></span><br><span class="line">    <span class="built_in">this</span>.mainApplicationClass = deduceMainApplicationClass();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Class&lt;?&gt; deduceMainApplicationClass() &#123;</span><br><span class="line">    <span class="comment">//使用Java9引入的StackWalker遍历当前线程的调用栈</span></span><br><span class="line">    <span class="keyword">return</span> StackWalker.getInstance(StackWalker.Option.RETAIN_CLASS_REFERENCE)</span><br><span class="line">        <span class="comment">// 找到第一个包含main方法的类并返回它的Class&lt;?&gt;</span></span><br><span class="line">        .walk(<span class="built_in">this</span>::findMainClass)</span><br><span class="line">        <span class="comment">//找不到返回null</span></span><br><span class="line">        .orElse(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> Optional&lt;Class&lt;?&gt;&gt; findMainClass(Stream&lt;StackFrame&gt; stack) &#123;</span><br><span class="line">    <span class="keyword">return</span> stack.filter((frame) -&gt; Objects.equals(frame.getMethodName(), <span class="string">&quot;main&quot;</span>))</span><br><span class="line">        .findFirst()</span><br><span class="line">        .map(StackWalker.StackFrame::getDeclaringClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpringApplication 构造函数的参数是资源加载器和主程序源（SpringBoot启动类）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断WEB应用的类型</span></span><br><span class="line"><span class="built_in">this</span>.properties.setWebApplicationType(WebApplicationType.deduceFromClasspath());</span><br></pre></td></tr></table></figure>

<p><code>WebApplicationType</code>有三种类型：</p>
<ul>
<li><code>NONE</code>：程序不是WEB应用，不需要启动内置WEB服务器</li>
<li><code>SERVLET</code>： 程序是WEB应用，需要启动WEB服务器</li>
<li><code>REACTIVE</code>：程序是响应式WEB应用，启动REACTIVE WEB服务器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] SERVLET_INDICATOR_CLASSES = &#123; <span class="string">&quot;jakarta.servlet.Servlet&quot;</span>,</span><br><span class="line">        <span class="string">&quot;org.springframework.web.context.ConfigurableWebApplicationContext&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WEBMVC_INDICATOR_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.springframework.web.servlet.DispatcherServlet&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WEBFLUX_INDICATOR_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.springframework.web.reactive.DispatcherHandler&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JERSEY_INDICATOR_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.glassfish.jersey.servlet.ServletContainer&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> WebApplicationType <span class="title function_">deduceFromClasspath</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ClassUtils.isPresent(WEBFLUX_INDICATOR_CLASS, <span class="literal">null</span>) &amp;&amp; !ClassUtils.isPresent(WEBMVC_INDICATOR_CLASS, <span class="literal">null</span>)</span><br><span class="line">            &amp;&amp; !ClassUtils.isPresent(JERSEY_INDICATOR_CLASS, <span class="literal">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> WebApplicationType.REACTIVE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (String className : SERVLET_INDICATOR_CLASSES) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ClassUtils.isPresent(className, <span class="literal">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> WebApplicationType.NONE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> WebApplicationType.SERVLET;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>判断方法很简单，就是寻找在Classpath加载路径上有某些Class，比如有<code>DispatcherHandler</code>且没有<code>DispatcherServlet</code>和<code>ServletContainer</code>则是响应式WEB应用。如果包含<code>Servlet</code> <code>ConfigurableWebApplicationContext</code>则是Servlet WEB应用。否则就不是WEB应用。</p>
<p>下面三个赋值中都使用了<code>getSpringFactoriesInstances()</code>用于获取Spring工厂对象。即将对应的class文件加载到内存对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">getSpringFactoriesInstances</span><span class="params">(Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getSpringFactoriesInstances(type, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">getSpringFactoriesInstances</span><span class="params">(Class&lt;T&gt; type, ArgumentResolver argumentResolver)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> SpringFactoriesLoader.forDefaultResourceLocation(getClassLoader()).load(type, argumentResolver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getSpringFactoriesInstances"><a href="#getSpringFactoriesInstances" class="headerlink" title="getSpringFactoriesInstances()"></a><code>getSpringFactoriesInstances()</code></h3><blockquote>
<p>classpath 是Java的系统变量，Javac通过classpath寻找class文件或依赖包。classpath默认路径是当前目录下（<code>./</code>）以及<code>javac -cp xxx</code>指定的路径。</p>
<p>在SpringBoot中，对classpath进行了增强：</p>
<ul>
<li><p>开发模式：classpath 包含了<code>target/classes/</code>(编译前来自于<code>src/main/resources/</code>)和Maven从本地仓库中获取的依赖包（<code>~/.m2/repository/xxx.jar</code>)。此模式下Maven会解析pom.xml，并自动添加<code>~/.m2/repository/</code> 里的 JAR 到 classpath</p>
</li>
<li><p>Spring Boot Fat JAR 模式：此时SpringBoot不使用classpath，而是用 <code>LaunchedURLClassLoader</code> 来解析 <code>BOOT-INF/lib/</code> 里的 JAR。此模式下Maven会将依赖包从<code>~/.m2/repository/</code>中直接复制到<code>target/myapp-1.0.0.jar/BOOT-INF/lib/</code>中。</p>
</li>
</ul>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">target/myapp-1.0.0.jar</span><br><span class="line"> ├── BOOT-INF/classes/        <span class="comment"># 编译后的 .class 文件</span></span><br><span class="line"> ├── BOOT-INF/lib/            <span class="comment"># 所有依赖的 JAR</span></span><br><span class="line"> ├── META-INF/MANIFEST.MF     <span class="comment"># 启动信息</span></span><br><span class="line"> ├── org/springframework/...  <span class="comment"># Spring 相关类</span></span><br></pre></td></tr></table></figure>

<p>注：开发模式中，也可以不使用Maven的启动，直接使用Java命令。编译之后执行<code>java -cp target/classes:$(mvn dependency:build-classpath) com.example.MainApplication</code>，使用<code>-cp</code>参数将<code>target/classes</code>和<code>~/.m2/repository/</code>下的依赖包添加到classpath中，也可以正常启动项目。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//maven中查看依赖</span><br><span class="line">mvn dependency:tree</span><br><span class="line">//输出依赖的完整路径</span><br><span class="line">mvn dependency:build-classpath</span><br></pre></td></tr></table></figure>
</blockquote>
<p>了解了classpath工作原理，重点讲解<code>SpringFactoriesLoader.forDefaultResourceLocation(getClassLoader()).load(type, argumentResolver);</code>该类是利用<code>classloader</code>将classpath中的所有满足要求的类都加载进来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SpringFactoriesLoader <span class="title function_">forDefaultResourceLocation</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> forResourceLocation(FACTORIES_RESOURCE_LOCATION, classLoader);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SpringFactoriesLoader <span class="title function_">forResourceLocation</span><span class="params">(String resourceLocation, <span class="meta">@Nullable</span> ClassLoader classLoader)</span> &#123;</span><br><span class="line">    Assert.hasText(resourceLocation, <span class="string">&quot;&#x27;resourceLocation&#x27; must not be empty&quot;</span>);</span><br><span class="line">    <span class="comment">//获取classloader</span></span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">resourceClassLoader</span> <span class="operator">=</span> (classLoader != <span class="literal">null</span> ? classLoader :</span><br><span class="line">            SpringFactoriesLoader.class.getClassLoader());</span><br><span class="line">    <span class="comment">//从缓存中查看该classloader是否存在，如果没有创建一个cache[classloader]=hashmap&lt;string, SpringFactoriesLoader&gt; </span></span><br><span class="line">    <span class="comment">//并将该hashmap返回给loaders</span></span><br><span class="line">    Map&lt;String, SpringFactoriesLoader&gt; loaders = cache.computeIfAbsent(</span><br><span class="line">            resourceClassLoader, key -&gt; <span class="keyword">new</span> <span class="title class_">ConcurrentReferenceHashMap</span>&lt;&gt;());</span><br><span class="line">    <span class="comment">//获取loaders[&quot;META-INF/spring.factories&quot;]，如果不存在，创建一个新的SpringFactoriesLoader</span></span><br><span class="line">    <span class="comment">//参数1:classloader</span></span><br><span class="line">    <span class="comment">//参数2:factories : Map&lt;String, List&lt;String&gt;&gt;</span></span><br><span class="line">    <span class="keyword">return</span> loaders.computeIfAbsent(resourceLocation, key -&gt;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SpringFactoriesLoader</span>(classLoader, loadFactoriesResource(resourceClassLoader, resourceLocation)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>FACTORIES_RESOURCE_LOCATION = &quot;META-INF/spring.factories&quot;</code>，ClassLoader是默认的类加载器 <code>Thread.currentThread().getContextClassLoader();</code> 通过调试<code>classloader = ClassLoaders$AppClassLoader</code></p>
<p><code>loadFactoriesResource()</code>会将符合条件的类加载进来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//classloader = ClassLoaders$AppClassLoader</span></span><br><span class="line"><span class="comment">//resourceLocation = &quot;META-INF/spring.factories&quot;</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">loadFactoriesResource</span><span class="params">(ClassLoader classLoader, String resourceLocation)</span> &#123;</span><br><span class="line">    	<span class="comment">//result中包含[初始化类型，对应需要加载的所有初始化类]</span></span><br><span class="line">		Map&lt;String, List&lt;String&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//classLoader将classpath路径下的所有的resourceLocation文件都加载到urls中</span></span><br><span class="line">            <span class="comment">//urls中包含了所有META-INF/spring.factories的文件路径</span></span><br><span class="line">			Enumeration&lt;URL&gt; urls = classLoader.getResources(resourceLocation);</span><br><span class="line">			<span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">                <span class="comment">//根据urls中的文件路径加载到UrlResource中</span></span><br><span class="line">                <span class="comment">//举个例子 resource=jar:file:/home/amber/.m2/repository/org/springframework/boot/spring-boot/3.4.3/spring-boot-3.4.3.jar!/META-INF/spring.factories</span></span><br><span class="line">				<span class="type">UrlResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlResource</span>(urls.nextElement());</span><br><span class="line">                <span class="comment">//将文件中的所有属性加载到properties中</span></span><br><span class="line">                <span class="comment">//Properties 是一个 ConcurrentHashMap&lt;Object, Object&gt;</span></span><br><span class="line">				<span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">                <span class="comment">//遍历所有属性</span></span><br><span class="line">				properties.forEach((name, value) -&gt; &#123;</span><br><span class="line">                    <span class="comment">//以逗号分割，将value字符串分割为String[]数组</span></span><br><span class="line">					String[] factoryImplementationNames = StringUtils.commaDelimitedListToStringArray((String) value);</span><br><span class="line">                    <span class="comment">//将&#123;name: ArrayList&lt;String&gt;&#123;&#125;&#125;放入到result中,ArrayList的长度就是value数组的长度</span></span><br><span class="line">					List&lt;String&gt; implementations = result.computeIfAbsent(((String) name).trim(),</span><br><span class="line">							key -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(factoryImplementationNames.length));</span><br><span class="line">                    <span class="comment">//将factoryImplementationNames流化，将每一个元素都trim后再将每一个元素添加到implementations中</span></span><br><span class="line">					Arrays.stream(factoryImplementationNames).map(String::trim).forEach(implementations::add);</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">//对每一种初始化类型中的所有初始化类去重</span></span><br><span class="line">			result.replaceAll(SpringFactoriesLoader::toDistinctUnmodifiableList);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unable to load factories from location [&quot;</span> + resourceLocation + <span class="string">&quot;]&quot;</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">    	<span class="comment">//返回一个不可以修改的Map，最终赋值给了SpringFactoriesLoader.factories</span></span><br><span class="line">		<span class="keyword">return</span> Collections.unmodifiableMap(result);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file:/home/amber/.m2/repository/org/springframework/boot/spring-boot/3.4.3/spring-boot-3.4.3.jar!/META-INF/spring.factories</span></span><br><span class="line"><span class="comment"># Logging Systems</span></span><br><span class="line"><span class="attr">org.springframework.boot.logging.LoggingSystemFactory</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.boot.logging.logback.LogbackLoggingSystem.Factory,\</span></span><br><span class="line"><span class="string">org.springframework.boot.logging.log4j2.Log4J2LoggingSystem.Factory,\</span></span><br><span class="line"><span class="string">org.springframework.boot.logging.java.JavaLoggingSystem.Factory</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># PropertySource Loaders</span></span><br><span class="line"><span class="attr">org.springframework.boot.env.PropertySourceLoader</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.boot.env.PropertiesPropertySourceLoader,\</span></span><br><span class="line"><span class="string">org.springframework.boot.env.YamlPropertySourceLoader</span></span><br><span class="line"><span class="attr">.....</span></span><br></pre></td></tr></table></figure>

<p>到目前已经通过<code>SpringFactoriesLoader.forDefaultResourceLocation(getClassLoader())</code>得到了<code>SpringFactoriesLoader</code>对象，其中包含了<code>SpringFactoriesLoader.classLoader</code>,<code>SpringFactoriesLoader.factories</code>。后续调用了该对象的<code>load(type, argumentResolver)</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">load</span><span class="params">(Class&lt;T&gt; factoryType, <span class="meta">@Nullable</span> FailureHandler failureHandler)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> load(factoryType, <span class="literal">null</span>, failureHandler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">load</span><span class="params">(Class&lt;T&gt; factoryType, <span class="meta">@Nullable</span> ArgumentResolver argumentResolver,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> FailureHandler failureHandler)</span> &#123;</span><br><span class="line"></span><br><span class="line">    Assert.notNull(factoryType, <span class="string">&quot;&#x27;factoryType&#x27; must not be null&quot;</span>);</span><br><span class="line">    <span class="comment">//构造函数中已经把&#123;初始化类型：[对应类型的实现类数组]&#125;放入到factories中</span></span><br><span class="line">    <span class="comment">//取出初始化类型为factoryType的类数组</span></span><br><span class="line">    List&lt;String&gt; implementationNames = loadFactoryNames(factoryType);</span><br><span class="line">    logger.trace(LogMessage.format(<span class="string">&quot;Loaded [%s] names: %s&quot;</span>, factoryType.getName(), implementationNames));</span><br><span class="line">    <span class="comment">//结果是一个类型为T的列表</span></span><br><span class="line">    List&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(implementationNames.size());</span><br><span class="line">    <span class="type">FailureHandler</span> <span class="variable">failureHandlerToUse</span> <span class="operator">=</span> (failureHandler != <span class="literal">null</span>) ? failureHandler : THROWING_FAILURE_HANDLER;</span><br><span class="line">    <span class="comment">//遍历所有的实现类</span></span><br><span class="line">    <span class="keyword">for</span> (String implementationName : implementationNames) &#123;</span><br><span class="line">        <span class="comment">//将实现类实例化</span></span><br><span class="line">        <span class="type">T</span> <span class="variable">factory</span> <span class="operator">=</span> instantiateFactory(implementationName, factoryType, argumentResolver, failureHandlerToUse);</span><br><span class="line">        <span class="comment">//将实例化的实现类放入到result中</span></span><br><span class="line">        <span class="keyword">if</span> (factory != <span class="literal">null</span>) &#123;</span><br><span class="line">            result.add(factory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据@Order @Priority对实现类进行排序</span></span><br><span class="line">    AnnotationAwareOrderComparator.sort(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;String&gt; <span class="title function_">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryType)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.factories.getOrDefault(factoryType.getName(), Collections.emptyList());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">instantiateFactory</span><span class="params">(String implementationName, Class&lt;T&gt; type,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> ArgumentResolver argumentResolver, FailureHandler failureHandler)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//使用class.forName(xxx, false, zzz)将xxx类加载到元数据区，只类加载不执行类初始化</span></span><br><span class="line">        Class&lt;?&gt; factoryImplementationClass = ClassUtils.forName(implementationName, <span class="built_in">this</span>.classLoader);</span><br><span class="line">        Assert.isTrue(type.isAssignableFrom(factoryImplementationClass), () -&gt;</span><br><span class="line">                <span class="string">&quot;Class [%s] is not assignable to factory type [%s]&quot;</span>.formatted(implementationName, type.getName()));</span><br><span class="line">        <span class="comment">//创建一个用于初始化factoryImplementationClass类的内部创建类（该类包含了factoryImplementationClass的构造方法）</span></span><br><span class="line">        FactoryInstantiator&lt;T&gt; factoryInstantiator = FactoryInstantiator.forClass(factoryImplementationClass);</span><br><span class="line">        <span class="comment">// 处理构造函数所需的参数，使用this.constructor.newInstance(args)创建factoryImplementationClass类</span></span><br><span class="line">        <span class="keyword">return</span> factoryInstantiator.instantiate(argumentResolver);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        failureHandler.handleFailure(type, implementationName, ex);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到目前为止，得出了<code>getSpringFactoriesInstances(xxx.class)</code>方法是将初始化类型为xxx.class的类从<code>META-INF/spring.factories</code>中提取出来，并返回该类型的所有的实现类，返回的是一个xxx.class类型的数组。</p>
<p><code>ConfigurableApplicationContext</code>后续的三个赋值都是利用<code>getSpringFactoriesInstances(xxx.class)</code>将初始化类数组赋值给类成员，最后一步是从调用栈中获取main方法所在的类。</p>
<h1 id="2-执行SpringApplication的run方法"><a href="#2-执行SpringApplication的run方法" class="headerlink" title="2. 执行SpringApplication的run方法"></a>2. 执行<code>SpringApplication</code>的run方法</h1><p><code>SpringApplication</code>构造函数中都是一些赋值操作，run方法才是真正启动SpringBoot项目。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(String... args)</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化启动时钟</span></span><br><span class="line">    <span class="type">Startup</span> <span class="variable">startup</span> <span class="operator">=</span> Startup.create();</span><br><span class="line">    <span class="comment">// 检查properties中是否注册关闭钩子</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isRegisterShutdownHook()) &#123;</span><br><span class="line">        <span class="comment">//启 Shutdown Hook注册机制，保证Spring Boot应用在JVM关闭时能够正确释放资源（如数据库连接池、线程池等）。</span></span><br><span class="line">        SpringApplication.shutdownHook.enableShutdownHookAddition();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建引导上下文</span></span><br><span class="line">    <span class="type">DefaultBootstrapContext</span> <span class="variable">bootstrapContext</span> <span class="operator">=</span> createBootstrapContext();</span><br><span class="line">    <span class="comment">// 创建应用上下文</span></span><br><span class="line">    <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 将环境变量中java.awt.headless设置为原值或者默认true</span></span><br><span class="line">    configureHeadlessProperty();</span><br><span class="line">    <span class="comment">// 用getSpringFactoriesInstances()方法获取了所有类型为</span></span><br><span class="line">    <span class="comment">// SpringApplicationRunListener.class的启动监听类，</span></span><br><span class="line">    <span class="comment">// 将其封装在SpringApplicationRunListeners类中</span></span><br><span class="line">    <span class="type">SpringApplicationRunListeners</span> <span class="variable">listeners</span> <span class="operator">=</span> getRunListeners(args);</span><br><span class="line">    <span class="comment">// 将bootstrapContext传递给所有的启动监听类</span></span><br><span class="line">    listeners.starting(bootstrapContext, <span class="built_in">this</span>.mainApplicationClass);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 解析命令行传入的参数，并封装到ApplicationArguments</span></span><br><span class="line">        <span class="type">ApplicationArguments</span> <span class="variable">applicationArguments</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultApplicationArguments</span>(args);</span><br><span class="line">        <span class="comment">// 准备环境</span></span><br><span class="line">        <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> prepareEnvironment(listeners, bootstrapContext, applicationArguments);</span><br><span class="line">        <span class="comment">// 打印Banner 根据条件 判断打印到log还是console，是使用默认值还是指定banner</span></span><br><span class="line">        <span class="type">Banner</span> <span class="variable">printedBanner</span> <span class="operator">=</span> printBanner(environment);</span><br><span class="line">        <span class="comment">// 根据WebApplicationType创建 应用程序上下文</span></span><br><span class="line">        <span class="comment">// 获取META-INF/spring.factories中的ApplicationContextFactory接口实现类</span></span><br><span class="line">        <span class="comment">// ReactiveWebServerApplicationContextFactory 创建了 ReactiveWebServerApplicationContext</span></span><br><span class="line">        <span class="comment">// ServletWebServerApplicationContextFactory 创建了 ServletWebServerApplicationContext</span></span><br><span class="line">        context = createApplicationContext();</span><br><span class="line">        <span class="comment">// 将applicationStartup赋值给context</span></span><br><span class="line">        <span class="comment">// applicationStartup 用于收集和分析应用的启动性能数据，帮助开发者优化 Spring Boot 启动过程</span></span><br><span class="line">        context.setApplicationStartup(<span class="built_in">this</span>.applicationStartup);</span><br><span class="line">        <span class="comment">// 准备 应用程序上下文</span></span><br><span class="line">        <span class="comment">// 将参数绑定到应用程序上下文（ApplicationContext）为应用程序启动运行做好准备</span></span><br><span class="line">        prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">        <span class="comment">// 启动 应用上下文 （SpringBoot核心启动方法）</span></span><br><span class="line">        refreshContext(context);</span><br><span class="line">        <span class="comment">// 刷新之后需要的处理，默认是空</span></span><br><span class="line">        afterRefresh(context, applicationArguments);</span><br><span class="line">        <span class="comment">//SpringBoot启动</span></span><br><span class="line">        startup.started();</span><br><span class="line">        <span class="comment">//日志	</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isLogStartupInfo()) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">StartupInfoLogger</span>(<span class="built_in">this</span>.mainApplicationClass, environment).logStarted(getApplicationLog(), startup);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将ConfigurableApplicationContext传递给所有的启动监听类，表明started</span></span><br><span class="line">        listeners.started(context, startup.timeTakenToStarted());</span><br><span class="line">        callRunners(context, applicationArguments);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> handleRunFailure(context, ex, listeners);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (context.isRunning()) &#123;</span><br><span class="line">            listeners.ready(context, startup.ready());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> handleRunFailure(context, ex, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建引导程序上下文createBootstrapContext"><a href="#创建引导程序上下文createBootstrapContext" class="headerlink" title="创建引导程序上下文createBootstrapContext()"></a>创建引导程序上下文<code>createBootstrapContext()</code></h2><p>引导程序上下文的作用：<strong>在 <code>SpringApplication</code> 启动过程中，提前注册某些组件，以便在应用上下文（<code>ApplicationContext</code>）正式创建时使用</strong>。</p>
<p><code>DefaultBootstrapContext</code> 存在的时间非常短，它只在 <code>SpringApplication.run()</code> 方法执行的早期阶段存在，等 <code>ApplicationContext</code> 初始化完成后，它就会被丢弃。</p>
<p>引导上下文主要用于支持 <strong>Spring Cloud</strong> 的配置加载机制（例如 Spring Cloud Config）。它并不是 Spring Boot 核心的一部分，而是 Spring Cloud 提供的高级功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DefaultBootstrapContext</span> <span class="variable">bootstrapContext</span> <span class="operator">=</span> createBootstrapContext();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> DefaultBootstrapContext <span class="title function_">createBootstrapContext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 创建引导上下文</span></span><br><span class="line">    <span class="type">DefaultBootstrapContext</span> <span class="variable">bootstrapContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultBootstrapContext</span>();</span><br><span class="line">    <span class="comment">// 构造函数中已经将BootstrapRegistryInitializer类型的初始化类型数组赋值给了this.bootstrapRegistryInitializers</span></span><br><span class="line">    <span class="comment">// 遍历初始化类型数组，并执行每一个初始化类型的initialize方法，将引导上下文DefaultBootstrapContext赋值给它</span></span><br><span class="line">    <span class="built_in">this</span>.bootstrapRegistryInitializers.forEach((initializer) -&gt; initializer.initialize(bootstrapContext));</span><br><span class="line">    <span class="keyword">return</span> bootstrapContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="监听类SpringApplicationRunListeners"><a href="#监听类SpringApplicationRunListeners" class="headerlink" title="监听类SpringApplicationRunListeners"></a>监听类<code>SpringApplicationRunListeners</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SpringApplicationRunListeners <span class="title function_">getRunListeners</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ArgumentResolver</span> <span class="variable">argumentResolver</span> <span class="operator">=</span> ArgumentResolver.of(SpringApplication.class, <span class="built_in">this</span>);</span><br><span class="line">    argumentResolver = argumentResolver.and(String[].class, args);</span><br><span class="line">    <span class="comment">// 通过getSpringFactoriesInstances()获取所有接口为SpringApplicationRunListener.class的实现类</span></span><br><span class="line">    List&lt;SpringApplicationRunListener&gt; listeners = getSpringFactoriesInstances(SpringApplicationRunListener.class,</span><br><span class="line">            argumentResolver);</span><br><span class="line">    <span class="type">SpringApplicationHook</span> <span class="variable">hook</span> <span class="operator">=</span> applicationHook.get();</span><br><span class="line">    <span class="type">SpringApplicationRunListener</span> <span class="variable">hookListener</span> <span class="operator">=</span> (hook != <span class="literal">null</span>) ? hook.getRunListener(<span class="built_in">this</span>) : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (hookListener != <span class="literal">null</span>) &#123;</span><br><span class="line">        listeners = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(listeners);</span><br><span class="line">        listeners.add(hookListener);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将监听类List和applicationStartup传递給SpringApplicationRunListeners</span></span><br><span class="line">    <span class="comment">// 其中this.applicationStartup是一个性能分析工具，默认状态下，它什么都没做，是一个空实现。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringApplicationRunListeners</span>(logger, listeners, <span class="built_in">this</span>.applicationStartup);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如<code>starting()</code>方法赋值监听名称为<code>&quot;spring.boot.application.starting&quot;</code>并将bootstrapContext通过<code>listener.starting()</code>赋值给每一个监听类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SpringApplicationRunListeners</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Log log;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;SpringApplicationRunListener&gt; listeners;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ApplicationStartup applicationStartup;</span><br><span class="line"></span><br><span class="line">	SpringApplicationRunListeners(Log log, List&lt;SpringApplicationRunListener&gt; listeners,</span><br><span class="line">			ApplicationStartup applicationStartup) &#123;</span><br><span class="line">		<span class="built_in">this</span>.log = log;</span><br><span class="line">		<span class="built_in">this</span>.listeners = List.copyOf(listeners);</span><br><span class="line">		<span class="built_in">this</span>.applicationStartup = applicationStartup;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">starting</span><span class="params">(ConfigurableBootstrapContext bootstrapContext, Class&lt;?&gt; mainApplicationClass)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.starting&quot;</span>, (listener) -&gt; listener.starting(bootstrapContext),</span><br><span class="line">				(step) -&gt; &#123;</span><br><span class="line">					<span class="keyword">if</span> (mainApplicationClass != <span class="literal">null</span>) &#123;</span><br><span class="line">						step.tag(<span class="string">&quot;mainApplicationClass&quot;</span>, mainApplicationClass.getName());</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">environmentPrepared</span><span class="params">(ConfigurableBootstrapContext bootstrapContext, ConfigurableEnvironment environment)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.environment-prepared&quot;</span>,</span><br><span class="line">				(listener) -&gt; listener.environmentPrepared(bootstrapContext, environment));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">contextPrepared</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.context-prepared&quot;</span>, (listener) -&gt; listener.contextPrepared(context));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">contextLoaded</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.context-loaded&quot;</span>, (listener) -&gt; listener.contextLoaded(context));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">started</span><span class="params">(ConfigurableApplicationContext context, Duration timeTaken)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.started&quot;</span>, (listener) -&gt; listener.started(context, timeTaken));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">ready</span><span class="params">(ConfigurableApplicationContext context, Duration timeTaken)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.ready&quot;</span>, (listener) -&gt; listener.ready(context, timeTaken));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(ConfigurableApplicationContext context, Throwable exception)</span> &#123;</span><br><span class="line">		doWithListeners(<span class="string">&quot;spring.boot.application.failed&quot;</span>,</span><br><span class="line">				(listener) -&gt; callFailedListener(listener, context, exception), (step) -&gt; &#123;</span><br><span class="line">					step.tag(<span class="string">&quot;exception&quot;</span>, exception.getClass().toString());</span><br><span class="line">					step.tag(<span class="string">&quot;message&quot;</span>, exception.getMessage());</span><br><span class="line">				&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">callFailedListener</span><span class="params">(SpringApplicationRunListener listener, ConfigurableApplicationContext context,</span></span><br><span class="line"><span class="params">			Throwable exception)</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			listener.failed(context, exception);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">			<span class="keyword">if</span> (exception == <span class="literal">null</span>) &#123;</span><br><span class="line">				ReflectionUtils.rethrowRuntimeException(ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.log.isDebugEnabled()) &#123;</span><br><span class="line">				<span class="built_in">this</span>.log.error(<span class="string">&quot;Error handling failed&quot;</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> ex.getMessage();</span><br><span class="line">				message = (message != <span class="literal">null</span>) ? message : <span class="string">&quot;no error message&quot;</span>;</span><br><span class="line">				<span class="built_in">this</span>.log.warn(<span class="string">&quot;Error handling failed (&quot;</span> + message + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doWithListeners</span><span class="params">(String stepName, Consumer&lt;SpringApplicationRunListener&gt; listenerAction)</span> &#123;</span><br><span class="line">		doWithListeners(stepName, listenerAction, <span class="literal">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//每一个方法都调用了doWithListeners()</span></span><br><span class="line">    <span class="comment">//参数1：步骤名称</span></span><br><span class="line">    <span class="comment">//参数2：消费型函数式接口，它可以接收一个 SpringApplicationRunListener 对象，并对其执行某些操作。</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doWithListeners</span><span class="params">(String stepName, Consumer&lt;SpringApplicationRunListener&gt; listenerAction,</span></span><br><span class="line"><span class="params">			Consumer&lt;StartupStep&gt; stepAction)</span> &#123;</span><br><span class="line">        <span class="comment">// 性能监听，默认是空函数</span></span><br><span class="line">		<span class="type">StartupStep</span> <span class="variable">step</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(stepName);</span><br><span class="line">        <span class="comment">// listeners是SpringApplicationRunListener对象的List</span></span><br><span class="line">        <span class="comment">// 对listeners中的每一个SpringApplicationRunListener对象执行listenerAction方法。</span></span><br><span class="line">		<span class="built_in">this</span>.listeners.forEach(listenerAction);</span><br><span class="line">		<span class="keyword">if</span> (stepAction != <span class="literal">null</span>) &#123;</span><br><span class="line">			stepAction.accept(step);</span><br><span class="line">		&#125;</span><br><span class="line">		step.end();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="准备环境-prepareEnvironment"><a href="#准备环境-prepareEnvironment" class="headerlink" title="准备环境 prepareEnvironment()"></a>准备环境 <code>prepareEnvironment()</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ConfigurableEnvironment <span class="title function_">prepareEnvironment</span><span class="params">(SpringApplicationRunListeners listeners,</span></span><br><span class="line"><span class="params">        DefaultBootstrapContext bootstrapContext, ApplicationArguments applicationArguments)</span> &#123;</span><br><span class="line">    <span class="comment">// Create and configure the environment</span></span><br><span class="line">    <span class="comment">// 根据应用类型创建对应的环境类</span></span><br><span class="line">    <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> getOrCreateEnvironment();</span><br><span class="line">    <span class="comment">// 将命令行的参数添加到Springboot环境变量中</span></span><br><span class="line">    <span class="comment">// 配置spring.profiles.active</span></span><br><span class="line">    configureEnvironment(environment, applicationArguments.getSourceArgs());</span><br><span class="line">    <span class="comment">// 将 ConfigurationPropertySources 附加到 Environment，让 Spring Environment 识别 ConfigurationPropertySource</span></span><br><span class="line">    ConfigurationPropertySources.attach(environment);</span><br><span class="line">    <span class="comment">// 告诉所有的监听类，环境准备阶段</span></span><br><span class="line">    listeners.environmentPrepared(bootstrapContext, environment);</span><br><span class="line">    ApplicationInfoPropertySource.moveToEnd(environment);</span><br><span class="line">    DefaultPropertiesPropertySource.moveToEnd(environment);</span><br><span class="line">    Assert.state(!environment.containsProperty(<span class="string">&quot;spring.main.environment-prefix&quot;</span>),</span><br><span class="line">            <span class="string">&quot;Environment prefix cannot be set via properties.&quot;</span>);</span><br><span class="line">    bindToSpringApplication(environment);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.isCustomEnvironment) &#123;</span><br><span class="line">        <span class="type">EnvironmentConverter</span> <span class="variable">environmentConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EnvironmentConverter</span>(getClassLoader());</span><br><span class="line">        environment = environmentConverter.convertEnvironmentIfNecessary(environment, deduceEnvironmentClass());</span><br><span class="line">    &#125;</span><br><span class="line">    ConfigurationPropertySources.attach(environment);</span><br><span class="line">    <span class="keyword">return</span> environment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ConfigurableEnvironment <span class="title function_">getOrCreateEnvironment</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.environment != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.environment;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在构造函数中已经赋值，此时拿出webapplication的类型</span></span><br><span class="line">    <span class="type">WebApplicationType</span> <span class="variable">webApplicationType</span> <span class="operator">=</span> <span class="built_in">this</span>.properties.getWebApplicationType();</span><br><span class="line">    <span class="comment">// 根据不同的webapplication类型创建不同的ConfigurableEnvironment</span></span><br><span class="line">    <span class="comment">// DefaultApplicationContextFactory</span></span><br><span class="line">    <span class="comment">// ServletWebServerApplicationContextFactory</span></span><br><span class="line">    <span class="comment">// ReactiveWebServerApplicationContextFactory</span></span><br><span class="line">    <span class="comment">// 会从META/spring.factories中获取ApplicationContextFactory并根据webApplicationType选取对应的类</span></span><br><span class="line">    <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationContextFactory.createEnvironment(webApplicationType);</span><br><span class="line">    <span class="keyword">if</span> (environment == <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.applicationContextFactory != ApplicationContextFactory.DEFAULT) &#123;</span><br><span class="line">        environment = ApplicationContextFactory.DEFAULT.createEnvironment(webApplicationType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (environment != <span class="literal">null</span>) ? environment : <span class="keyword">new</span> <span class="title class_">ApplicationEnvironment</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="准备应用上下文-prepareContext"><a href="#准备应用上下文-prepareContext" class="headerlink" title="准备应用上下文 prepareContext()"></a>准备应用上下文 <code>prepareContext()</code></h2><p>将参数绑定到应用程序上下文（ApplicationContext），为应用程序启动运行做好准备。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">prepareContext</span><span class="params">(DefaultBootstrapContext bootstrapContext, ConfigurableApplicationContext context,</span></span><br><span class="line"><span class="params">        ConfigurableEnvironment environment, SpringApplicationRunListeners listeners,</span></span><br><span class="line"><span class="params">        ApplicationArguments applicationArguments, Banner printedBanner)</span> &#123;</span><br><span class="line">    <span class="comment">// environment赋值给context</span></span><br><span class="line">    context.setEnvironment(environment);</span><br><span class="line">    postProcessApplicationContext(context);</span><br><span class="line">    addAotGeneratedInitializerIfNecessary(<span class="built_in">this</span>.initializers);</span><br><span class="line">    applyInitializers(context);</span><br><span class="line">    <span class="comment">//触发所有SpringApplicationRunListerner监听器的contextPrepared</span></span><br><span class="line">    listeners.contextPrepared(context);</span><br><span class="line">    <span class="comment">// 发送事件 当 bootstrapContext关闭且ApplicationContext准备好后发送该事件</span></span><br><span class="line">    bootstrapContext.close(context);</span><br><span class="line">    <span class="comment">//日志处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isLogStartupInfo()) &#123;</span><br><span class="line">        logStartupInfo(context.getParent() == <span class="literal">null</span>);</span><br><span class="line">        logStartupInfo(context);</span><br><span class="line">        logStartupProfileInfo(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Add boot specific singleton beans</span></span><br><span class="line">    <span class="comment">// 通过 应用上下文 获取BeanFactory</span></span><br><span class="line">    <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> context.getBeanFactory();</span><br><span class="line">    <span class="comment">// 通过 BeanFactory 注册单例对象 springApplicationArguments</span></span><br><span class="line">    beanFactory.registerSingleton(<span class="string">&quot;springApplicationArguments&quot;</span>, applicationArguments);</span><br><span class="line">    <span class="keyword">if</span> (printedBanner != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 通过 BeanFactory 注册单例对象 springBootBanner</span></span><br><span class="line">        beanFactory.registerSingleton(<span class="string">&quot;springBootBanner&quot;</span>, printedBanner);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> AbstractAutowireCapableBeanFactory autowireCapableBeanFactory) &#123;</span><br><span class="line">        autowireCapableBeanFactory.setAllowCircularReferences(<span class="built_in">this</span>.properties.isAllowCircularReferences());</span><br><span class="line">        <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> DefaultListableBeanFactory listableBeanFactory) &#123;</span><br><span class="line">            listableBeanFactory.setAllowBeanDefinitionOverriding(<span class="built_in">this</span>.properties.isAllowBeanDefinitionOverriding());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 懒加载 给应用上下文添加懒加载BeanFactory处理类</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isLazyInitialization()) &#123;</span><br><span class="line">        context.addBeanFactoryPostProcessor(<span class="keyword">new</span> <span class="title class_">LazyInitializationBeanFactoryPostProcessor</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isKeepAlive()) &#123;</span><br><span class="line">        context.addApplicationListener(<span class="keyword">new</span> <span class="title class_">KeepAlive</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    context.addBeanFactoryPostProcessor(<span class="keyword">new</span> <span class="title class_">PropertySourceOrderingBeanFactoryPostProcessor</span>(context));</span><br><span class="line">    <span class="keyword">if</span> (!AotDetector.useGeneratedArtifacts()) &#123;</span><br><span class="line">        <span class="comment">// Load the sources</span></span><br><span class="line">        Set&lt;Object&gt; sources = getAllSources();</span><br><span class="line">        Assert.notEmpty(sources, <span class="string">&quot;Sources must not be empty&quot;</span>);</span><br><span class="line">        load(context, sources.toArray(<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//触发所有SpringApplicationRunListerner监听器的contextLoaded</span></span><br><span class="line">    listeners.contextLoaded(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="启动应用上下文refreshContext"><a href="#启动应用上下文refreshContext" class="headerlink" title="启动应用上下文refreshContext()"></a>启动应用上下文<code>refreshContext()</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshContext</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.properties.isRegisterShutdownHook()) &#123;</span><br><span class="line">        shutdownHook.registerApplicationContext(context);</span><br><span class="line">    &#125;</span><br><span class="line">    refresh(context);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">(ConfigurableApplicationContext applicationContext)</span> &#123;</span><br><span class="line">    applicationContext.refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>applicationContext</code>有两种类：</p>
<ul>
<li><p><code>ReactiveWebServerApplicationContext</code></p>
</li>
<li><p><code>ServletWebServerApplicationContext</code></p>
</li>
</ul>
<p>他们的共同抽象父类<code>AbstractApplicationContext</code>，主要的refresh()方法也是在这个抽象父类中定义的。</p>
<p><code>refresh()</code> 是 Spring 容器启动的核心方法，负责加载 Bean、初始化 BeanFactory、注册监听器、完成 Bean 初始化，并最终发布 <code>ContextRefreshedEvent</code> 事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">    <span class="built_in">this</span>.startupShutdownLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.startupShutdownThread = Thread.currentThread();</span><br><span class="line"></span><br><span class="line">        <span class="type">StartupStep</span> <span class="variable">contextRefresh</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.refresh&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">        <span class="comment">// 检查SpringBoot中的环境变量</span></span><br><span class="line">        prepareRefresh();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line">        <span class="comment">// 从子类中获取beanfactory，默认是ConfigurableListableBeanFactory</span></span><br><span class="line">        <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">        <span class="comment">//为 ConfigurableListableBeanFactory配置一些基础设置和功能，以确保它能够正确地创建和管理 Bean</span></span><br><span class="line">        prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">            <span class="comment">// 允许子类对beanFactory中的bean在初始化之前修改bean</span></span><br><span class="line">            postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="type">StartupStep</span> <span class="variable">beanPostProcess</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.beans.post-process&quot;</span>);</span><br><span class="line">            <span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">            <span class="comment">// 处理注解的主要方法</span></span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line">            <span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">            <span class="comment">// 注册BeanPostProcessors的bean类</span></span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line">            beanPostProcess.end();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize message source for this context.</span></span><br><span class="line">            <span class="comment">// 添加消息bean</span></span><br><span class="line">            initMessageSource();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">            <span class="comment">// 添加事件传播bean</span></span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">            <span class="comment">// 处理子类的刷新，如Servlet的启动Tomcat</span></span><br><span class="line">            onRefresh();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">            <span class="comment">// 注册监听bean</span></span><br><span class="line">            registerListeners();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">            <span class="comment">// 初始化所有的 单例bean</span></span><br><span class="line">            <span class="comment">// 并将bean锁住</span></span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">            finishRefresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">catch</span> (RuntimeException | Error ex ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">            destroyBeans();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">            cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Propagate exception to caller.</span></span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            contextRefresh.end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.startupShutdownThread = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.startupShutdownLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">    <span class="comment">// Tell the internal bean factory to use the context&#x27;s class loader etc.</span></span><br><span class="line">    <span class="comment">// 为 BeanFactory 设置当前的类加载器,以便在加载 Bean 定义时使用</span></span><br><span class="line">    beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line">    <span class="comment">// 用于支持 Spring 表达式语言（SpEL），例如在 @Value 注解中解析表达式。</span></span><br><span class="line">    beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> <span class="title class_">StandardBeanExpressionResolver</span>(beanFactory.getBeanClassLoader()));</span><br><span class="line">    <span class="comment">// 用于处理资源（如 Resource 类型）的注入和解析</span></span><br><span class="line">    beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> <span class="title class_">ResourceEditorRegistrar</span>(<span class="built_in">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Configure the bean factory with context callbacks.</span></span><br><span class="line">    <span class="comment">// 实现了 ApplicationContextAware 接口的 Bean 能够感知到当前的 ApplicationContext</span></span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationContextAwareProcessor</span>(<span class="built_in">this</span>));</span><br><span class="line">    <span class="comment">// 配置 BeanFactory 忽略一些特定的 Aware 接口的依赖自动注入,因为这些接口的实现通常由 Spring 框架自动处理。</span></span><br><span class="line">    beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationStartupAware.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// BeanFactory interface not registered as resolvable type in a plain factory.</span></span><br><span class="line">    <span class="comment">// MessageSource registered (and found for autowiring) as a bean.</span></span><br><span class="line">    <span class="comment">// 为一些常见的类型注册默认的单例 Bean, 可以通过依赖注入直接获取对应的实例</span></span><br><span class="line">    beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">    beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="built_in">this</span>);</span><br><span class="line">    beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="built_in">this</span>);</span><br><span class="line">    beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register early post-processor for detecting inner beans as ApplicationListeners.</span></span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationListenerDetector</span>(<span class="built_in">this</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Detect a LoadTimeWeaver and prepare for weaving, if found.</span></span><br><span class="line">    <span class="keyword">if</span> (!NativeDetector.inNativeImage() &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">LoadTimeWeaverAwareProcessor</span>(beanFactory));</span><br><span class="line">        <span class="comment">// Set a temporary ClassLoader for type matching.</span></span><br><span class="line">        beanFactory.setTempClassLoader(<span class="keyword">new</span> <span class="title class_">ContextTypeMatchClassLoader</span>(beanFactory.getBeanClassLoader()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register default environment beans.</span></span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(APPLICATION_STARTUP_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(APPLICATION_STARTUP_BEAN_NAME, getApplicationStartup());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Bean扫描注册invokeBeanFactoryPostProcessors"><a href="#Bean扫描注册invokeBeanFactoryPostProcessors" class="headerlink" title="Bean扫描注册invokeBeanFactoryPostProcessors()"></a>Bean扫描注册<code>invokeBeanFactoryPostProcessors()</code></h2><p>通过<code>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</code>按优先级调用所有注册的 <code>BeanFactoryPostProcessor</code> 和 <code>BeanDefinitionRegistryPostProcessor</code>，完成对 Bean 定义的修改。</p>
<p>该方法主要完成BeanDefinition的扫描、解析、注册：</p>
<p>1.实例化实现了BeanDefinitionRegistryPostProcessor接口的Bean</p>
<p>2.调用实现了BeanDefinitionRegistryPostProcessor的postProcessBeanDefinitionRegistry()方法</p>
<p>3.实例化实现了BeanFactoryPostProcessor接口的Bean</p>
<p>4.调用实现了BeanFactoryPostProcessor的postProcessBeanFactory()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeBeanFactoryPostProcessors</span><span class="params">(</span></span><br><span class="line"><span class="params">        ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// WARNING: Although it may appear that the body of this method can be easily</span></span><br><span class="line">    <span class="comment">// refactored to avoid the use of multiple loops and multiple lists, the use</span></span><br><span class="line">    <span class="comment">// of multiple lists and multiple passes over the names of processors is</span></span><br><span class="line">    <span class="comment">// intentional. We must ensure that we honor the contracts for PriorityOrdered</span></span><br><span class="line">    <span class="comment">// and Ordered processors. Specifically, we must NOT cause processors to be</span></span><br><span class="line">    <span class="comment">// instantiated (via getBean() invocations) or registered in the ApplicationContext</span></span><br><span class="line">    <span class="comment">// in the wrong order.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Before submitting a pull request (PR) to change this method, please review the</span></span><br><span class="line">    <span class="comment">// list of all declined PRs involving changes to PostProcessorRegistrationDelegate</span></span><br><span class="line">    <span class="comment">// to ensure that your proposal does not result in a breaking change:</span></span><br><span class="line">    <span class="comment">// https://github.com/spring-projects/spring-framework/issues?q=PostProcessorRegistrationDelegate+is%3Aclosed+label%3A%22status%3A+declined%22</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span></span><br><span class="line">    Set&lt;String&gt; processedBeans = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> BeanDefinitionRegistry registry) &#123;</span><br><span class="line">        List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;</span><br><span class="line">            <span class="keyword">if</span> (postProcessor <span class="keyword">instanceof</span> BeanDefinitionRegistryPostProcessor registryProcessor) &#123;</span><br><span class="line">                registryProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">                registryProcessors.add(registryProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                regularPostProcessors.add(postProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">        <span class="comment">// uninitialized to let the bean factory post-processors apply to them!</span></span><br><span class="line">        <span class="comment">// Separate between BeanDefinitionRegistryPostProcessors that implement</span></span><br><span class="line">        <span class="comment">// PriorityOrdered, Ordered, and the rest.</span></span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">        String[] postProcessorNames =</span><br><span class="line">                beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">        registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">        currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span></span><br><span class="line">        postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">        registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">        currentRegistryProcessors.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">reiterate</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (reiterate) &#123;</span><br><span class="line">            reiterate = <span class="literal">false</span>;</span><br><span class="line">            postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!processedBeans.contains(ppName)) &#123;</span><br><span class="line">                    currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                    processedBeans.add(ppName);</span><br><span class="line">                    reiterate = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sortPostProcessors(currentRegistryProcessors, beanFactory);</span><br><span class="line">            registryProcessors.addAll(currentRegistryProcessors);</span><br><span class="line">            invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</span><br><span class="line">            currentRegistryProcessors.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</span><br><span class="line">        invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Invoke factory processors registered with the context instance.</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">    <span class="comment">// uninitialized to let the bean factory post-processors apply to them!</span></span><br><span class="line">    String[] postProcessorNames =</span><br><span class="line">            beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span></span><br><span class="line">    <span class="comment">// Ordered, and the rest.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; orderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; nonOrderedPostProcessorNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String ppName : postProcessorNames) &#123;</span><br><span class="line">        <span class="keyword">if</span> (processedBeans.contains(ppName)) &#123;</span><br><span class="line">            <span class="comment">// skip - already processed in first phase above</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">            priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            orderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span></span><br><span class="line">    sortPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;</span><br><span class="line">        orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    sortPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line">    invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Finally, invoke all other BeanFactoryPostProcessors.</span></span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());</span><br><span class="line">    <span class="keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">        nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clear cached merged bean definitions since the post-processors might have</span></span><br><span class="line">    <span class="comment">// modified the original metadata, for example, replacing placeholders in values...</span></span><br><span class="line">    beanFactory.clearMetadataCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="注解处理"><a href="#注解处理" class="headerlink" title="注解处理"></a>注解处理</h1><p> <code>prepareBeanFactory</code> 阶段，Spring 会为 BeanFactory 添加一些默认的处理器，这些处理器会影响后续注解的处理。例如：</p>
<ul>
<li><p>添加 <code>ApplicationContextAwareProcessor</code>，用于处理 Aware 接口（如 ApplicationContextAware）。</p>
</li>
<li><p>添加 <code>BeanNameAware</code> 和 <code>BeanFactoryAware</code> 的支持。</p>
</li>
</ul>
<p><code>invokeBeanFactoryPostProcessors</code> 阶段的核心处理器是 <code>ConfigurationClassPostProcessor</code>，它实现了 <code>BeanFactoryPostProcessor</code> 接口，负责解析配置类及其相关注解。它的执行逻辑包括：</p>
<ul>
<li>解析主配置类（例如带有 <code>@SpringBootApplication</code> 的类）。</li>
<li>处理 <code>@ComponentScan</code>，扫描并注册组件。</li>
<li>处理 <code>@Import</code>，加载导入的配置类或执行 ImportSelector&#x2F;ImportBeanDefinitionRegistrar。</li>
<li>处理 <code>@Bean</code>，将配置类中的 @Bean 方法注册为 Bean 定义。</li>
</ul>
<p><code>registerBeanPostProcessors</code> 阶段，Spring 会注册所有 <code>BeanPostProcessor</code>，这些处理器负责处理与 Bean 初始化和生命周期相关的注解。典型注解包括：</p>
<ul>
<li><strong><code>@Autowired</code></strong> 和 <strong>@Inject</strong>：由 <code>AutowiredAnnotationBeanPostProcessor</code> 处理，用于依赖注入。</li>
<li><code>@Value</code>：由 <code>AutowiredAnnotationBeanPostProcessor</code> 处理，用于属性值注入。</li>
<li><strong><code>@PostConstruct</code></strong> 和 <strong>@PreDestroy</strong>：由 <code>CommonAnnotationBeanPostProcessor</code> 处理，用于生命周期回调。</li>
<li>**<code>@Resource</code>**：由 <code>CommonAnnotationBeanPostProcessor</code> 处理，用于 JSR-250 注解的依赖注入。</li>
</ul>
<p><code>finishBeanFactoryInitialization</code> 阶段，Spring 会实例化所有单例 Bean，并触发 BeanPostProcessor 的处理逻辑。这一阶段会实际执行依赖注入、初始化回调等操作。典型注解包括：</p>
<ul>
<li>**<code>@Autowired</code>**：注入依赖。</li>
<li>**<code>@PostConstruct</code>**：执行初始化方法。</li>
<li>**<code>@EventListener</code>**：由 EventListenerMethodProcessor 处理，注册事件监听器。</li>
</ul>
<p>Spring Boot 还扩展了许多自定义注解，这些注解的处理逻辑分布在不同的阶段。例如：</p>
<ul>
<li><strong><code>@ConditionalOnClass</code>,<code>@ConditionalOnMissingBean</code> 等条件注解</strong>：由 ConditionEvaluator 在 <code>invokeBeanFactoryPostProcessors</code> 阶段处理，用于决定是否加载某些配置类或 Bean。</li>
<li>**<code>@SpringBootApplication</code>**：由 <code>ConfigurationClassPostProcessor</code> 在 <code>invokeBeanFactoryPostProcessors</code> 阶段处理，分解为 <code>@Configuration</code> <code>@ComponentScan</code> 和 <code>@EnableAutoConfiguration</code>。</li>
<li><strong><code>@RestController</code></strong> 和 **<code>@RequestMapping</code>**：由 Spring MVC 相关的 BeanPostProcessor（如 RequestMappingHandlerMapping）在 <code>finishBeanFactoryInitialization</code> 阶段处理，用于注册控制器和映射请求路径。</li>
</ul>
<table>
<thead>
<tr>
<th>注解类型</th>
<th>处理阶段</th>
<th>核心处理器</th>
</tr>
</thead>
<tbody><tr>
<td>@Configuration</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>ConfigurationClassPostProcessor</td>
</tr>
<tr>
<td>@ComponentScan</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>ConfigurationClassPostProcessor</td>
</tr>
<tr>
<td>@Import</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>ConfigurationClassPostProcessor</td>
</tr>
<tr>
<td>@EnableAutoConfiguration</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>AutoConfigurationImportSelector</td>
</tr>
<tr>
<td>@ConditionalOnClass 等</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>ConditionEvaluator</td>
</tr>
<tr>
<td>@Bean</td>
<td>invokeBeanFactoryPostProcessors</td>
<td>ConfigurationClassPostProcessor</td>
</tr>
<tr>
<td>@Autowired</td>
<td>registerBeanPostProcessors &#x2F; finishBeanFactoryInitialization</td>
<td>AutowiredAnnotationBeanPostProcessor</td>
</tr>
<tr>
<td>@Value</td>
<td>registerBeanPostProcessors &#x2F; finishBeanFactoryInitialization</td>
<td>AutowiredAnnotationBeanPostProcessor</td>
</tr>
<tr>
<td>@PostConstruct</td>
<td>registerBeanPostProcessors &#x2F; finishBeanFactoryInitialization</td>
<td>CommonAnnotationBeanPostProcessor</td>
</tr>
<tr>
<td>@EventListener</td>
<td>finishBeanFactoryInitialization</td>
<td>EventListenerMethodProcessor</td>
</tr>
<tr>
<td>@RestController</td>
<td>finishBeanFactoryInitialization</td>
<td>RequestMappingHandlerMapping</td>
</tr>
<tr>
<td>@RequestMapping</td>
<td>finishBeanFactoryInitialization</td>
<td>RequestMappingHandlerMapping</td>
</tr>
</tbody></table>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/03/03/cf/%E5%8F%8C%E6%8C%87%E9%92%88/" rel="prev" title="双指针">
                  <i class="fa fa-angle-left"></i> 双指针
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/03/11/springboot/SpringBoot%20bean%E5%8A%A0%E8%BD%BD/" rel="next" title="SpringBoot Bean加载">
                  SpringBoot Bean加载 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">YingZheng</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/caohongchuan" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"caohongchuan","repo":"caohongchuan.github.io","client_id":"967bc44f66d40841715d","client_secret":"8d7caaf8d49e847e9da60bfab064fc2acad2b66d","admin_user":"caohongchuan","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"en | zh-CN","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"dd87d269ba30a040274496f2c499aa5d"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
